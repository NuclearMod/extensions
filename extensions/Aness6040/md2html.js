(async function (Scratch) {
    'use strict';

    const icon = "data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz48IS0tIFVwbG9hZGVkIHRvOiBTVkcgUmVwbywgd3d3LnN2Z3JlcG8uY29tLCBHZW5lcmF0b3I6IFNWRyBSZXBvIE1peGVyIFRvb2xzIC0tPgo8c3ZnIGZpbGw9IiMwMDAwMDAiIHdpZHRoPSI4MDBweCIgaGVpZ2h0PSI4MDBweCIgdmlld0JveD0iMCAwIDI0IDI0IiByb2xlPSJpbWciIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHRpdGxlPk1hcmtkb3duIGljb248L3RpdGxlPjxwYXRoIGQ9Ik0yMi4yNjkgMTkuMzg1SDEuNzMxYTEuNzMgMS43MyAwIDAgMS0xLjczLTEuNzNWNi4zNDVhMS43MyAxLjczIDAgMCAxIDEuNzMtMS43M2gyMC41MzhhMS43MyAxLjczIDAgMCAxIDEuNzMgMS43M3YxMS4zMDhhMS43MyAxLjczIDAgMCAxLTEuNzMgMS43MzF6bS0xNi41LTMuNDYydi00LjVsMi4zMDggMi44ODUgMi4zMDctMi44ODV2NC41aDIuMzA4VjguMDc4aC0yLjMwOGwtMi4zMDcgMi44ODUtMi4zMDgtMi44ODVIMy40NjF2Ny44NDd6TTIxLjIzMSAxMmgtMi4zMDhWOC4wNzdoLTIuMzA3VjEyaC0yLjMwOGwzLjQ2MSA0LjAzOXoiLz48L3N2Zz4=";
    
    const menuIcon = "data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHdpZHRoPSIzMjcuMzI3MzMiIGhlaWdodD0iMzAxLjgwMTgiIHZpZXdCb3g9IjAsMCwzMjcuMzI3MzMsMzAxLjgwMTgiPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKC03Ni4zMzYzNCwtMjkuMDk5MSkiPjxnIGRhdGEtcGFwZXItZGF0YT0ieyZxdW90O2lzUGFpbnRpbmdMYXllciZxdW90Ozp0cnVlfSIgZmlsbC1ydWxlPSJub256ZXJvIiBzdHJva2UtbGluZWNhcD0iYnV0dCIgc3Ryb2tlLWxpbmVqb2luPSJtaXRlciIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBzdHJva2UtZGFzaGFycmF5PSIiIHN0cm9rZS1kYXNob2Zmc2V0PSIwIiBzdHlsZT0ibWl4LWJsZW5kLW1vZGU6IG5vcm1hbCI+PHBhdGggZD0iTTc2LjMzNjM0LDMzMC45MDA5di0zMDEuODAxOGgzMjcuMzI3MzN2MzAxLjgwMTh6IiBmaWxsPSJub25lIiBzdHJva2U9Im5vbmUiIHN0cm9rZS13aWR0aD0ibm9uZSIvPjxnPjxwYXRoIGQ9Ik0xNDkuMjg4MzEsMjQ1LjIzNTc0Yy04LjQ0MDAzLDAgLTE1LjI4MjAzLC02Ljg0MiAtMTUuMjgyMDMsLTE1LjI4MjA0di05OS45MDc0YzAsLTguNDQwMDMgNi44NDIsLTE1LjI4MjA0IDE1LjI4MjAzLC0xNS4yODIwNGgxODEuNDIzMzdjOC40NDAwNCwwIDE1LjI4MjA0LDYuODQyIDE1LjI4MjA0LDE1LjI4MjA0djk5Ljg4OTc0YzAuMDAyMzQsNC4wNTQ1OCAtMS42MDY2OSw3Ljk0Mzg5IC00LjQ3Mjg4LDEwLjgxMTc0Yy0yLjg2NjE5LDIuODY3ODUgLTYuNzU0NTcsNC40NzkxMyAtMTAuODA5MTUsNC40NzkxM3oiIGZpbGw9IiNmZmZmZmYiIHN0cm9rZT0iI2ZmZmZmZiIgc3Ryb2tlLXdpZHRoPSIyMCIvPjxwYXRoIGQ9Ik0zMzAuNzExNjgsMjQ1LjIzNTc0aC0xODEuNDIzMzZjLTguNDQwMDMsMCAtMTUuMjgyMDMsLTYuODQyIC0xNS4yODIwMywtMTUuMjgyMDR2LTk5LjkwNzRjMCwtOC40NDAwMyA2Ljg0MiwtMTUuMjgyMDQgMTUuMjgyMDMsLTE1LjI4MjA0aDE4MS40MjMzN2M4LjQ0MDA0LDAgMTUuMjgyMDQsNi44NDIgMTUuMjgyMDQsMTUuMjgyMDR2OTkuODg5NzRjMC4wMDIzNCw0LjA1NDU4IC0xLjYwNjY5LDcuOTQzODkgLTQuNDcyODgsMTAuODExNzRjLTIuODY2MTksMi44Njc4NSAtNi43NTQ1Nyw0LjQ3OTEzIC0xMC44MDkxNSw0LjQ3OTEzek0xODQuOTU4MTgsMjE0LjY1NHYtMzkuNzUwOTZsMjAuMzg3ODIsMjUuNDg0NzhsMjAuMzc4OTksLTI1LjQ4NDc4djM5Ljc1MDk2aDIwLjM4Nzgydi02OS4yOTkxNmgtMjAuMzg3ODJsLTIwLjM3ODk5LDI1LjQ4NDc4bC0yMC4zODc4MiwtMjUuNDg0NzhoLTIwLjM4NzgzdjY5LjMxNjgzek0zMjEuNTQyNDYsMTgwaC0yMC4zODc4M3YtMzQuNjU0aC0yMC4zNzg5OXYzNC42NTRoLTIwLjM4NzgzbDMwLjU3MjkxLDM1LjY3ODY5eiIgZmlsbD0iIzAwMDAwMCIgc3Ryb2tlPSJub25lIiBzdHJva2Utd2lkdGg9IjEiLz48L2c+PC9nPjwvZz48L3N2Zz48IS0tcm90YXRpb25DZW50ZXI6MTYzLjY2MzY2MzY2MzY2MzY3OjE1MC45MDA5MDA5MDA5MDA4Ny0tPg==";

    let marked = "data:text/javascript;base64,LyoqDQogKiBtYXJrZWQgLSBhIG1hcmtkb3duIHBhcnNlcg0KICogQ29weXJpZ2h0IChjKSAyMDExLTIwMjIsIENocmlzdG9waGVyIEplZmZyZXkuIChNSVQgTGljZW5zZWQpDQogKiBodHRwczovL2dpdGh1Yi5jb20vbWFya2VkanMvbWFya2VkDQogKi8NCg0KLyoqDQogKiBETyBOT1QgRURJVCBUSElTIEZJTEUNCiAqIFRoZSBjb2RlIGluIHRoaXMgZmlsZSBpcyBnZW5lcmF0ZWQgZnJvbSBmaWxlcyBpbiAuL3NyYy8NCiAqLw0KDQpmdW5jdGlvbiBnZXREZWZhdWx0cygpIHsNCiAgcmV0dXJuIHsNCiAgICBiYXNlVXJsOiBudWxsLA0KICAgIGJyZWFrczogZmFsc2UsDQogICAgZXh0ZW5zaW9uczogbnVsbCwNCiAgICBnZm06IHRydWUsDQogICAgaGVhZGVySWRzOiB0cnVlLA0KICAgIGhlYWRlclByZWZpeDogJycsDQogICAgaGlnaGxpZ2h0OiBudWxsLA0KICAgIGxhbmdQcmVmaXg6ICdsYW5ndWFnZS0nLA0KICAgIG1hbmdsZTogdHJ1ZSwNCiAgICBwZWRhbnRpYzogZmFsc2UsDQogICAgcmVuZGVyZXI6IG51bGwsDQogICAgc2FuaXRpemU6IGZhbHNlLA0KICAgIHNhbml0aXplcjogbnVsbCwNCiAgICBzaWxlbnQ6IGZhbHNlLA0KICAgIHNtYXJ0TGlzdHM6IGZhbHNlLA0KICAgIHNtYXJ0eXBhbnRzOiBmYWxzZSwNCiAgICB0b2tlbml6ZXI6IG51bGwsDQogICAgd2Fsa1Rva2VuczogbnVsbCwNCiAgICB4aHRtbDogZmFsc2UNCiAgfTsNCn0NCg0KbGV0IGRlZmF1bHRzID0gZ2V0RGVmYXVsdHMoKTsNCg0KZnVuY3Rpb24gY2hhbmdlRGVmYXVsdHMobmV3RGVmYXVsdHMpIHsNCiAgZGVmYXVsdHMgPSBuZXdEZWZhdWx0czsNCn0NCg0KLyoqDQogKiBIZWxwZXJzDQogKi8NCmNvbnN0IGVzY2FwZVRlc3QgPSAvWyY8PiInXS87DQpjb25zdCBlc2NhcGVSZXBsYWNlID0gL1smPD4iJ10vZzsNCmNvbnN0IGVzY2FwZVRlc3ROb0VuY29kZSA9IC9bPD4iJ118Jig/ISM/XHcrOykvOw0KY29uc3QgZXNjYXBlUmVwbGFjZU5vRW5jb2RlID0gL1s8PiInXXwmKD8hIz9cdys7KS9nOw0KY29uc3QgZXNjYXBlUmVwbGFjZW1lbnRzID0gew0KICAnJic6ICcmYW1wOycsDQogICc8JzogJyZsdDsnLA0KICAnPic6ICcmZ3Q7JywNCiAgJyInOiAnJnF1b3Q7JywNCiAgIiciOiAnJiMzOTsnDQp9Ow0KY29uc3QgZ2V0RXNjYXBlUmVwbGFjZW1lbnQgPSAoY2gpID0+IGVzY2FwZVJlcGxhY2VtZW50c1tjaF07DQpmdW5jdGlvbiBlc2NhcGUoaHRtbCwgZW5jb2RlKSB7DQogIGlmIChlbmNvZGUpIHsNCiAgICBpZiAoZXNjYXBlVGVzdC50ZXN0KGh0bWwpKSB7DQogICAgICByZXR1cm4gaHRtbC5yZXBsYWNlKGVzY2FwZVJlcGxhY2UsIGdldEVzY2FwZVJlcGxhY2VtZW50KTsNCiAgICB9DQogIH0gZWxzZSB7DQogICAgaWYgKGVzY2FwZVRlc3ROb0VuY29kZS50ZXN0KGh0bWwpKSB7DQogICAgICByZXR1cm4gaHRtbC5yZXBsYWNlKGVzY2FwZVJlcGxhY2VOb0VuY29kZSwgZ2V0RXNjYXBlUmVwbGFjZW1lbnQpOw0KICAgIH0NCiAgfQ0KDQogIHJldHVybiBodG1sOw0KfQ0KDQpjb25zdCB1bmVzY2FwZVRlc3QgPSAvJigjKD86XGQrKXwoPzojeFswLTlBLUZhLWZdKyl8KD86XHcrKSk7Py9pZzsNCg0KZnVuY3Rpb24gdW5lc2NhcGUoaHRtbCkgew0KICAvLyBleHBsaWNpdGx5IG1hdGNoIGRlY2ltYWwsIGhleCwgYW5kIG5hbWVkIEhUTUwgZW50aXRpZXMNCiAgcmV0dXJuIGh0bWwucmVwbGFjZSh1bmVzY2FwZVRlc3QsIChfLCBuKSA9PiB7DQogICAgbiA9IG4udG9Mb3dlckNhc2UoKTsNCiAgICBpZiAobiA9PT0gJ2NvbG9uJykgcmV0dXJuICc6JzsNCiAgICBpZiAobi5jaGFyQXQoMCkgPT09ICcjJykgew0KICAgICAgcmV0dXJuIG4uY2hhckF0KDEpID09PSAneCcNCiAgICAgICAgPyBTdHJpbmcuZnJvbUNoYXJDb2RlKHBhcnNlSW50KG4uc3Vic3RyaW5nKDIpLCAxNikpDQogICAgICAgIDogU3RyaW5nLmZyb21DaGFyQ29kZSgrbi5zdWJzdHJpbmcoMSkpOw0KICAgIH0NCiAgICByZXR1cm4gJyc7DQogIH0pOw0KfQ0KDQpjb25zdCBjYXJldCA9IC8oXnxbXlxbXSlcXi9nOw0KZnVuY3Rpb24gZWRpdChyZWdleCwgb3B0KSB7DQogIHJlZ2V4ID0gcmVnZXguc291cmNlIHx8IHJlZ2V4Ow0KICBvcHQgPSBvcHQgfHwgJyc7DQogIGNvbnN0IG9iaiA9IHsNCiAgICByZXBsYWNlOiAobmFtZSwgdmFsKSA9PiB7DQogICAgICB2YWwgPSB2YWwuc291cmNlIHx8IHZhbDsNCiAgICAgIHZhbCA9IHZhbC5yZXBsYWNlKGNhcmV0LCAnJDEnKTsNCiAgICAgIHJlZ2V4ID0gcmVnZXgucmVwbGFjZShuYW1lLCB2YWwpOw0KICAgICAgcmV0dXJuIG9iajsNCiAgICB9LA0KICAgIGdldFJlZ2V4OiAoKSA9PiB7DQogICAgICByZXR1cm4gbmV3IFJlZ0V4cChyZWdleCwgb3B0KTsNCiAgICB9DQogIH07DQogIHJldHVybiBvYmo7DQp9DQoNCmNvbnN0IG5vbldvcmRBbmRDb2xvblRlc3QgPSAvW15cdzpdL2c7DQpjb25zdCBvcmlnaW5JbmRlcGVuZGVudFVybCA9IC9eJHxeW2Etel1bYS16MC05Ky4tXSo6fF5bPyNdL2k7DQpmdW5jdGlvbiBjbGVhblVybChzYW5pdGl6ZSwgYmFzZSwgaHJlZikgew0KICBpZiAoc2FuaXRpemUpIHsNCiAgICBsZXQgcHJvdDsNCiAgICB0cnkgew0KICAgICAgcHJvdCA9IGRlY29kZVVSSUNvbXBvbmVudCh1bmVzY2FwZShocmVmKSkNCiAgICAgICAgLnJlcGxhY2Uobm9uV29yZEFuZENvbG9uVGVzdCwgJycpDQogICAgICAgIC50b0xvd2VyQ2FzZSgpOw0KICAgIH0gY2F0Y2ggKGUpIHsNCiAgICAgIHJldHVybiBudWxsOw0KICAgIH0NCiAgICBpZiAocHJvdC5pbmRleE9mKCdqYXZhc2NyaXB0OicpID09PSAwIHx8IHByb3QuaW5kZXhPZigndmJzY3JpcHQ6JykgPT09IDAgfHwgcHJvdC5pbmRleE9mKCdkYXRhOicpID09PSAwKSB7DQogICAgICByZXR1cm4gbnVsbDsNCiAgICB9DQogIH0NCiAgaWYgKGJhc2UgJiYgIW9yaWdpbkluZGVwZW5kZW50VXJsLnRlc3QoaHJlZikpIHsNCiAgICBocmVmID0gcmVzb2x2ZVVybChiYXNlLCBocmVmKTsNCiAgfQ0KICB0cnkgew0KICAgIGhyZWYgPSBlbmNvZGVVUkkoaHJlZikucmVwbGFjZSgvJTI1L2csICclJyk7DQogIH0gY2F0Y2ggKGUpIHsNCiAgICByZXR1cm4gbnVsbDsNCiAgfQ0KICByZXR1cm4gaHJlZjsNCn0NCg0KY29uc3QgYmFzZVVybHMgPSB7fTsNCmNvbnN0IGp1c3REb21haW4gPSAvXlteOl0rOlwvKlteL10qJC87DQpjb25zdCBwcm90b2NvbCA9IC9eKFteOl0rOilbXHNcU10qJC87DQpjb25zdCBkb21haW4gPSAvXihbXjpdKzpcLypbXi9dKilbXHNcU10qJC87DQoNCmZ1bmN0aW9uIHJlc29sdmVVcmwoYmFzZSwgaHJlZikgew0KICBpZiAoIWJhc2VVcmxzWycgJyArIGJhc2VdKSB7DQogICAgLy8gd2UgY2FuIGlnbm9yZSBldmVyeXRoaW5nIGluIGJhc2UgYWZ0ZXIgdGhlIGxhc3Qgc2xhc2ggb2YgaXRzIHBhdGggY29tcG9uZW50LA0KICAgIC8vIGJ1dCB3ZSBtaWdodCBuZWVkIHRvIGFkZCBfdGhhdF8NCiAgICAvLyBodHRwczovL3Rvb2xzLmlldGYub3JnL2h0bWwvcmZjMzk4NiNzZWN0aW9uLTMNCiAgICBpZiAoanVzdERvbWFpbi50ZXN0KGJhc2UpKSB7DQogICAgICBiYXNlVXJsc1snICcgKyBiYXNlXSA9IGJhc2UgKyAnLyc7DQogICAgfSBlbHNlIHsNCiAgICAgIGJhc2VVcmxzWycgJyArIGJhc2VdID0gcnRyaW0oYmFzZSwgJy8nLCB0cnVlKTsNCiAgICB9DQogIH0NCiAgYmFzZSA9IGJhc2VVcmxzWycgJyArIGJhc2VdOw0KICBjb25zdCByZWxhdGl2ZUJhc2UgPSBiYXNlLmluZGV4T2YoJzonKSA9PT0gLTE7DQoNCiAgaWYgKGhyZWYuc3Vic3RyaW5nKDAsIDIpID09PSAnLy8nKSB7DQogICAgaWYgKHJlbGF0aXZlQmFzZSkgew0KICAgICAgcmV0dXJuIGhyZWY7DQogICAgfQ0KICAgIHJldHVybiBiYXNlLnJlcGxhY2UocHJvdG9jb2wsICckMScpICsgaHJlZjsNCiAgfSBlbHNlIGlmIChocmVmLmNoYXJBdCgwKSA9PT0gJy8nKSB7DQogICAgaWYgKHJlbGF0aXZlQmFzZSkgew0KICAgICAgcmV0dXJuIGhyZWY7DQogICAgfQ0KICAgIHJldHVybiBiYXNlLnJlcGxhY2UoZG9tYWluLCAnJDEnKSArIGhyZWY7DQogIH0gZWxzZSB7DQogICAgcmV0dXJuIGJhc2UgKyBocmVmOw0KICB9DQp9DQoNCmNvbnN0IG5vb3BUZXN0ID0geyBleGVjOiBmdW5jdGlvbiBub29wVGVzdCgpIHt9IH07DQoNCmZ1bmN0aW9uIG1lcmdlKG9iaikgew0KICBsZXQgaSA9IDEsDQogICAgdGFyZ2V0LA0KICAgIGtleTsNCg0KICBmb3IgKDsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgew0KICAgIHRhcmdldCA9IGFyZ3VtZW50c1tpXTsNCiAgICBmb3IgKGtleSBpbiB0YXJnZXQpIHsNCiAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwodGFyZ2V0LCBrZXkpKSB7DQogICAgICAgIG9ialtrZXldID0gdGFyZ2V0W2tleV07DQogICAgICB9DQogICAgfQ0KICB9DQoNCiAgcmV0dXJuIG9iajsNCn0NCg0KZnVuY3Rpb24gc3BsaXRDZWxscyh0YWJsZVJvdywgY291bnQpIHsNCiAgLy8gZW5zdXJlIHRoYXQgZXZlcnkgY2VsbC1kZWxpbWl0aW5nIHBpcGUgaGFzIGEgc3BhY2UNCiAgLy8gYmVmb3JlIGl0IHRvIGRpc3Rpbmd1aXNoIGl0IGZyb20gYW4gZXNjYXBlZCBwaXBlDQogIGNvbnN0IHJvdyA9IHRhYmxlUm93LnJlcGxhY2UoL1x8L2csIChtYXRjaCwgb2Zmc2V0LCBzdHIpID0+IHsNCiAgICAgIGxldCBlc2NhcGVkID0gZmFsc2UsDQogICAgICAgIGN1cnIgPSBvZmZzZXQ7DQogICAgICB3aGlsZSAoLS1jdXJyID49IDAgJiYgc3RyW2N1cnJdID09PSAnXFwnKSBlc2NhcGVkID0gIWVzY2FwZWQ7DQogICAgICBpZiAoZXNjYXBlZCkgew0KICAgICAgICAvLyBvZGQgbnVtYmVyIG9mIHNsYXNoZXMgbWVhbnMgfCBpcyBlc2NhcGVkDQogICAgICAgIC8vIHNvIHdlIGxlYXZlIGl0IGFsb25lDQogICAgICAgIHJldHVybiAnfCc7DQogICAgICB9IGVsc2Ugew0KICAgICAgICAvLyBhZGQgc3BhY2UgYmVmb3JlIHVuZXNjYXBlZCB8DQogICAgICAgIHJldHVybiAnIHwnOw0KICAgICAgfQ0KICAgIH0pLA0KICAgIGNlbGxzID0gcm93LnNwbGl0KC8gXHwvKTsNCiAgbGV0IGkgPSAwOw0KDQogIC8vIEZpcnN0L2xhc3QgY2VsbCBpbiBhIHJvdyBjYW5ub3QgYmUgZW1wdHkgaWYgaXQgaGFzIG5vIGxlYWRpbmcvdHJhaWxpbmcgcGlwZQ0KICBpZiAoIWNlbGxzWzBdLnRyaW0oKSkgeyBjZWxscy5zaGlmdCgpOyB9DQogIGlmIChjZWxscy5sZW5ndGggPiAwICYmICFjZWxsc1tjZWxscy5sZW5ndGggLSAxXS50cmltKCkpIHsgY2VsbHMucG9wKCk7IH0NCg0KICBpZiAoY2VsbHMubGVuZ3RoID4gY291bnQpIHsNCiAgICBjZWxscy5zcGxpY2UoY291bnQpOw0KICB9IGVsc2Ugew0KICAgIHdoaWxlIChjZWxscy5sZW5ndGggPCBjb3VudCkgY2VsbHMucHVzaCgnJyk7DQogIH0NCg0KICBmb3IgKDsgaSA8IGNlbGxzLmxlbmd0aDsgaSsrKSB7DQogICAgLy8gbGVhZGluZyBvciB0cmFpbGluZyB3aGl0ZXNwYWNlIGlzIGlnbm9yZWQgcGVyIHRoZSBnZm0gc3BlYw0KICAgIGNlbGxzW2ldID0gY2VsbHNbaV0udHJpbSgpLnJlcGxhY2UoL1xcXHwvZywgJ3wnKTsNCiAgfQ0KICByZXR1cm4gY2VsbHM7DQp9DQoNCi8vIFJlbW92ZSB0cmFpbGluZyAnYydzLiBFcXVpdmFsZW50IHRvIHN0ci5yZXBsYWNlKC9jKiQvLCAnJykuDQovLyAvYyokLyBpcyB2dWxuZXJhYmxlIHRvIFJFRE9TLg0KLy8gaW52ZXJ0OiBSZW1vdmUgc3VmZml4IG9mIG5vbi1jIGNoYXJzIGluc3RlYWQuIERlZmF1bHQgZmFsc2V5Lg0KZnVuY3Rpb24gcnRyaW0oc3RyLCBjLCBpbnZlcnQpIHsNCiAgY29uc3QgbCA9IHN0ci5sZW5ndGg7DQogIGlmIChsID09PSAwKSB7DQogICAgcmV0dXJuICcnOw0KICB9DQoNCiAgLy8gTGVuZ3RoIG9mIHN1ZmZpeCBtYXRjaGluZyB0aGUgaW52ZXJ0IGNvbmRpdGlvbi4NCiAgbGV0IHN1ZmZMZW4gPSAwOw0KDQogIC8vIFN0ZXAgbGVmdCB1bnRpbCB3ZSBmYWlsIHRvIG1hdGNoIHRoZSBpbnZlcnQgY29uZGl0aW9uLg0KICB3aGlsZSAoc3VmZkxlbiA8IGwpIHsNCiAgICBjb25zdCBjdXJyQ2hhciA9IHN0ci5jaGFyQXQobCAtIHN1ZmZMZW4gLSAxKTsNCiAgICBpZiAoY3VyckNoYXIgPT09IGMgJiYgIWludmVydCkgew0KICAgICAgc3VmZkxlbisrOw0KICAgIH0gZWxzZSBpZiAoY3VyckNoYXIgIT09IGMgJiYgaW52ZXJ0KSB7DQogICAgICBzdWZmTGVuKys7DQogICAgfSBlbHNlIHsNCiAgICAgIGJyZWFrOw0KICAgIH0NCiAgfQ0KDQogIHJldHVybiBzdHIuc3Vic3RyKDAsIGwgLSBzdWZmTGVuKTsNCn0NCg0KZnVuY3Rpb24gZmluZENsb3NpbmdCcmFja2V0KHN0ciwgYikgew0KICBpZiAoc3RyLmluZGV4T2YoYlsxXSkgPT09IC0xKSB7DQogICAgcmV0dXJuIC0xOw0KICB9DQogIGNvbnN0IGwgPSBzdHIubGVuZ3RoOw0KICBsZXQgbGV2ZWwgPSAwLA0KICAgIGkgPSAwOw0KICBmb3IgKDsgaSA8IGw7IGkrKykgew0KICAgIGlmIChzdHJbaV0gPT09ICdcXCcpIHsNCiAgICAgIGkrKzsNCiAgICB9IGVsc2UgaWYgKHN0cltpXSA9PT0gYlswXSkgew0KICAgICAgbGV2ZWwrKzsNCiAgICB9IGVsc2UgaWYgKHN0cltpXSA9PT0gYlsxXSkgew0KICAgICAgbGV2ZWwtLTsNCiAgICAgIGlmIChsZXZlbCA8IDApIHsNCiAgICAgICAgcmV0dXJuIGk7DQogICAgICB9DQogICAgfQ0KICB9DQogIHJldHVybiAtMTsNCn0NCg0KZnVuY3Rpb24gY2hlY2tTYW5pdGl6ZURlcHJlY2F0aW9uKG9wdCkgew0KICBpZiAob3B0ICYmIG9wdC5zYW5pdGl6ZSAmJiAhb3B0LnNpbGVudCkgew0KICAgIGNvbnNvbGUud2FybignbWFya2VkKCk6IHNhbml0aXplIGFuZCBzYW5pdGl6ZXIgcGFyYW1ldGVycyBhcmUgZGVwcmVjYXRlZCBzaW5jZSB2ZXJzaW9uIDAuNy4wLCBzaG91bGQgbm90IGJlIHVzZWQgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiB0aGUgZnV0dXJlLiBSZWFkIG1vcmUgaGVyZTogaHR0cHM6Ly9tYXJrZWQuanMub3JnLyMvVVNJTkdfQURWQU5DRUQubWQjb3B0aW9ucycpOw0KICB9DQp9DQoNCi8vIGNvcGllZCBmcm9tIGh0dHBzOi8vc3RhY2tvdmVyZmxvdy5jb20vYS81NDUwMTEzLzgwNjc3Nw0KZnVuY3Rpb24gcmVwZWF0U3RyaW5nKHBhdHRlcm4sIGNvdW50KSB7DQogIGlmIChjb3VudCA8IDEpIHsNCiAgICByZXR1cm4gJyc7DQogIH0NCiAgbGV0IHJlc3VsdCA9ICcnOw0KICB3aGlsZSAoY291bnQgPiAxKSB7DQogICAgaWYgKGNvdW50ICYgMSkgew0KICAgICAgcmVzdWx0ICs9IHBhdHRlcm47DQogICAgfQ0KICAgIGNvdW50ID4+PSAxOw0KICAgIHBhdHRlcm4gKz0gcGF0dGVybjsNCiAgfQ0KICByZXR1cm4gcmVzdWx0ICsgcGF0dGVybjsNCn0NCg0KZnVuY3Rpb24gb3V0cHV0TGluayhjYXAsIGxpbmssIHJhdywgbGV4ZXIpIHsNCiAgY29uc3QgaHJlZiA9IGxpbmsuaHJlZjsNCiAgY29uc3QgdGl0bGUgPSBsaW5rLnRpdGxlID8gZXNjYXBlKGxpbmsudGl0bGUpIDogbnVsbDsNCiAgY29uc3QgdGV4dCA9IGNhcFsxXS5yZXBsYWNlKC9cXChbXFtcXV0pL2csICckMScpOw0KDQogIGlmIChjYXBbMF0uY2hhckF0KDApICE9PSAnIScpIHsNCiAgICBsZXhlci5zdGF0ZS5pbkxpbmsgPSB0cnVlOw0KICAgIGNvbnN0IHRva2VuID0gew0KICAgICAgdHlwZTogJ2xpbmsnLA0KICAgICAgcmF3LA0KICAgICAgaHJlZiwNCiAgICAgIHRpdGxlLA0KICAgICAgdGV4dCwNCiAgICAgIHRva2VuczogbGV4ZXIuaW5saW5lVG9rZW5zKHRleHQsIFtdKQ0KICAgIH07DQogICAgbGV4ZXIuc3RhdGUuaW5MaW5rID0gZmFsc2U7DQogICAgcmV0dXJuIHRva2VuOw0KICB9IGVsc2Ugew0KICAgIHJldHVybiB7DQogICAgICB0eXBlOiAnaW1hZ2UnLA0KICAgICAgcmF3LA0KICAgICAgaHJlZiwNCiAgICAgIHRpdGxlLA0KICAgICAgdGV4dDogZXNjYXBlKHRleHQpDQogICAgfTsNCiAgfQ0KfQ0KDQpmdW5jdGlvbiBpbmRlbnRDb2RlQ29tcGVuc2F0aW9uKHJhdywgdGV4dCkgew0KICBjb25zdCBtYXRjaEluZGVudFRvQ29kZSA9IHJhdy5tYXRjaCgvXihccyspKD86YGBgKS8pOw0KDQogIGlmIChtYXRjaEluZGVudFRvQ29kZSA9PT0gbnVsbCkgew0KICAgIHJldHVybiB0ZXh0Ow0KICB9DQoNCiAgY29uc3QgaW5kZW50VG9Db2RlID0gbWF0Y2hJbmRlbnRUb0NvZGVbMV07DQoNCiAgcmV0dXJuIHRleHQNCiAgICAuc3BsaXQoJ1xuJykNCiAgICAubWFwKG5vZGUgPT4gew0KICAgICAgY29uc3QgbWF0Y2hJbmRlbnRJbk5vZGUgPSBub2RlLm1hdGNoKC9eXHMrLyk7DQogICAgICBpZiAobWF0Y2hJbmRlbnRJbk5vZGUgPT09IG51bGwpIHsNCiAgICAgICAgcmV0dXJuIG5vZGU7DQogICAgICB9DQoNCiAgICAgIGNvbnN0IFtpbmRlbnRJbk5vZGVdID0gbWF0Y2hJbmRlbnRJbk5vZGU7DQoNCiAgICAgIGlmIChpbmRlbnRJbk5vZGUubGVuZ3RoID49IGluZGVudFRvQ29kZS5sZW5ndGgpIHsNCiAgICAgICAgcmV0dXJuIG5vZGUuc2xpY2UoaW5kZW50VG9Db2RlLmxlbmd0aCk7DQogICAgICB9DQoNCiAgICAgIHJldHVybiBub2RlOw0KICAgIH0pDQogICAgLmpvaW4oJ1xuJyk7DQp9DQoNCi8qKg0KICogVG9rZW5pemVyDQogKi8NCmNsYXNzIFRva2VuaXplciB7DQogIGNvbnN0cnVjdG9yKG9wdGlvbnMpIHsNCiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zIHx8IGRlZmF1bHRzOw0KICB9DQoNCiAgc3BhY2Uoc3JjKSB7DQogICAgY29uc3QgY2FwID0gdGhpcy5ydWxlcy5ibG9jay5uZXdsaW5lLmV4ZWMoc3JjKTsNCiAgICBpZiAoY2FwICYmIGNhcFswXS5sZW5ndGggPiAwKSB7DQogICAgICByZXR1cm4gew0KICAgICAgICB0eXBlOiAnc3BhY2UnLA0KICAgICAgICByYXc6IGNhcFswXQ0KICAgICAgfTsNCiAgICB9DQogIH0NCg0KICBjb2RlKHNyYykgew0KICAgIGNvbnN0IGNhcCA9IHRoaXMucnVsZXMuYmxvY2suY29kZS5leGVjKHNyYyk7DQogICAgaWYgKGNhcCkgew0KICAgICAgY29uc3QgdGV4dCA9IGNhcFswXS5yZXBsYWNlKC9eIHsxLDR9L2dtLCAnJyk7DQogICAgICByZXR1cm4gew0KICAgICAgICB0eXBlOiAnY29kZScsDQogICAgICAgIHJhdzogY2FwWzBdLA0KICAgICAgICBjb2RlQmxvY2tTdHlsZTogJ2luZGVudGVkJywNCiAgICAgICAgdGV4dDogIXRoaXMub3B0aW9ucy5wZWRhbnRpYw0KICAgICAgICAgID8gcnRyaW0odGV4dCwgJ1xuJykNCiAgICAgICAgICA6IHRleHQNCiAgICAgIH07DQogICAgfQ0KICB9DQoNCiAgZmVuY2VzKHNyYykgew0KICAgIGNvbnN0IGNhcCA9IHRoaXMucnVsZXMuYmxvY2suZmVuY2VzLmV4ZWMoc3JjKTsNCiAgICBpZiAoY2FwKSB7DQogICAgICBjb25zdCByYXcgPSBjYXBbMF07DQogICAgICBjb25zdCB0ZXh0ID0gaW5kZW50Q29kZUNvbXBlbnNhdGlvbihyYXcsIGNhcFszXSB8fCAnJyk7DQoNCiAgICAgIHJldHVybiB7DQogICAgICAgIHR5cGU6ICdjb2RlJywNCiAgICAgICAgcmF3LA0KICAgICAgICBsYW5nOiBjYXBbMl0gPyBjYXBbMl0udHJpbSgpIDogY2FwWzJdLA0KICAgICAgICB0ZXh0DQogICAgICB9Ow0KICAgIH0NCiAgfQ0KDQogIGhlYWRpbmcoc3JjKSB7DQogICAgY29uc3QgY2FwID0gdGhpcy5ydWxlcy5ibG9jay5oZWFkaW5nLmV4ZWMoc3JjKTsNCiAgICBpZiAoY2FwKSB7DQogICAgICBsZXQgdGV4dCA9IGNhcFsyXS50cmltKCk7DQoNCiAgICAgIC8vIHJlbW92ZSB0cmFpbGluZyAjcw0KICAgICAgaWYgKC8jJC8udGVzdCh0ZXh0KSkgew0KICAgICAgICBjb25zdCB0cmltbWVkID0gcnRyaW0odGV4dCwgJyMnKTsNCiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5wZWRhbnRpYykgew0KICAgICAgICAgIHRleHQgPSB0cmltbWVkLnRyaW0oKTsNCiAgICAgICAgfSBlbHNlIGlmICghdHJpbW1lZCB8fCAvICQvLnRlc3QodHJpbW1lZCkpIHsNCiAgICAgICAgICAvLyBDb21tb25NYXJrIHJlcXVpcmVzIHNwYWNlIGJlZm9yZSB0cmFpbGluZyAjcw0KICAgICAgICAgIHRleHQgPSB0cmltbWVkLnRyaW0oKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KDQogICAgICBjb25zdCB0b2tlbiA9IHsNCiAgICAgICAgdHlwZTogJ2hlYWRpbmcnLA0KICAgICAgICByYXc6IGNhcFswXSwNCiAgICAgICAgZGVwdGg6IGNhcFsxXS5sZW5ndGgsDQogICAgICAgIHRleHQ6IHRleHQsDQogICAgICAgIHRva2VuczogW10NCiAgICAgIH07DQogICAgICB0aGlzLmxleGVyLmlubGluZSh0b2tlbi50ZXh0LCB0b2tlbi50b2tlbnMpOw0KICAgICAgcmV0dXJuIHRva2VuOw0KICAgIH0NCiAgfQ0KDQogIGhyKHNyYykgew0KICAgIGNvbnN0IGNhcCA9IHRoaXMucnVsZXMuYmxvY2suaHIuZXhlYyhzcmMpOw0KICAgIGlmIChjYXApIHsNCiAgICAgIHJldHVybiB7DQogICAgICAgIHR5cGU6ICdocicsDQogICAgICAgIHJhdzogY2FwWzBdDQogICAgICB9Ow0KICAgIH0NCiAgfQ0KDQogIGJsb2NrcXVvdGUoc3JjKSB7DQogICAgY29uc3QgY2FwID0gdGhpcy5ydWxlcy5ibG9jay5ibG9ja3F1b3RlLmV4ZWMoc3JjKTsNCiAgICBpZiAoY2FwKSB7DQogICAgICBjb25zdCB0ZXh0ID0gY2FwWzBdLnJlcGxhY2UoL14gKj4gPy9nbSwgJycpOw0KDQogICAgICByZXR1cm4gew0KICAgICAgICB0eXBlOiAnYmxvY2txdW90ZScsDQogICAgICAgIHJhdzogY2FwWzBdLA0KICAgICAgICB0b2tlbnM6IHRoaXMubGV4ZXIuYmxvY2tUb2tlbnModGV4dCwgW10pLA0KICAgICAgICB0ZXh0DQogICAgICB9Ow0KICAgIH0NCiAgfQ0KDQogIGxpc3Qoc3JjKSB7DQogICAgbGV0IGNhcCA9IHRoaXMucnVsZXMuYmxvY2subGlzdC5leGVjKHNyYyk7DQogICAgaWYgKGNhcCkgew0KICAgICAgbGV0IHJhdywgaXN0YXNrLCBpc2NoZWNrZWQsIGluZGVudCwgaSwgYmxhbmtMaW5lLCBlbmRzV2l0aEJsYW5rTGluZSwNCiAgICAgICAgbGluZSwgbmV4dExpbmUsIHJhd0xpbmUsIGl0ZW1Db250ZW50cywgZW5kRWFybHk7DQoNCiAgICAgIGxldCBidWxsID0gY2FwWzFdLnRyaW0oKTsNCiAgICAgIGNvbnN0IGlzb3JkZXJlZCA9IGJ1bGwubGVuZ3RoID4gMTsNCg0KICAgICAgY29uc3QgbGlzdCA9IHsNCiAgICAgICAgdHlwZTogJ2xpc3QnLA0KICAgICAgICByYXc6ICcnLA0KICAgICAgICBvcmRlcmVkOiBpc29yZGVyZWQsDQogICAgICAgIHN0YXJ0OiBpc29yZGVyZWQgPyArYnVsbC5zbGljZSgwLCAtMSkgOiAnJywNCiAgICAgICAgbG9vc2U6IGZhbHNlLA0KICAgICAgICBpdGVtczogW10NCiAgICAgIH07DQoNCiAgICAgIGJ1bGwgPSBpc29yZGVyZWQgPyBgXFxkezEsOX1cXCR7YnVsbC5zbGljZSgtMSl9YCA6IGBcXCR7YnVsbH1gOw0KDQogICAgICBpZiAodGhpcy5vcHRpb25zLnBlZGFudGljKSB7DQogICAgICAgIGJ1bGwgPSBpc29yZGVyZWQgPyBidWxsIDogJ1sqKy1dJzsNCiAgICAgIH0NCg0KICAgICAgLy8gR2V0IG5leHQgbGlzdCBpdGVtDQogICAgICBjb25zdCBpdGVtUmVnZXggPSBuZXcgUmVnRXhwKGBeKCB7MCwzfSR7YnVsbH0pKCg/OiBbXlxcbl0qKT8oPzpcXG58JCkpYCk7DQoNCiAgICAgIC8vIENoZWNrIGlmIGN1cnJlbnQgYnVsbGV0IHBvaW50IGNhbiBzdGFydCBhIG5ldyBMaXN0IEl0ZW0NCiAgICAgIHdoaWxlIChzcmMpIHsNCiAgICAgICAgZW5kRWFybHkgPSBmYWxzZTsNCiAgICAgICAgaWYgKCEoY2FwID0gaXRlbVJlZ2V4LmV4ZWMoc3JjKSkpIHsNCiAgICAgICAgICBicmVhazsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmICh0aGlzLnJ1bGVzLmJsb2NrLmhyLnRlc3Qoc3JjKSkgeyAvLyBFbmQgbGlzdCBpZiBidWxsZXQgd2FzIGFjdHVhbGx5IEhSIChwb3NzaWJseSBtb3ZlIGludG8gaXRlbVJlZ2V4PykNCiAgICAgICAgICBicmVhazsNCiAgICAgICAgfQ0KDQogICAgICAgIHJhdyA9IGNhcFswXTsNCiAgICAgICAgc3JjID0gc3JjLnN1YnN0cmluZyhyYXcubGVuZ3RoKTsNCg0KICAgICAgICBsaW5lID0gY2FwWzJdLnNwbGl0KCdcbicsIDEpWzBdOw0KICAgICAgICBuZXh0TGluZSA9IHNyYy5zcGxpdCgnXG4nLCAxKVswXTsNCg0KICAgICAgICBpZiAodGhpcy5vcHRpb25zLnBlZGFudGljKSB7DQogICAgICAgICAgaW5kZW50ID0gMjsNCiAgICAgICAgICBpdGVtQ29udGVudHMgPSBsaW5lLnRyaW1MZWZ0KCk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgaW5kZW50ID0gY2FwWzJdLnNlYXJjaCgvW14gXS8pOyAvLyBGaW5kIGZpcnN0IG5vbi1zcGFjZSBjaGFyDQogICAgICAgICAgaW5kZW50ID0gaW5kZW50ID4gNCA/IDEgOiBpbmRlbnQ7IC8vIFRyZWF0IGluZGVudGVkIGNvZGUgYmxvY2tzICg+IDQgc3BhY2VzKSBhcyBoYXZpbmcgb25seSAxIGluZGVudA0KICAgICAgICAgIGl0ZW1Db250ZW50cyA9IGxpbmUuc2xpY2UoaW5kZW50KTsNCiAgICAgICAgICBpbmRlbnQgKz0gY2FwWzFdLmxlbmd0aDsNCiAgICAgICAgfQ0KDQogICAgICAgIGJsYW5rTGluZSA9IGZhbHNlOw0KDQogICAgICAgIGlmICghbGluZSAmJiAvXiAqJC8udGVzdChuZXh0TGluZSkpIHsgLy8gSXRlbXMgYmVnaW4gd2l0aCBhdCBtb3N0IG9uZSBibGFuayBsaW5lDQogICAgICAgICAgcmF3ICs9IG5leHRMaW5lICsgJ1xuJzsNCiAgICAgICAgICBzcmMgPSBzcmMuc3Vic3RyaW5nKG5leHRMaW5lLmxlbmd0aCArIDEpOw0KICAgICAgICAgIGVuZEVhcmx5ID0gdHJ1ZTsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmICghZW5kRWFybHkpIHsNCiAgICAgICAgICBjb25zdCBuZXh0QnVsbGV0UmVnZXggPSBuZXcgUmVnRXhwKGBeIHswLCR7TWF0aC5taW4oMywgaW5kZW50IC0gMSl9fSg/OlsqKy1dfFxcZHsxLDl9Wy4pXSlgKTsNCg0KICAgICAgICAgIC8vIENoZWNrIGlmIGZvbGxvd2luZyBsaW5lcyBzaG91bGQgYmUgaW5jbHVkZWQgaW4gTGlzdCBJdGVtDQogICAgICAgICAgd2hpbGUgKHNyYykgew0KICAgICAgICAgICAgcmF3TGluZSA9IHNyYy5zcGxpdCgnXG4nLCAxKVswXTsNCiAgICAgICAgICAgIGxpbmUgPSByYXdMaW5lOw0KDQogICAgICAgICAgICAvLyBSZS1hbGlnbiB0byBmb2xsb3cgY29tbW9ubWFyayBuZXN0aW5nIHJ1bGVzDQogICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLnBlZGFudGljKSB7DQogICAgICAgICAgICAgIGxpbmUgPSBsaW5lLnJlcGxhY2UoL14gezEsNH0oPz0oIHs0fSkqW14gXSkvZywgJyAgJyk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIC8vIEVuZCBsaXN0IGl0ZW0gaWYgZm91bmQgc3RhcnQgb2YgbmV3IGJ1bGxldA0KICAgICAgICAgICAgaWYgKG5leHRCdWxsZXRSZWdleC50ZXN0KGxpbmUpKSB7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBpZiAobGluZS5zZWFyY2goL1teIF0vKSA+PSBpbmRlbnQgfHwgIWxpbmUudHJpbSgpKSB7IC8vIERlZGVudCBpZiBwb3NzaWJsZQ0KICAgICAgICAgICAgICBpdGVtQ29udGVudHMgKz0gJ1xuJyArIGxpbmUuc2xpY2UoaW5kZW50KTsNCiAgICAgICAgICAgIH0gZWxzZSBpZiAoIWJsYW5rTGluZSkgeyAvLyBVbnRpbCBibGFuayBsaW5lLCBpdGVtIGRvZXNuJ3QgbmVlZCBpbmRlbnRhdGlvbg0KICAgICAgICAgICAgICBpdGVtQ29udGVudHMgKz0gJ1xuJyArIGxpbmU7DQogICAgICAgICAgICB9IGVsc2UgeyAvLyBPdGhlcndpc2UsIGltcHJvcGVyIGluZGVudGF0aW9uIGVuZHMgdGhpcyBpdGVtDQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBpZiAoIWJsYW5rTGluZSAmJiAhbGluZS50cmltKCkpIHsgLy8gQ2hlY2sgaWYgY3VycmVudCBsaW5lIGlzIGJsYW5rDQogICAgICAgICAgICAgIGJsYW5rTGluZSA9IHRydWU7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIHJhdyArPSByYXdMaW5lICsgJ1xuJzsNCiAgICAgICAgICAgIHNyYyA9IHNyYy5zdWJzdHJpbmcocmF3TGluZS5sZW5ndGggKyAxKTsNCiAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICBpZiAoIWxpc3QubG9vc2UpIHsNCiAgICAgICAgICAvLyBJZiB0aGUgcHJldmlvdXMgaXRlbSBlbmRlZCB3aXRoIGEgYmxhbmsgbGluZSwgdGhlIGxpc3QgaXMgbG9vc2UNCiAgICAgICAgICBpZiAoZW5kc1dpdGhCbGFua0xpbmUpIHsNCiAgICAgICAgICAgIGxpc3QubG9vc2UgPSB0cnVlOw0KICAgICAgICAgIH0gZWxzZSBpZiAoL1xuICpcbiAqJC8udGVzdChyYXcpKSB7DQogICAgICAgICAgICBlbmRzV2l0aEJsYW5rTGluZSA9IHRydWU7DQogICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICAgICAgLy8gQ2hlY2sgZm9yIHRhc2sgbGlzdCBpdGVtcw0KICAgICAgICBpZiAodGhpcy5vcHRpb25zLmdmbSkgew0KICAgICAgICAgIGlzdGFzayA9IC9eXFtbIHhYXVxdIC8uZXhlYyhpdGVtQ29udGVudHMpOw0KICAgICAgICAgIGlmIChpc3Rhc2spIHsNCiAgICAgICAgICAgIGlzY2hlY2tlZCA9IGlzdGFza1swXSAhPT0gJ1sgXSAnOw0KICAgICAgICAgICAgaXRlbUNvbnRlbnRzID0gaXRlbUNvbnRlbnRzLnJlcGxhY2UoL15cW1sgeFhdXF0gKy8sICcnKTsNCiAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICBsaXN0Lml0ZW1zLnB1c2goew0KICAgICAgICAgIHR5cGU6ICdsaXN0X2l0ZW0nLA0KICAgICAgICAgIHJhdzogcmF3LA0KICAgICAgICAgIHRhc2s6ICEhaXN0YXNrLA0KICAgICAgICAgIGNoZWNrZWQ6IGlzY2hlY2tlZCwNCiAgICAgICAgICBsb29zZTogZmFsc2UsDQogICAgICAgICAgdGV4dDogaXRlbUNvbnRlbnRzDQogICAgICAgIH0pOw0KDQogICAgICAgIGxpc3QucmF3ICs9IHJhdzsNCiAgICAgIH0NCg0KICAgICAgLy8gRG8gbm90IGNvbnN1bWUgbmV3bGluZXMgYXQgZW5kIG9mIGZpbmFsIGl0ZW0uIEFsdGVybmF0aXZlbHksIG1ha2UgaXRlbVJlZ2V4ICpzdGFydCogd2l0aCBhbnkgbmV3bGluZXMgdG8gc2ltcGxpZnkvc3BlZWQgdXAgZW5kc1dpdGhCbGFua0xpbmUgbG9naWMNCiAgICAgIGxpc3QuaXRlbXNbbGlzdC5pdGVtcy5sZW5ndGggLSAxXS5yYXcgPSByYXcudHJpbVJpZ2h0KCk7DQogICAgICBsaXN0Lml0ZW1zW2xpc3QuaXRlbXMubGVuZ3RoIC0gMV0udGV4dCA9IGl0ZW1Db250ZW50cy50cmltUmlnaHQoKTsNCiAgICAgIGxpc3QucmF3ID0gbGlzdC5yYXcudHJpbVJpZ2h0KCk7DQoNCiAgICAgIGNvbnN0IGwgPSBsaXN0Lml0ZW1zLmxlbmd0aDsNCg0KICAgICAgLy8gSXRlbSBjaGlsZCB0b2tlbnMgaGFuZGxlZCBoZXJlIGF0IGVuZCBiZWNhdXNlIHdlIG5lZWRlZCB0byBoYXZlIHRoZSBmaW5hbCBpdGVtIHRvIHRyaW0gaXQgZmlyc3QNCiAgICAgIGZvciAoaSA9IDA7IGkgPCBsOyBpKyspIHsNCiAgICAgICAgdGhpcy5sZXhlci5zdGF0ZS50b3AgPSBmYWxzZTsNCiAgICAgICAgbGlzdC5pdGVtc1tpXS50b2tlbnMgPSB0aGlzLmxleGVyLmJsb2NrVG9rZW5zKGxpc3QuaXRlbXNbaV0udGV4dCwgW10pOw0KICAgICAgICBjb25zdCBzcGFjZXJzID0gbGlzdC5pdGVtc1tpXS50b2tlbnMuZmlsdGVyKHQgPT4gdC50eXBlID09PSAnc3BhY2UnKTsNCiAgICAgICAgY29uc3QgaGFzTXVsdGlwbGVMaW5lQnJlYWtzID0gc3BhY2Vycy5ldmVyeSh0ID0+IHsNCiAgICAgICAgICBjb25zdCBjaGFycyA9IHQucmF3LnNwbGl0KCcnKTsNCiAgICAgICAgICBsZXQgbGluZUJyZWFrcyA9IDA7DQogICAgICAgICAgZm9yIChjb25zdCBjaGFyIG9mIGNoYXJzKSB7DQogICAgICAgICAgICBpZiAoY2hhciA9PT0gJ1xuJykgew0KICAgICAgICAgICAgICBsaW5lQnJlYWtzICs9IDE7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZiAobGluZUJyZWFrcyA+IDEpIHsNCiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICAgICAgICB9DQogICAgICAgICAgfQ0KDQogICAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgICB9KTsNCg0KICAgICAgICBpZiAoIWxpc3QubG9vc2UgJiYgc3BhY2Vycy5sZW5ndGggJiYgaGFzTXVsdGlwbGVMaW5lQnJlYWtzKSB7DQogICAgICAgICAgLy8gSGF2aW5nIGEgc2luZ2xlIGxpbmUgYnJlYWsgZG9lc24ndCBtZWFuIGEgbGlzdCBpcyBsb29zZS4gQSBzaW5nbGUgbGluZSBicmVhayBpcyB0ZXJtaW5hdGluZyB0aGUgbGFzdCBsaXN0IGl0ZW0NCiAgICAgICAgICBsaXN0Lmxvb3NlID0gdHJ1ZTsNCiAgICAgICAgICBsaXN0Lml0ZW1zW2ldLmxvb3NlID0gdHJ1ZTsNCiAgICAgICAgfQ0KICAgICAgfQ0KDQogICAgICByZXR1cm4gbGlzdDsNCiAgICB9DQogIH0NCg0KICBodG1sKHNyYykgew0KICAgIGNvbnN0IGNhcCA9IHRoaXMucnVsZXMuYmxvY2suaHRtbC5leGVjKHNyYyk7DQogICAgaWYgKGNhcCkgew0KICAgICAgY29uc3QgdG9rZW4gPSB7DQogICAgICAgIHR5cGU6ICdodG1sJywNCiAgICAgICAgcmF3OiBjYXBbMF0sDQogICAgICAgIHByZTogIXRoaXMub3B0aW9ucy5zYW5pdGl6ZXINCiAgICAgICAgICAmJiAoY2FwWzFdID09PSAncHJlJyB8fCBjYXBbMV0gPT09ICdzY3JpcHQnIHx8IGNhcFsxXSA9PT0gJ3N0eWxlJyksDQogICAgICAgIHRleHQ6IGNhcFswXQ0KICAgICAgfTsNCiAgICAgIGlmICh0aGlzLm9wdGlvbnMuc2FuaXRpemUpIHsNCiAgICAgICAgdG9rZW4udHlwZSA9ICdwYXJhZ3JhcGgnOw0KICAgICAgICB0b2tlbi50ZXh0ID0gdGhpcy5vcHRpb25zLnNhbml0aXplciA/IHRoaXMub3B0aW9ucy5zYW5pdGl6ZXIoY2FwWzBdKSA6IGVzY2FwZShjYXBbMF0pOw0KICAgICAgICB0b2tlbi50b2tlbnMgPSBbXTsNCiAgICAgICAgdGhpcy5sZXhlci5pbmxpbmUodG9rZW4udGV4dCwgdG9rZW4udG9rZW5zKTsNCiAgICAgIH0NCiAgICAgIHJldHVybiB0b2tlbjsNCiAgICB9DQogIH0NCg0KICBkZWYoc3JjKSB7DQogICAgY29uc3QgY2FwID0gdGhpcy5ydWxlcy5ibG9jay5kZWYuZXhlYyhzcmMpOw0KICAgIGlmIChjYXApIHsNCiAgICAgIGlmIChjYXBbM10pIGNhcFszXSA9IGNhcFszXS5zdWJzdHJpbmcoMSwgY2FwWzNdLmxlbmd0aCAtIDEpOw0KICAgICAgY29uc3QgdGFnID0gY2FwWzFdLnRvTG93ZXJDYXNlKCkucmVwbGFjZSgvXHMrL2csICcgJyk7DQogICAgICByZXR1cm4gew0KICAgICAgICB0eXBlOiAnZGVmJywNCiAgICAgICAgdGFnLA0KICAgICAgICByYXc6IGNhcFswXSwNCiAgICAgICAgaHJlZjogY2FwWzJdLA0KICAgICAgICB0aXRsZTogY2FwWzNdDQogICAgICB9Ow0KICAgIH0NCiAgfQ0KDQogIHRhYmxlKHNyYykgew0KICAgIGNvbnN0IGNhcCA9IHRoaXMucnVsZXMuYmxvY2sudGFibGUuZXhlYyhzcmMpOw0KICAgIGlmIChjYXApIHsNCiAgICAgIGNvbnN0IGl0ZW0gPSB7DQogICAgICAgIHR5cGU6ICd0YWJsZScsDQogICAgICAgIGhlYWRlcjogc3BsaXRDZWxscyhjYXBbMV0pLm1hcChjID0+IHsgcmV0dXJuIHsgdGV4dDogYyB9OyB9KSwNCiAgICAgICAgYWxpZ246IGNhcFsyXS5yZXBsYWNlKC9eICp8XHwgKiQvZywgJycpLnNwbGl0KC8gKlx8ICovKSwNCiAgICAgICAgcm93czogY2FwWzNdICYmIGNhcFszXS50cmltKCkgPyBjYXBbM10ucmVwbGFjZSgvXG5bIFx0XSokLywgJycpLnNwbGl0KCdcbicpIDogW10NCiAgICAgIH07DQoNCiAgICAgIGlmIChpdGVtLmhlYWRlci5sZW5ndGggPT09IGl0ZW0uYWxpZ24ubGVuZ3RoKSB7DQogICAgICAgIGl0ZW0ucmF3ID0gY2FwWzBdOw0KDQogICAgICAgIGxldCBsID0gaXRlbS5hbGlnbi5sZW5ndGg7DQogICAgICAgIGxldCBpLCBqLCBrLCByb3c7DQogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsOyBpKyspIHsNCiAgICAgICAgICBpZiAoL14gKi0rOiAqJC8udGVzdChpdGVtLmFsaWduW2ldKSkgew0KICAgICAgICAgICAgaXRlbS5hbGlnbltpXSA9ICdyaWdodCc7DQogICAgICAgICAgfSBlbHNlIGlmICgvXiAqOi0rOiAqJC8udGVzdChpdGVtLmFsaWduW2ldKSkgew0KICAgICAgICAgICAgaXRlbS5hbGlnbltpXSA9ICdjZW50ZXInOw0KICAgICAgICAgIH0gZWxzZSBpZiAoL14gKjotKyAqJC8udGVzdChpdGVtLmFsaWduW2ldKSkgew0KICAgICAgICAgICAgaXRlbS5hbGlnbltpXSA9ICdsZWZ0JzsNCiAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgaXRlbS5hbGlnbltpXSA9IG51bGw7DQogICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICAgICAgbCA9IGl0ZW0ucm93cy5sZW5ndGg7DQogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsOyBpKyspIHsNCiAgICAgICAgICBpdGVtLnJvd3NbaV0gPSBzcGxpdENlbGxzKGl0ZW0ucm93c1tpXSwgaXRlbS5oZWFkZXIubGVuZ3RoKS5tYXAoYyA9PiB7IHJldHVybiB7IHRleHQ6IGMgfTsgfSk7DQogICAgICAgIH0NCg0KICAgICAgICAvLyBwYXJzZSBjaGlsZCB0b2tlbnMgaW5zaWRlIGhlYWRlcnMgYW5kIGNlbGxzDQoNCiAgICAgICAgLy8gaGVhZGVyIGNoaWxkIHRva2Vucw0KICAgICAgICBsID0gaXRlbS5oZWFkZXIubGVuZ3RoOw0KICAgICAgICBmb3IgKGogPSAwOyBqIDwgbDsgaisrKSB7DQogICAgICAgICAgaXRlbS5oZWFkZXJbal0udG9rZW5zID0gW107DQogICAgICAgICAgdGhpcy5sZXhlci5pbmxpbmVUb2tlbnMoaXRlbS5oZWFkZXJbal0udGV4dCwgaXRlbS5oZWFkZXJbal0udG9rZW5zKTsNCiAgICAgICAgfQ0KDQogICAgICAgIC8vIGNlbGwgY2hpbGQgdG9rZW5zDQogICAgICAgIGwgPSBpdGVtLnJvd3MubGVuZ3RoOw0KICAgICAgICBmb3IgKGogPSAwOyBqIDwgbDsgaisrKSB7DQogICAgICAgICAgcm93ID0gaXRlbS5yb3dzW2pdOw0KICAgICAgICAgIGZvciAoayA9IDA7IGsgPCByb3cubGVuZ3RoOyBrKyspIHsNCiAgICAgICAgICAgIHJvd1trXS50b2tlbnMgPSBbXTsNCiAgICAgICAgICAgIHRoaXMubGV4ZXIuaW5saW5lVG9rZW5zKHJvd1trXS50ZXh0LCByb3dba10udG9rZW5zKTsNCiAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICByZXR1cm4gaXRlbTsNCiAgICAgIH0NCiAgICB9DQogIH0NCg0KICBsaGVhZGluZyhzcmMpIHsNCiAgICBjb25zdCBjYXAgPSB0aGlzLnJ1bGVzLmJsb2NrLmxoZWFkaW5nLmV4ZWMoc3JjKTsNCiAgICBpZiAoY2FwKSB7DQogICAgICBjb25zdCB0b2tlbiA9IHsNCiAgICAgICAgdHlwZTogJ2hlYWRpbmcnLA0KICAgICAgICByYXc6IGNhcFswXSwNCiAgICAgICAgZGVwdGg6IGNhcFsyXS5jaGFyQXQoMCkgPT09ICc9JyA/IDEgOiAyLA0KICAgICAgICB0ZXh0OiBjYXBbMV0sDQogICAgICAgIHRva2VuczogW10NCiAgICAgIH07DQogICAgICB0aGlzLmxleGVyLmlubGluZSh0b2tlbi50ZXh0LCB0b2tlbi50b2tlbnMpOw0KICAgICAgcmV0dXJuIHRva2VuOw0KICAgIH0NCiAgfQ0KDQogIHBhcmFncmFwaChzcmMpIHsNCiAgICBjb25zdCBjYXAgPSB0aGlzLnJ1bGVzLmJsb2NrLnBhcmFncmFwaC5leGVjKHNyYyk7DQogICAgaWYgKGNhcCkgew0KICAgICAgY29uc3QgdG9rZW4gPSB7DQogICAgICAgIHR5cGU6ICdwYXJhZ3JhcGgnLA0KICAgICAgICByYXc6IGNhcFswXSwNCiAgICAgICAgdGV4dDogY2FwWzFdLmNoYXJBdChjYXBbMV0ubGVuZ3RoIC0gMSkgPT09ICdcbicNCiAgICAgICAgICA/IGNhcFsxXS5zbGljZSgwLCAtMSkNCiAgICAgICAgICA6IGNhcFsxXSwNCiAgICAgICAgdG9rZW5zOiBbXQ0KICAgICAgfTsNCiAgICAgIHRoaXMubGV4ZXIuaW5saW5lKHRva2VuLnRleHQsIHRva2VuLnRva2Vucyk7DQogICAgICByZXR1cm4gdG9rZW47DQogICAgfQ0KICB9DQoNCiAgdGV4dChzcmMpIHsNCiAgICBjb25zdCBjYXAgPSB0aGlzLnJ1bGVzLmJsb2NrLnRleHQuZXhlYyhzcmMpOw0KICAgIGlmIChjYXApIHsNCiAgICAgIGNvbnN0IHRva2VuID0gew0KICAgICAgICB0eXBlOiAndGV4dCcsDQogICAgICAgIHJhdzogY2FwWzBdLA0KICAgICAgICB0ZXh0OiBjYXBbMF0sDQogICAgICAgIHRva2VuczogW10NCiAgICAgIH07DQogICAgICB0aGlzLmxleGVyLmlubGluZSh0b2tlbi50ZXh0LCB0b2tlbi50b2tlbnMpOw0KICAgICAgcmV0dXJuIHRva2VuOw0KICAgIH0NCiAgfQ0KDQogIGVzY2FwZShzcmMpIHsNCiAgICBjb25zdCBjYXAgPSB0aGlzLnJ1bGVzLmlubGluZS5lc2NhcGUuZXhlYyhzcmMpOw0KICAgIGlmIChjYXApIHsNCiAgICAgIHJldHVybiB7DQogICAgICAgIHR5cGU6ICdlc2NhcGUnLA0KICAgICAgICByYXc6IGNhcFswXSwNCiAgICAgICAgdGV4dDogZXNjYXBlKGNhcFsxXSkNCiAgICAgIH07DQogICAgfQ0KICB9DQoNCiAgdGFnKHNyYykgew0KICAgIGNvbnN0IGNhcCA9IHRoaXMucnVsZXMuaW5saW5lLnRhZy5leGVjKHNyYyk7DQogICAgaWYgKGNhcCkgew0KICAgICAgaWYgKCF0aGlzLmxleGVyLnN0YXRlLmluTGluayAmJiAvXjxhIC9pLnRlc3QoY2FwWzBdKSkgew0KICAgICAgICB0aGlzLmxleGVyLnN0YXRlLmluTGluayA9IHRydWU7DQogICAgICB9IGVsc2UgaWYgKHRoaXMubGV4ZXIuc3RhdGUuaW5MaW5rICYmIC9ePFwvYT4vaS50ZXN0KGNhcFswXSkpIHsNCiAgICAgICAgdGhpcy5sZXhlci5zdGF0ZS5pbkxpbmsgPSBmYWxzZTsNCiAgICAgIH0NCiAgICAgIGlmICghdGhpcy5sZXhlci5zdGF0ZS5pblJhd0Jsb2NrICYmIC9ePChwcmV8Y29kZXxrYmR8c2NyaXB0KShcc3w+KS9pLnRlc3QoY2FwWzBdKSkgew0KICAgICAgICB0aGlzLmxleGVyLnN0YXRlLmluUmF3QmxvY2sgPSB0cnVlOw0KICAgICAgfSBlbHNlIGlmICh0aGlzLmxleGVyLnN0YXRlLmluUmF3QmxvY2sgJiYgL148XC8ocHJlfGNvZGV8a2JkfHNjcmlwdCkoXHN8PikvaS50ZXN0KGNhcFswXSkpIHsNCiAgICAgICAgdGhpcy5sZXhlci5zdGF0ZS5pblJhd0Jsb2NrID0gZmFsc2U7DQogICAgICB9DQoNCiAgICAgIHJldHVybiB7DQogICAgICAgIHR5cGU6IHRoaXMub3B0aW9ucy5zYW5pdGl6ZQ0KICAgICAgICAgID8gJ3RleHQnDQogICAgICAgICAgOiAnaHRtbCcsDQogICAgICAgIHJhdzogY2FwWzBdLA0KICAgICAgICBpbkxpbms6IHRoaXMubGV4ZXIuc3RhdGUuaW5MaW5rLA0KICAgICAgICBpblJhd0Jsb2NrOiB0aGlzLmxleGVyLnN0YXRlLmluUmF3QmxvY2ssDQogICAgICAgIHRleHQ6IHRoaXMub3B0aW9ucy5zYW5pdGl6ZQ0KICAgICAgICAgID8gKHRoaXMub3B0aW9ucy5zYW5pdGl6ZXINCiAgICAgICAgICAgID8gdGhpcy5vcHRpb25zLnNhbml0aXplcihjYXBbMF0pDQogICAgICAgICAgICA6IGVzY2FwZShjYXBbMF0pKQ0KICAgICAgICAgIDogY2FwWzBdDQogICAgICB9Ow0KICAgIH0NCiAgfQ0KDQogIGxpbmsoc3JjKSB7DQogICAgY29uc3QgY2FwID0gdGhpcy5ydWxlcy5pbmxpbmUubGluay5leGVjKHNyYyk7DQogICAgaWYgKGNhcCkgew0KICAgICAgY29uc3QgdHJpbW1lZFVybCA9IGNhcFsyXS50cmltKCk7DQogICAgICBpZiAoIXRoaXMub3B0aW9ucy5wZWRhbnRpYyAmJiAvXjwvLnRlc3QodHJpbW1lZFVybCkpIHsNCiAgICAgICAgLy8gY29tbW9ubWFyayByZXF1aXJlcyBtYXRjaGluZyBhbmdsZSBicmFja2V0cw0KICAgICAgICBpZiAoISgvPiQvLnRlc3QodHJpbW1lZFVybCkpKSB7DQogICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9DQoNCiAgICAgICAgLy8gZW5kaW5nIGFuZ2xlIGJyYWNrZXQgY2Fubm90IGJlIGVzY2FwZWQNCiAgICAgICAgY29uc3QgcnRyaW1TbGFzaCA9IHJ0cmltKHRyaW1tZWRVcmwuc2xpY2UoMCwgLTEpLCAnXFwnKTsNCiAgICAgICAgaWYgKCh0cmltbWVkVXJsLmxlbmd0aCAtIHJ0cmltU2xhc2gubGVuZ3RoKSAlIDIgPT09IDApIHsNCiAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCiAgICAgIH0gZWxzZSB7DQogICAgICAgIC8vIGZpbmQgY2xvc2luZyBwYXJlbnRoZXNpcw0KICAgICAgICBjb25zdCBsYXN0UGFyZW5JbmRleCA9IGZpbmRDbG9zaW5nQnJhY2tldChjYXBbMl0sICcoKScpOw0KICAgICAgICBpZiAobGFzdFBhcmVuSW5kZXggPiAtMSkgew0KICAgICAgICAgIGNvbnN0IHN0YXJ0ID0gY2FwWzBdLmluZGV4T2YoJyEnKSA9PT0gMCA/IDUgOiA0Ow0KICAgICAgICAgIGNvbnN0IGxpbmtMZW4gPSBzdGFydCArIGNhcFsxXS5sZW5ndGggKyBsYXN0UGFyZW5JbmRleDsNCiAgICAgICAgICBjYXBbMl0gPSBjYXBbMl0uc3Vic3RyaW5nKDAsIGxhc3RQYXJlbkluZGV4KTsNCiAgICAgICAgICBjYXBbMF0gPSBjYXBbMF0uc3Vic3RyaW5nKDAsIGxpbmtMZW4pLnRyaW0oKTsNCiAgICAgICAgICBjYXBbM10gPSAnJzsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgbGV0IGhyZWYgPSBjYXBbMl07DQogICAgICBsZXQgdGl0bGUgPSAnJzsNCiAgICAgIGlmICh0aGlzLm9wdGlvbnMucGVkYW50aWMpIHsNCiAgICAgICAgLy8gc3BsaXQgcGVkYW50aWMgaHJlZiBhbmQgdGl0bGUNCiAgICAgICAgY29uc3QgbGluayA9IC9eKFteJyJdKlteXHNdKVxzKyhbJyJdKSguKilcMi8uZXhlYyhocmVmKTsNCg0KICAgICAgICBpZiAobGluaykgew0KICAgICAgICAgIGhyZWYgPSBsaW5rWzFdOw0KICAgICAgICAgIHRpdGxlID0gbGlua1szXTsNCiAgICAgICAgfQ0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgdGl0bGUgPSBjYXBbM10gPyBjYXBbM10uc2xpY2UoMSwgLTEpIDogJyc7DQogICAgICB9DQoNCiAgICAgIGhyZWYgPSBocmVmLnRyaW0oKTsNCiAgICAgIGlmICgvXjwvLnRlc3QoaHJlZikpIHsNCiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5wZWRhbnRpYyAmJiAhKC8+JC8udGVzdCh0cmltbWVkVXJsKSkpIHsNCiAgICAgICAgICAvLyBwZWRhbnRpYyBhbGxvd3Mgc3RhcnRpbmcgYW5nbGUgYnJhY2tldCB3aXRob3V0IGVuZGluZyBhbmdsZSBicmFja2V0DQogICAgICAgICAgaHJlZiA9IGhyZWYuc2xpY2UoMSk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgaHJlZiA9IGhyZWYuc2xpY2UoMSwgLTEpOw0KICAgICAgICB9DQogICAgICB9DQogICAgICByZXR1cm4gb3V0cHV0TGluayhjYXAsIHsNCiAgICAgICAgaHJlZjogaHJlZiA/IGhyZWYucmVwbGFjZSh0aGlzLnJ1bGVzLmlubGluZS5fZXNjYXBlcywgJyQxJykgOiBocmVmLA0KICAgICAgICB0aXRsZTogdGl0bGUgPyB0aXRsZS5yZXBsYWNlKHRoaXMucnVsZXMuaW5saW5lLl9lc2NhcGVzLCAnJDEnKSA6IHRpdGxlDQogICAgICB9LCBjYXBbMF0sIHRoaXMubGV4ZXIpOw0KICAgIH0NCiAgfQ0KDQogIHJlZmxpbmsoc3JjLCBsaW5rcykgew0KICAgIGxldCBjYXA7DQogICAgaWYgKChjYXAgPSB0aGlzLnJ1bGVzLmlubGluZS5yZWZsaW5rLmV4ZWMoc3JjKSkNCiAgICAgICAgfHwgKGNhcCA9IHRoaXMucnVsZXMuaW5saW5lLm5vbGluay5leGVjKHNyYykpKSB7DQogICAgICBsZXQgbGluayA9IChjYXBbMl0gfHwgY2FwWzFdKS5yZXBsYWNlKC9ccysvZywgJyAnKTsNCiAgICAgIGxpbmsgPSBsaW5rc1tsaW5rLnRvTG93ZXJDYXNlKCldOw0KICAgICAgaWYgKCFsaW5rIHx8ICFsaW5rLmhyZWYpIHsNCiAgICAgICAgY29uc3QgdGV4dCA9IGNhcFswXS5jaGFyQXQoMCk7DQogICAgICAgIHJldHVybiB7DQogICAgICAgICAgdHlwZTogJ3RleHQnLA0KICAgICAgICAgIHJhdzogdGV4dCwNCiAgICAgICAgICB0ZXh0DQogICAgICAgIH07DQogICAgICB9DQogICAgICByZXR1cm4gb3V0cHV0TGluayhjYXAsIGxpbmssIGNhcFswXSwgdGhpcy5sZXhlcik7DQogICAgfQ0KICB9DQoNCiAgZW1TdHJvbmcoc3JjLCBtYXNrZWRTcmMsIHByZXZDaGFyID0gJycpIHsNCiAgICBsZXQgbWF0Y2ggPSB0aGlzLnJ1bGVzLmlubGluZS5lbVN0cm9uZy5sRGVsaW0uZXhlYyhzcmMpOw0KICAgIGlmICghbWF0Y2gpIHJldHVybjsNCg0KICAgIC8vIF8gY2FuJ3QgYmUgYmV0d2VlbiB0d28gYWxwaGFudW1lcmljcy4gXHB7TH1ccHtOfSBpbmNsdWRlcyBub24tZW5nbGlzaCBhbHBoYWJldC9udW1iZXJzIGFzIHdlbGwNCiAgICBpZiAobWF0Y2hbM10gJiYgcHJldkNoYXIubWF0Y2goL1tccHtMfVxwe059XS91KSkgcmV0dXJuOw0KDQogICAgY29uc3QgbmV4dENoYXIgPSBtYXRjaFsxXSB8fCBtYXRjaFsyXSB8fCAnJzsNCg0KICAgIGlmICghbmV4dENoYXIgfHwgKG5leHRDaGFyICYmIChwcmV2Q2hhciA9PT0gJycgfHwgdGhpcy5ydWxlcy5pbmxpbmUucHVuY3R1YXRpb24uZXhlYyhwcmV2Q2hhcikpKSkgew0KICAgICAgY29uc3QgbExlbmd0aCA9IG1hdGNoWzBdLmxlbmd0aCAtIDE7DQogICAgICBsZXQgckRlbGltLCByTGVuZ3RoLCBkZWxpbVRvdGFsID0gbExlbmd0aCwgbWlkRGVsaW1Ub3RhbCA9IDA7DQoNCiAgICAgIGNvbnN0IGVuZFJlZyA9IG1hdGNoWzBdWzBdID09PSAnKicgPyB0aGlzLnJ1bGVzLmlubGluZS5lbVN0cm9uZy5yRGVsaW1Bc3QgOiB0aGlzLnJ1bGVzLmlubGluZS5lbVN0cm9uZy5yRGVsaW1VbmQ7DQogICAgICBlbmRSZWcubGFzdEluZGV4ID0gMDsNCg0KICAgICAgLy8gQ2xpcCBtYXNrZWRTcmMgdG8gc2FtZSBzZWN0aW9uIG9mIHN0cmluZyBhcyBzcmMgKG1vdmUgdG8gbGV4ZXI/KQ0KICAgICAgbWFza2VkU3JjID0gbWFza2VkU3JjLnNsaWNlKC0xICogc3JjLmxlbmd0aCArIGxMZW5ndGgpOw0KDQogICAgICB3aGlsZSAoKG1hdGNoID0gZW5kUmVnLmV4ZWMobWFza2VkU3JjKSkgIT0gbnVsbCkgew0KICAgICAgICByRGVsaW0gPSBtYXRjaFsxXSB8fCBtYXRjaFsyXSB8fCBtYXRjaFszXSB8fCBtYXRjaFs0XSB8fCBtYXRjaFs1XSB8fCBtYXRjaFs2XTsNCg0KICAgICAgICBpZiAoIXJEZWxpbSkgY29udGludWU7IC8vIHNraXAgc2luZ2xlICogaW4gX19hYmMqYWJjX18NCg0KICAgICAgICByTGVuZ3RoID0gckRlbGltLmxlbmd0aDsNCg0KICAgICAgICBpZiAobWF0Y2hbM10gfHwgbWF0Y2hbNF0pIHsgLy8gZm91bmQgYW5vdGhlciBMZWZ0IERlbGltDQogICAgICAgICAgZGVsaW1Ub3RhbCArPSByTGVuZ3RoOw0KICAgICAgICAgIGNvbnRpbnVlOw0KICAgICAgICB9IGVsc2UgaWYgKG1hdGNoWzVdIHx8IG1hdGNoWzZdKSB7IC8vIGVpdGhlciBMZWZ0IG9yIFJpZ2h0IERlbGltDQogICAgICAgICAgaWYgKGxMZW5ndGggJSAzICYmICEoKGxMZW5ndGggKyByTGVuZ3RoKSAlIDMpKSB7DQogICAgICAgICAgICBtaWREZWxpbVRvdGFsICs9IHJMZW5ndGg7DQogICAgICAgICAgICBjb250aW51ZTsgLy8gQ29tbW9uTWFyayBFbXBoYXNpcyBSdWxlcyA5LTEwDQogICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICAgICAgZGVsaW1Ub3RhbCAtPSByTGVuZ3RoOw0KDQogICAgICAgIGlmIChkZWxpbVRvdGFsID4gMCkgY29udGludWU7IC8vIEhhdmVuJ3QgZm91bmQgZW5vdWdoIGNsb3NpbmcgZGVsaW1pdGVycw0KDQogICAgICAgIC8vIFJlbW92ZSBleHRyYSBjaGFyYWN0ZXJzLiAqYSoqKiAtPiAqYSoNCiAgICAgICAgckxlbmd0aCA9IE1hdGgubWluKHJMZW5ndGgsIHJMZW5ndGggKyBkZWxpbVRvdGFsICsgbWlkRGVsaW1Ub3RhbCk7DQoNCiAgICAgICAgLy8gQ3JlYXRlIGBlbWAgaWYgc21hbGxlc3QgZGVsaW1pdGVyIGhhcyBvZGQgY2hhciBjb3VudC4gKmEqKioNCiAgICAgICAgaWYgKE1hdGgubWluKGxMZW5ndGgsIHJMZW5ndGgpICUgMikgew0KICAgICAgICAgIGNvbnN0IHRleHQgPSBzcmMuc2xpY2UoMSwgbExlbmd0aCArIG1hdGNoLmluZGV4ICsgckxlbmd0aCk7DQogICAgICAgICAgcmV0dXJuIHsNCiAgICAgICAgICAgIHR5cGU6ICdlbScsDQogICAgICAgICAgICByYXc6IHNyYy5zbGljZSgwLCBsTGVuZ3RoICsgbWF0Y2guaW5kZXggKyByTGVuZ3RoICsgMSksDQogICAgICAgICAgICB0ZXh0LA0KICAgICAgICAgICAgdG9rZW5zOiB0aGlzLmxleGVyLmlubGluZVRva2Vucyh0ZXh0LCBbXSkNCiAgICAgICAgICB9Ow0KICAgICAgICB9DQoNCiAgICAgICAgLy8gQ3JlYXRlICdzdHJvbmcnIGlmIHNtYWxsZXN0IGRlbGltaXRlciBoYXMgZXZlbiBjaGFyIGNvdW50LiAqKmEqKioNCiAgICAgICAgY29uc3QgdGV4dCA9IHNyYy5zbGljZSgyLCBsTGVuZ3RoICsgbWF0Y2guaW5kZXggKyByTGVuZ3RoIC0gMSk7DQogICAgICAgIHJldHVybiB7DQogICAgICAgICAgdHlwZTogJ3N0cm9uZycsDQogICAgICAgICAgcmF3OiBzcmMuc2xpY2UoMCwgbExlbmd0aCArIG1hdGNoLmluZGV4ICsgckxlbmd0aCArIDEpLA0KICAgICAgICAgIHRleHQsDQogICAgICAgICAgdG9rZW5zOiB0aGlzLmxleGVyLmlubGluZVRva2Vucyh0ZXh0LCBbXSkNCiAgICAgICAgfTsNCiAgICAgIH0NCiAgICB9DQogIH0NCg0KICBjb2Rlc3BhbihzcmMpIHsNCiAgICBjb25zdCBjYXAgPSB0aGlzLnJ1bGVzLmlubGluZS5jb2RlLmV4ZWMoc3JjKTsNCiAgICBpZiAoY2FwKSB7DQogICAgICBsZXQgdGV4dCA9IGNhcFsyXS5yZXBsYWNlKC9cbi9nLCAnICcpOw0KICAgICAgY29uc3QgaGFzTm9uU3BhY2VDaGFycyA9IC9bXiBdLy50ZXN0KHRleHQpOw0KICAgICAgY29uc3QgaGFzU3BhY2VDaGFyc09uQm90aEVuZHMgPSAvXiAvLnRlc3QodGV4dCkgJiYgLyAkLy50ZXN0KHRleHQpOw0KICAgICAgaWYgKGhhc05vblNwYWNlQ2hhcnMgJiYgaGFzU3BhY2VDaGFyc09uQm90aEVuZHMpIHsNCiAgICAgICAgdGV4dCA9IHRleHQuc3Vic3RyaW5nKDEsIHRleHQubGVuZ3RoIC0gMSk7DQogICAgICB9DQogICAgICB0ZXh0ID0gZXNjYXBlKHRleHQsIHRydWUpOw0KICAgICAgcmV0dXJuIHsNCiAgICAgICAgdHlwZTogJ2NvZGVzcGFuJywNCiAgICAgICAgcmF3OiBjYXBbMF0sDQogICAgICAgIHRleHQNCiAgICAgIH07DQogICAgfQ0KICB9DQoNCiAgYnIoc3JjKSB7DQogICAgY29uc3QgY2FwID0gdGhpcy5ydWxlcy5pbmxpbmUuYnIuZXhlYyhzcmMpOw0KICAgIGlmIChjYXApIHsNCiAgICAgIHJldHVybiB7DQogICAgICAgIHR5cGU6ICdicicsDQogICAgICAgIHJhdzogY2FwWzBdDQogICAgICB9Ow0KICAgIH0NCiAgfQ0KDQogIGRlbChzcmMpIHsNCiAgICBjb25zdCBjYXAgPSB0aGlzLnJ1bGVzLmlubGluZS5kZWwuZXhlYyhzcmMpOw0KICAgIGlmIChjYXApIHsNCiAgICAgIHJldHVybiB7DQogICAgICAgIHR5cGU6ICdkZWwnLA0KICAgICAgICByYXc6IGNhcFswXSwNCiAgICAgICAgdGV4dDogY2FwWzJdLA0KICAgICAgICB0b2tlbnM6IHRoaXMubGV4ZXIuaW5saW5lVG9rZW5zKGNhcFsyXSwgW10pDQogICAgICB9Ow0KICAgIH0NCiAgfQ0KDQogIGF1dG9saW5rKHNyYywgbWFuZ2xlKSB7DQogICAgY29uc3QgY2FwID0gdGhpcy5ydWxlcy5pbmxpbmUuYXV0b2xpbmsuZXhlYyhzcmMpOw0KICAgIGlmIChjYXApIHsNCiAgICAgIGxldCB0ZXh0LCBocmVmOw0KICAgICAgaWYgKGNhcFsyXSA9PT0gJ0AnKSB7DQogICAgICAgIHRleHQgPSBlc2NhcGUodGhpcy5vcHRpb25zLm1hbmdsZSA/IG1hbmdsZShjYXBbMV0pIDogY2FwWzFdKTsNCiAgICAgICAgaHJlZiA9ICdtYWlsdG86JyArIHRleHQ7DQogICAgICB9IGVsc2Ugew0KICAgICAgICB0ZXh0ID0gZXNjYXBlKGNhcFsxXSk7DQogICAgICAgIGhyZWYgPSB0ZXh0Ow0KICAgICAgfQ0KDQogICAgICByZXR1cm4gew0KICAgICAgICB0eXBlOiAnbGluaycsDQogICAgICAgIHJhdzogY2FwWzBdLA0KICAgICAgICB0ZXh0LA0KICAgICAgICBocmVmLA0KICAgICAgICB0b2tlbnM6IFsNCiAgICAgICAgICB7DQogICAgICAgICAgICB0eXBlOiAndGV4dCcsDQogICAgICAgICAgICByYXc6IHRleHQsDQogICAgICAgICAgICB0ZXh0DQogICAgICAgICAgfQ0KICAgICAgICBdDQogICAgICB9Ow0KICAgIH0NCiAgfQ0KDQogIHVybChzcmMsIG1hbmdsZSkgew0KICAgIGxldCBjYXA7DQogICAgaWYgKGNhcCA9IHRoaXMucnVsZXMuaW5saW5lLnVybC5leGVjKHNyYykpIHsNCiAgICAgIGxldCB0ZXh0LCBocmVmOw0KICAgICAgaWYgKGNhcFsyXSA9PT0gJ0AnKSB7DQogICAgICAgIHRleHQgPSBlc2NhcGUodGhpcy5vcHRpb25zLm1hbmdsZSA/IG1hbmdsZShjYXBbMF0pIDogY2FwWzBdKTsNCiAgICAgICAgaHJlZiA9ICdtYWlsdG86JyArIHRleHQ7DQogICAgICB9IGVsc2Ugew0KICAgICAgICAvLyBkbyBleHRlbmRlZCBhdXRvbGluayBwYXRoIHZhbGlkYXRpb24NCiAgICAgICAgbGV0IHByZXZDYXBaZXJvOw0KICAgICAgICBkbyB7DQogICAgICAgICAgcHJldkNhcFplcm8gPSBjYXBbMF07DQogICAgICAgICAgY2FwWzBdID0gdGhpcy5ydWxlcy5pbmxpbmUuX2JhY2twZWRhbC5leGVjKGNhcFswXSlbMF07DQogICAgICAgIH0gd2hpbGUgKHByZXZDYXBaZXJvICE9PSBjYXBbMF0pOw0KICAgICAgICB0ZXh0ID0gZXNjYXBlKGNhcFswXSk7DQogICAgICAgIGlmIChjYXBbMV0gPT09ICd3d3cuJykgew0KICAgICAgICAgIGhyZWYgPSAnaHR0cDovLycgKyB0ZXh0Ow0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIGhyZWYgPSB0ZXh0Ow0KICAgICAgICB9DQogICAgICB9DQogICAgICByZXR1cm4gew0KICAgICAgICB0eXBlOiAnbGluaycsDQogICAgICAgIHJhdzogY2FwWzBdLA0KICAgICAgICB0ZXh0LA0KICAgICAgICBocmVmLA0KICAgICAgICB0b2tlbnM6IFsNCiAgICAgICAgICB7DQogICAgICAgICAgICB0eXBlOiAndGV4dCcsDQogICAgICAgICAgICByYXc6IHRleHQsDQogICAgICAgICAgICB0ZXh0DQogICAgICAgICAgfQ0KICAgICAgICBdDQogICAgICB9Ow0KICAgIH0NCiAgfQ0KDQogIGlubGluZVRleHQoc3JjLCBzbWFydHlwYW50cykgew0KICAgIGNvbnN0IGNhcCA9IHRoaXMucnVsZXMuaW5saW5lLnRleHQuZXhlYyhzcmMpOw0KICAgIGlmIChjYXApIHsNCiAgICAgIGxldCB0ZXh0Ow0KICAgICAgaWYgKHRoaXMubGV4ZXIuc3RhdGUuaW5SYXdCbG9jaykgew0KICAgICAgICB0ZXh0ID0gdGhpcy5vcHRpb25zLnNhbml0aXplID8gKHRoaXMub3B0aW9ucy5zYW5pdGl6ZXIgPyB0aGlzLm9wdGlvbnMuc2FuaXRpemVyKGNhcFswXSkgOiBlc2NhcGUoY2FwWzBdKSkgOiBjYXBbMF07DQogICAgICB9IGVsc2Ugew0KICAgICAgICB0ZXh0ID0gZXNjYXBlKHRoaXMub3B0aW9ucy5zbWFydHlwYW50cyA/IHNtYXJ0eXBhbnRzKGNhcFswXSkgOiBjYXBbMF0pOw0KICAgICAgfQ0KICAgICAgcmV0dXJuIHsNCiAgICAgICAgdHlwZTogJ3RleHQnLA0KICAgICAgICByYXc6IGNhcFswXSwNCiAgICAgICAgdGV4dA0KICAgICAgfTsNCiAgICB9DQogIH0NCn0NCg0KLyoqDQogKiBCbG9jay1MZXZlbCBHcmFtbWFyDQogKi8NCmNvbnN0IGJsb2NrID0gew0KICBuZXdsaW5lOiAvXig/OiAqKD86XG58JCkpKy8sDQogIGNvZGU6IC9eKCB7NH1bXlxuXSsoPzpcbig/OiAqKD86XG58JCkpKik/KSsvLA0KICBmZW5jZXM6IC9eIHswLDN9KGB7Myx9KD89W15gXG5dKlxuKXx+ezMsfSkoW15cbl0qKVxuKD86fChbXHNcU10qPylcbikoPzogezAsM31cMVt+YF0qICooPz1cbnwkKXwkKS8sDQogIGhyOiAvXiB7MCwzfSgoPzotICopezMsfXwoPzpfICopezMsfXwoPzpcKiAqKXszLH0pKD86XG4rfCQpLywNCiAgaGVhZGluZzogL14gezAsM30oI3sxLDZ9KSg/PVxzfCQpKC4qKSg/OlxuK3wkKS8sDQogIGJsb2NrcXVvdGU6IC9eKCB7MCwzfT4gPyhwYXJhZ3JhcGh8W15cbl0qKSg/OlxufCQpKSsvLA0KICBsaXN0OiAvXiggezAsM31idWxsKSggW15cbl0rPyk/KD86XG58JCkvLA0KICBodG1sOiAnXiB7MCwzfSg/OicgLy8gb3B0aW9uYWwgaW5kZW50YXRpb24NCiAgICArICc8KHNjcmlwdHxwcmV8c3R5bGV8dGV4dGFyZWEpW1xccz5dW1xcc1xcU10qPyg/OjwvXFwxPlteXFxuXSpcXG4rfCQpJyAvLyAoMSkNCiAgICArICd8Y29tbWVudFteXFxuXSooXFxuK3wkKScgLy8gKDIpDQogICAgKyAnfDxcXD9bXFxzXFxTXSo/KD86XFw/Plxcbip8JCknIC8vICgzKQ0KICAgICsgJ3w8IVtBLVpdW1xcc1xcU10qPyg/Oj5cXG4qfCQpJyAvLyAoNCkNCiAgICArICd8PCFcXFtDREFUQVxcW1tcXHNcXFNdKj8oPzpcXF1cXF0+XFxuKnwkKScgLy8gKDUpDQogICAgKyAnfDwvPyh0YWcpKD86ICt8XFxufC8/PilbXFxzXFxTXSo/KD86KD86XFxuICopK1xcbnwkKScgLy8gKDYpDQogICAgKyAnfDwoPyFzY3JpcHR8cHJlfHN0eWxlfHRleHRhcmVhKShbYS16XVtcXHctXSopKD86YXR0cmlidXRlKSo/ICovPz4oPz1bIFxcdF0qKD86XFxufCQpKVtcXHNcXFNdKj8oPzooPzpcXG4gKikrXFxufCQpJyAvLyAoNykgb3BlbiB0YWcNCiAgICArICd8PC8oPyFzY3JpcHR8cHJlfHN0eWxlfHRleHRhcmVhKVthLXpdW1xcdy1dKlxccyo+KD89WyBcXHRdKig/OlxcbnwkKSlbXFxzXFxTXSo/KD86KD86XFxuICopK1xcbnwkKScgLy8gKDcpIGNsb3NpbmcgdGFnDQogICAgKyAnKScsDQogIGRlZjogL14gezAsM31cWyhsYWJlbClcXTogKig/OlxuICopPzw/KFteXHM+XSspPj8oPzooPzogKyg/OlxuICopP3wgKlxuICopKHRpdGxlKSk/ICooPzpcbit8JCkvLA0KICB0YWJsZTogbm9vcFRlc3QsDQogIGxoZWFkaW5nOiAvXihbXlxuXSspXG4gezAsM30oPSt8LSspICooPzpcbit8JCkvLA0KICAvLyByZWdleCB0ZW1wbGF0ZSwgcGxhY2Vob2xkZXJzIHdpbGwgYmUgcmVwbGFjZWQgYWNjb3JkaW5nIHRvIGRpZmZlcmVudCBwYXJhZ3JhcGgNCiAgLy8gaW50ZXJydXB0aW9uIHJ1bGVzIG9mIGNvbW1vbm1hcmsgYW5kIHRoZSBvcmlnaW5hbCBtYXJrZG93biBzcGVjOg0KICBfcGFyYWdyYXBoOiAvXihbXlxuXSsoPzpcbig/IWhyfGhlYWRpbmd8bGhlYWRpbmd8YmxvY2txdW90ZXxmZW5jZXN8bGlzdHxodG1sfHRhYmxlfCArXG4pW15cbl0rKSopLywNCiAgdGV4dDogL15bXlxuXSsvDQp9Ow0KDQpibG9jay5fbGFiZWwgPSAvKD8hXHMqXF0pKD86XFwufFteXFtcXVxcXSkrLzsNCmJsb2NrLl90aXRsZSA9IC8oPzoiKD86XFwiP3xbXiJcXF0pKiJ8J1teJ1xuXSooPzpcblteJ1xuXSspKlxuPyd8XChbXigpXSpcKSkvOw0KYmxvY2suZGVmID0gZWRpdChibG9jay5kZWYpDQogIC5yZXBsYWNlKCdsYWJlbCcsIGJsb2NrLl9sYWJlbCkNCiAgLnJlcGxhY2UoJ3RpdGxlJywgYmxvY2suX3RpdGxlKQ0KICAuZ2V0UmVnZXgoKTsNCg0KYmxvY2suYnVsbGV0ID0gLyg/OlsqKy1dfFxkezEsOX1bLildKS87DQpibG9jay5saXN0SXRlbVN0YXJ0ID0gZWRpdCgvXiggKikoYnVsbCkgKi8pDQogIC5yZXBsYWNlKCdidWxsJywgYmxvY2suYnVsbGV0KQ0KICAuZ2V0UmVnZXgoKTsNCg0KYmxvY2subGlzdCA9IGVkaXQoYmxvY2subGlzdCkNCiAgLnJlcGxhY2UoL2J1bGwvZywgYmxvY2suYnVsbGV0KQ0KICAucmVwbGFjZSgnaHInLCAnXFxuKyg/PVxcMT8oPzooPzotICopezMsfXwoPzpfICopezMsfXwoPzpcXCogKil7Myx9KSg/Olxcbit8JCkpJykNCiAgLnJlcGxhY2UoJ2RlZicsICdcXG4rKD89JyArIGJsb2NrLmRlZi5zb3VyY2UgKyAnKScpDQogIC5nZXRSZWdleCgpOw0KDQpibG9jay5fdGFnID0gJ2FkZHJlc3N8YXJ0aWNsZXxhc2lkZXxiYXNlfGJhc2Vmb250fGJsb2NrcXVvdGV8Ym9keXxjYXB0aW9uJw0KICArICd8Y2VudGVyfGNvbHxjb2xncm91cHxkZHxkZXRhaWxzfGRpYWxvZ3xkaXJ8ZGl2fGRsfGR0fGZpZWxkc2V0fGZpZ2NhcHRpb24nDQogICsgJ3xmaWd1cmV8Zm9vdGVyfGZvcm18ZnJhbWV8ZnJhbWVzZXR8aFsxLTZdfGhlYWR8aGVhZGVyfGhyfGh0bWx8aWZyYW1lJw0KICArICd8bGVnZW5kfGxpfGxpbmt8bWFpbnxtZW51fG1lbnVpdGVtfG1ldGF8bmF2fG5vZnJhbWVzfG9sfG9wdGdyb3VwfG9wdGlvbicNCiAgKyAnfHB8cGFyYW18c2VjdGlvbnxzb3VyY2V8c3VtbWFyeXx0YWJsZXx0Ym9keXx0ZHx0Zm9vdHx0aHx0aGVhZHx0aXRsZXx0cicNCiAgKyAnfHRyYWNrfHVsJzsNCmJsb2NrLl9jb21tZW50ID0gLzwhLS0oPyEtPz4pW1xzXFNdKj8oPzotLT58JCkvOw0KYmxvY2suaHRtbCA9IGVkaXQoYmxvY2suaHRtbCwgJ2knKQ0KICAucmVwbGFjZSgnY29tbWVudCcsIGJsb2NrLl9jb21tZW50KQ0KICAucmVwbGFjZSgndGFnJywgYmxvY2suX3RhZykNCiAgLnJlcGxhY2UoJ2F0dHJpYnV0ZScsIC8gK1thLXpBLVo6X11bXHcuOi1dKig/OiAqPSAqIlteIlxuXSoifCAqPSAqJ1teJ1xuXSonfCAqPSAqW15ccyInPTw+YF0rKT8vKQ0KICAuZ2V0UmVnZXgoKTsNCg0KYmxvY2sucGFyYWdyYXBoID0gZWRpdChibG9jay5fcGFyYWdyYXBoKQ0KICAucmVwbGFjZSgnaHInLCBibG9jay5ocikNCiAgLnJlcGxhY2UoJ2hlYWRpbmcnLCAnIHswLDN9I3sxLDZ9ICcpDQogIC5yZXBsYWNlKCd8bGhlYWRpbmcnLCAnJykgLy8gc2V0ZXggaGVhZGluZ3MgZG9uJ3QgaW50ZXJydXB0IGNvbW1vbm1hcmsgcGFyYWdyYXBocw0KICAucmVwbGFjZSgnfHRhYmxlJywgJycpDQogIC5yZXBsYWNlKCdibG9ja3F1b3RlJywgJyB7MCwzfT4nKQ0KICAucmVwbGFjZSgnZmVuY2VzJywgJyB7MCwzfSg/OmB7Myx9KD89W15gXFxuXSpcXG4pfH57Myx9KVteXFxuXSpcXG4nKQ0KICAucmVwbGFjZSgnbGlzdCcsICcgezAsM30oPzpbKistXXwxWy4pXSkgJykgLy8gb25seSBsaXN0cyBzdGFydGluZyBmcm9tIDEgY2FuIGludGVycnVwdA0KICAucmVwbGFjZSgnaHRtbCcsICc8Lz8oPzp0YWcpKD86ICt8XFxufC8/Pil8PCg/OnNjcmlwdHxwcmV8c3R5bGV8dGV4dGFyZWF8IS0tKScpDQogIC5yZXBsYWNlKCd0YWcnLCBibG9jay5fdGFnKSAvLyBwYXJzIGNhbiBiZSBpbnRlcnJ1cHRlZCBieSB0eXBlICg2KSBodG1sIGJsb2Nrcw0KICAuZ2V0UmVnZXgoKTsNCg0KYmxvY2suYmxvY2txdW90ZSA9IGVkaXQoYmxvY2suYmxvY2txdW90ZSkNCiAgLnJlcGxhY2UoJ3BhcmFncmFwaCcsIGJsb2NrLnBhcmFncmFwaCkNCiAgLmdldFJlZ2V4KCk7DQoNCi8qKg0KICogTm9ybWFsIEJsb2NrIEdyYW1tYXINCiAqLw0KDQpibG9jay5ub3JtYWwgPSBtZXJnZSh7fSwgYmxvY2spOw0KDQovKioNCiAqIEdGTSBCbG9jayBHcmFtbWFyDQogKi8NCg0KYmxvY2suZ2ZtID0gbWVyZ2Uoe30sIGJsb2NrLm5vcm1hbCwgew0KICB0YWJsZTogJ14gKihbXlxcbiBdLipcXHwuKilcXG4nIC8vIEhlYWRlcg0KICAgICsgJyB7MCwzfSg/OlxcfCAqKT8oOj8tKzo/ICooPzpcXHwgKjo/LSs6PyAqKSopKD86XFx8ICopPycgLy8gQWxpZ24NCiAgICArICcoPzpcXG4oKD86KD8hICpcXG58aHJ8aGVhZGluZ3xibG9ja3F1b3RlfGNvZGV8ZmVuY2VzfGxpc3R8aHRtbCkuKig/OlxcbnwkKSkqKVxcbip8JCknIC8vIENlbGxzDQp9KTsNCg0KYmxvY2suZ2ZtLnRhYmxlID0gZWRpdChibG9jay5nZm0udGFibGUpDQogIC5yZXBsYWNlKCdocicsIGJsb2NrLmhyKQ0KICAucmVwbGFjZSgnaGVhZGluZycsICcgezAsM30jezEsNn0gJykNCiAgLnJlcGxhY2UoJ2Jsb2NrcXVvdGUnLCAnIHswLDN9PicpDQogIC5yZXBsYWNlKCdjb2RlJywgJyB7NH1bXlxcbl0nKQ0KICAucmVwbGFjZSgnZmVuY2VzJywgJyB7MCwzfSg/OmB7Myx9KD89W15gXFxuXSpcXG4pfH57Myx9KVteXFxuXSpcXG4nKQ0KICAucmVwbGFjZSgnbGlzdCcsICcgezAsM30oPzpbKistXXwxWy4pXSkgJykgLy8gb25seSBsaXN0cyBzdGFydGluZyBmcm9tIDEgY2FuIGludGVycnVwdA0KICAucmVwbGFjZSgnaHRtbCcsICc8Lz8oPzp0YWcpKD86ICt8XFxufC8/Pil8PCg/OnNjcmlwdHxwcmV8c3R5bGV8dGV4dGFyZWF8IS0tKScpDQogIC5yZXBsYWNlKCd0YWcnLCBibG9jay5fdGFnKSAvLyB0YWJsZXMgY2FuIGJlIGludGVycnVwdGVkIGJ5IHR5cGUgKDYpIGh0bWwgYmxvY2tzDQogIC5nZXRSZWdleCgpOw0KDQpibG9jay5nZm0ucGFyYWdyYXBoID0gZWRpdChibG9jay5fcGFyYWdyYXBoKQ0KICAucmVwbGFjZSgnaHInLCBibG9jay5ocikNCiAgLnJlcGxhY2UoJ2hlYWRpbmcnLCAnIHswLDN9I3sxLDZ9ICcpDQogIC5yZXBsYWNlKCd8bGhlYWRpbmcnLCAnJykgLy8gc2V0ZXggaGVhZGluZ3MgZG9uJ3QgaW50ZXJydXB0IGNvbW1vbm1hcmsgcGFyYWdyYXBocw0KICAucmVwbGFjZSgndGFibGUnLCBibG9jay5nZm0udGFibGUpIC8vIGludGVycnVwdCBwYXJhZ3JhcGhzIHdpdGggdGFibGUNCiAgLnJlcGxhY2UoJ2Jsb2NrcXVvdGUnLCAnIHswLDN9PicpDQogIC5yZXBsYWNlKCdmZW5jZXMnLCAnIHswLDN9KD86YHszLH0oPz1bXmBcXG5dKlxcbil8fnszLH0pW15cXG5dKlxcbicpDQogIC5yZXBsYWNlKCdsaXN0JywgJyB7MCwzfSg/OlsqKy1dfDFbLildKSAnKSAvLyBvbmx5IGxpc3RzIHN0YXJ0aW5nIGZyb20gMSBjYW4gaW50ZXJydXB0DQogIC5yZXBsYWNlKCdodG1sJywgJzwvPyg/OnRhZykoPzogK3xcXG58Lz8+KXw8KD86c2NyaXB0fHByZXxzdHlsZXx0ZXh0YXJlYXwhLS0pJykNCiAgLnJlcGxhY2UoJ3RhZycsIGJsb2NrLl90YWcpIC8vIHBhcnMgY2FuIGJlIGludGVycnVwdGVkIGJ5IHR5cGUgKDYpIGh0bWwgYmxvY2tzDQogIC5nZXRSZWdleCgpOw0KLyoqDQogKiBQZWRhbnRpYyBncmFtbWFyIChvcmlnaW5hbCBKb2huIEdydWJlcidzIGxvb3NlIG1hcmtkb3duIHNwZWNpZmljYXRpb24pDQogKi8NCg0KYmxvY2sucGVkYW50aWMgPSBtZXJnZSh7fSwgYmxvY2subm9ybWFsLCB7DQogIGh0bWw6IGVkaXQoDQogICAgJ14gKig/OmNvbW1lbnQgKig/OlxcbnxcXHMqJCknDQogICAgKyAnfDwodGFnKVtcXHNcXFNdKz88L1xcMT4gKig/OlxcbnsyLH18XFxzKiQpJyAvLyBjbG9zZWQgdGFnDQogICAgKyAnfDx0YWcoPzoiW14iXSoifFwnW15cJ10qXCd8XFxzW15cJyIvPlxcc10qKSo/Lz8+ICooPzpcXG57Mix9fFxccyokKSknKQ0KICAgIC5yZXBsYWNlKCdjb21tZW50JywgYmxvY2suX2NvbW1lbnQpDQogICAgLnJlcGxhY2UoL3RhZy9nLCAnKD8hKD86Jw0KICAgICAgKyAnYXxlbXxzdHJvbmd8c21hbGx8c3xjaXRlfHF8ZGZufGFiYnJ8ZGF0YXx0aW1lfGNvZGV8dmFyfHNhbXB8a2JkfHN1YicNCiAgICAgICsgJ3xzdXB8aXxifHV8bWFya3xydWJ5fHJ0fHJwfGJkaXxiZG98c3Bhbnxicnx3YnJ8aW5zfGRlbHxpbWcpJw0KICAgICAgKyAnXFxiKVxcdysoPyE6fFteXFx3XFxzQF0qQClcXGInKQ0KICAgIC5nZXRSZWdleCgpLA0KICBkZWY6IC9eICpcWyhbXlxdXSspXF06ICo8PyhbXlxzPl0rKT4/KD86ICsoWyIoXVteXG5dK1siKV0pKT8gKig/OlxuK3wkKS8sDQogIGhlYWRpbmc6IC9eKCN7MSw2fSkoLiopKD86XG4rfCQpLywNCiAgZmVuY2VzOiBub29wVGVzdCwgLy8gZmVuY2VzIG5vdCBzdXBwb3J0ZWQNCiAgcGFyYWdyYXBoOiBlZGl0KGJsb2NrLm5vcm1hbC5fcGFyYWdyYXBoKQ0KICAgIC5yZXBsYWNlKCdocicsIGJsb2NrLmhyKQ0KICAgIC5yZXBsYWNlKCdoZWFkaW5nJywgJyAqI3sxLDZ9ICpbXlxuXScpDQogICAgLnJlcGxhY2UoJ2xoZWFkaW5nJywgYmxvY2subGhlYWRpbmcpDQogICAgLnJlcGxhY2UoJ2Jsb2NrcXVvdGUnLCAnIHswLDN9PicpDQogICAgLnJlcGxhY2UoJ3xmZW5jZXMnLCAnJykNCiAgICAucmVwbGFjZSgnfGxpc3QnLCAnJykNCiAgICAucmVwbGFjZSgnfGh0bWwnLCAnJykNCiAgICAuZ2V0UmVnZXgoKQ0KfSk7DQoNCi8qKg0KICogSW5saW5lLUxldmVsIEdyYW1tYXINCiAqLw0KY29uc3QgaW5saW5lID0gew0KICBlc2NhcGU6IC9eXFwoWyEiIyQlJicoKSorLFwtLi86Ozw9Pj9AXFtcXVxcXl9ge3x9fl0pLywNCiAgYXV0b2xpbms6IC9ePChzY2hlbWU6W15cc1x4MDAtXHgxZjw+XSp8ZW1haWwpPi8sDQogIHVybDogbm9vcFRlc3QsDQogIHRhZzogJ15jb21tZW50Jw0KICAgICsgJ3xePC9bYS16QS1aXVtcXHc6LV0qXFxzKj4nIC8vIHNlbGYtY2xvc2luZyB0YWcNCiAgICArICd8XjxbYS16QS1aXVtcXHctXSooPzphdHRyaWJ1dGUpKj9cXHMqLz8+JyAvLyBvcGVuIHRhZw0KICAgICsgJ3xePFxcP1tcXHNcXFNdKj9cXD8+JyAvLyBwcm9jZXNzaW5nIGluc3RydWN0aW9uLCBlLmcuIDw/cGhwID8+DQogICAgKyAnfF48IVthLXpBLVpdK1xcc1tcXHNcXFNdKj8+JyAvLyBkZWNsYXJhdGlvbiwgZS5nLiA8IURPQ1RZUEUgaHRtbD4NCiAgICArICd8XjwhXFxbQ0RBVEFcXFtbXFxzXFxTXSo/XFxdXFxdPicsIC8vIENEQVRBIHNlY3Rpb24NCiAgbGluazogL14hP1xbKGxhYmVsKVxdXChccyooaHJlZikoPzpccysodGl0bGUpKT9ccypcKS8sDQogIHJlZmxpbms6IC9eIT9cWyhsYWJlbClcXVxbKHJlZilcXS8sDQogIG5vbGluazogL14hP1xbKHJlZilcXSg/OlxbXF0pPy8sDQogIHJlZmxpbmtTZWFyY2g6ICdyZWZsaW5rfG5vbGluayg/IVxcKCknLA0KICBlbVN0cm9uZzogew0KICAgIGxEZWxpbTogL14oPzpcKisoPzooW3B1bmN0X10pfFteXHMqXSkpfF5fKyg/OihbcHVuY3QqXSl8KFteXHNfXSkpLywNCiAgICAvLyAgICAgICAgKDEpIGFuZCAoMikgY2FuIG9ubHkgYmUgYSBSaWdodCBEZWxpbWl0ZXIuICgzKSBhbmQgKDQpIGNhbiBvbmx5IGJlIExlZnQuICAoNSkgYW5kICg2KSBjYW4gYmUgZWl0aGVyIExlZnQgb3IgUmlnaHQuDQogICAgLy8gICAgICAgICgpIFNraXAgb3JwaGFuIGRlbGltIGluc2lkZSBzdHJvbmcgICAgKDEpICMqKiogICAgICAgICAgICAgICAgKDIpIGEqKiojLCBhKioqICAgICAgICAgICAgICAgICAgICgzKSAjKioqYSwgKioqYSAgICAgICAgICAgICAgICAgKDQpICoqKiMgICAgICAgICAgICAgICg1KSAjKioqIyAgICAgICAgICAgICAgICAgKDYpIGEqKiphDQogICAgckRlbGltQXN0OiAvXlteXypdKj9cX1xfW15fKl0qP1wqW15fKl0qPyg/PVxfXF8pfFtwdW5jdF9dKFwqKykoPz1bXHNdfCQpfFtecHVuY3QqX1xzXShcKispKD89W3B1bmN0X1xzXXwkKXxbcHVuY3RfXHNdKFwqKykoPz1bXnB1bmN0Kl9cc10pfFtcc10oXCorKSg/PVtwdW5jdF9dKXxbcHVuY3RfXShcKispKD89W3B1bmN0X10pfFtecHVuY3QqX1xzXShcKispKD89W15wdW5jdCpfXHNdKS8sDQogICAgckRlbGltVW5kOiAvXlteXypdKj9cKlwqW15fKl0qP1xfW15fKl0qPyg/PVwqXCopfFtwdW5jdCpdKFxfKykoPz1bXHNdfCQpfFtecHVuY3QqX1xzXShcXyspKD89W3B1bmN0KlxzXXwkKXxbcHVuY3QqXHNdKFxfKykoPz1bXnB1bmN0Kl9cc10pfFtcc10oXF8rKSg/PVtwdW5jdCpdKXxbcHVuY3QqXShcXyspKD89W3B1bmN0Kl0pLyAvLyBeLSBOb3QgYWxsb3dlZCBmb3IgXw0KICB9LA0KICBjb2RlOiAvXihgKykoW15gXXxbXmBdW1xzXFNdKj9bXmBdKVwxKD8hYCkvLA0KICBicjogL14oIHsyLH18XFwpXG4oPyFccyokKS8sDQogIGRlbDogbm9vcFRlc3QsDQogIHRleHQ6IC9eKGArfFteYF0pKD86KD89IHsyLH1cbil8W1xzXFNdKj8oPzooPz1bXFw8IVxbYCpfXXxcYl98JCl8W14gXSg/PSB7Mix9XG4pKSkvLA0KICBwdW5jdHVhdGlvbjogL14oW1xzcHVuY3R1YXRpb25dKS8NCn07DQoNCi8vIGxpc3Qgb2YgcHVuY3R1YXRpb24gbWFya3MgZnJvbSBDb21tb25NYXJrIHNwZWMNCi8vIHdpdGhvdXQgKiBhbmQgXyB0byBoYW5kbGUgdGhlIGRpZmZlcmVudCBlbXBoYXNpcyBtYXJrZXJzICogYW5kIF8NCmlubGluZS5fcHVuY3R1YXRpb24gPSAnISIjJCUmXCcoKStcXC0uLC86Ozw9Pj9AXFxbXFxdYF57fH1+JzsNCmlubGluZS5wdW5jdHVhdGlvbiA9IGVkaXQoaW5saW5lLnB1bmN0dWF0aW9uKS5yZXBsYWNlKC9wdW5jdHVhdGlvbi9nLCBpbmxpbmUuX3B1bmN0dWF0aW9uKS5nZXRSZWdleCgpOw0KDQovLyBzZXF1ZW5jZXMgZW0gc2hvdWxkIHNraXAgb3ZlciBbdGl0bGVdKGxpbmspLCBgY29kZWAsIDxodG1sPg0KaW5saW5lLmJsb2NrU2tpcCA9IC9cW1teXF1dKj9cXVwoW15cKV0qP1wpfGBbXmBdKj9gfDxbXj5dKj8+L2c7DQppbmxpbmUuZXNjYXBlZEVtU3QgPSAvXFxcKnxcXF8vZzsNCg0KaW5saW5lLl9jb21tZW50ID0gZWRpdChibG9jay5fY29tbWVudCkucmVwbGFjZSgnKD86LS0+fCQpJywgJy0tPicpLmdldFJlZ2V4KCk7DQoNCmlubGluZS5lbVN0cm9uZy5sRGVsaW0gPSBlZGl0KGlubGluZS5lbVN0cm9uZy5sRGVsaW0pDQogIC5yZXBsYWNlKC9wdW5jdC9nLCBpbmxpbmUuX3B1bmN0dWF0aW9uKQ0KICAuZ2V0UmVnZXgoKTsNCg0KaW5saW5lLmVtU3Ryb25nLnJEZWxpbUFzdCA9IGVkaXQoaW5saW5lLmVtU3Ryb25nLnJEZWxpbUFzdCwgJ2cnKQ0KICAucmVwbGFjZSgvcHVuY3QvZywgaW5saW5lLl9wdW5jdHVhdGlvbikNCiAgLmdldFJlZ2V4KCk7DQoNCmlubGluZS5lbVN0cm9uZy5yRGVsaW1VbmQgPSBlZGl0KGlubGluZS5lbVN0cm9uZy5yRGVsaW1VbmQsICdnJykNCiAgLnJlcGxhY2UoL3B1bmN0L2csIGlubGluZS5fcHVuY3R1YXRpb24pDQogIC5nZXRSZWdleCgpOw0KDQppbmxpbmUuX2VzY2FwZXMgPSAvXFwoWyEiIyQlJicoKSorLFwtLi86Ozw9Pj9AXFtcXVxcXl9ge3x9fl0pL2c7DQoNCmlubGluZS5fc2NoZW1lID0gL1thLXpBLVpdW2EtekEtWjAtOSsuLV17MSwzMX0vOw0KaW5saW5lLl9lbWFpbCA9IC9bYS16QS1aMC05LiEjJCUmJyorLz0/Xl9ge3x9fi1dKyhAKVthLXpBLVowLTldKD86W2EtekEtWjAtOS1dezAsNjF9W2EtekEtWjAtOV0pPyg/OlwuW2EtekEtWjAtOV0oPzpbYS16QS1aMC05LV17MCw2MX1bYS16QS1aMC05XSk/KSsoPyFbLV9dKS87DQppbmxpbmUuYXV0b2xpbmsgPSBlZGl0KGlubGluZS5hdXRvbGluaykNCiAgLnJlcGxhY2UoJ3NjaGVtZScsIGlubGluZS5fc2NoZW1lKQ0KICAucmVwbGFjZSgnZW1haWwnLCBpbmxpbmUuX2VtYWlsKQ0KICAuZ2V0UmVnZXgoKTsNCg0KaW5saW5lLl9hdHRyaWJ1dGUgPSAvXHMrW2EtekEtWjpfXVtcdy46LV0qKD86XHMqPVxzKiJbXiJdKiJ8XHMqPVxzKidbXiddKid8XHMqPVxzKlteXHMiJz08PmBdKyk/LzsNCg0KaW5saW5lLnRhZyA9IGVkaXQoaW5saW5lLnRhZykNCiAgLnJlcGxhY2UoJ2NvbW1lbnQnLCBpbmxpbmUuX2NvbW1lbnQpDQogIC5yZXBsYWNlKCdhdHRyaWJ1dGUnLCBpbmxpbmUuX2F0dHJpYnV0ZSkNCiAgLmdldFJlZ2V4KCk7DQoNCmlubGluZS5fbGFiZWwgPSAvKD86XFsoPzpcXC58W15cW1xdXFxdKSpcXXxcXC58YFteYF0qYHxbXlxbXF1cXGBdKSo/LzsNCmlubGluZS5faHJlZiA9IC88KD86XFwufFteXG48PlxcXSkrPnxbXlxzXHgwMC1ceDFmXSovOw0KaW5saW5lLl90aXRsZSA9IC8iKD86XFwiP3xbXiJcXF0pKiJ8Jyg/OlxcJz98W14nXFxdKSonfFwoKD86XFxcKT98W14pXFxdKSpcKS87DQoNCmlubGluZS5saW5rID0gZWRpdChpbmxpbmUubGluaykNCiAgLnJlcGxhY2UoJ2xhYmVsJywgaW5saW5lLl9sYWJlbCkNCiAgLnJlcGxhY2UoJ2hyZWYnLCBpbmxpbmUuX2hyZWYpDQogIC5yZXBsYWNlKCd0aXRsZScsIGlubGluZS5fdGl0bGUpDQogIC5nZXRSZWdleCgpOw0KDQppbmxpbmUucmVmbGluayA9IGVkaXQoaW5saW5lLnJlZmxpbmspDQogIC5yZXBsYWNlKCdsYWJlbCcsIGlubGluZS5fbGFiZWwpDQogIC5yZXBsYWNlKCdyZWYnLCBibG9jay5fbGFiZWwpDQogIC5nZXRSZWdleCgpOw0KDQppbmxpbmUubm9saW5rID0gZWRpdChpbmxpbmUubm9saW5rKQ0KICAucmVwbGFjZSgncmVmJywgYmxvY2suX2xhYmVsKQ0KICAuZ2V0UmVnZXgoKTsNCg0KaW5saW5lLnJlZmxpbmtTZWFyY2ggPSBlZGl0KGlubGluZS5yZWZsaW5rU2VhcmNoLCAnZycpDQogIC5yZXBsYWNlKCdyZWZsaW5rJywgaW5saW5lLnJlZmxpbmspDQogIC5yZXBsYWNlKCdub2xpbmsnLCBpbmxpbmUubm9saW5rKQ0KICAuZ2V0UmVnZXgoKTsNCg0KLyoqDQogKiBOb3JtYWwgSW5saW5lIEdyYW1tYXINCiAqLw0KDQppbmxpbmUubm9ybWFsID0gbWVyZ2Uoe30sIGlubGluZSk7DQoNCi8qKg0KICogUGVkYW50aWMgSW5saW5lIEdyYW1tYXINCiAqLw0KDQppbmxpbmUucGVkYW50aWMgPSBtZXJnZSh7fSwgaW5saW5lLm5vcm1hbCwgew0KICBzdHJvbmc6IHsNCiAgICBzdGFydDogL15fX3xcKlwqLywNCiAgICBtaWRkbGU6IC9eX18oPz1cUykoW1xzXFNdKj9cUylfXyg/IV8pfF5cKlwqKD89XFMpKFtcc1xTXSo/XFMpXCpcKig/IVwqKS8sDQogICAgZW5kQXN0OiAvXCpcKig/IVwqKS9nLA0KICAgIGVuZFVuZDogL19fKD8hXykvZw0KICB9LA0KICBlbTogew0KICAgIHN0YXJ0OiAvXl98XCovLA0KICAgIG1pZGRsZTogL14oKVwqKD89XFMpKFtcc1xTXSo/XFMpXCooPyFcKil8Xl8oPz1cUykoW1xzXFNdKj9cUylfKD8hXykvLA0KICAgIGVuZEFzdDogL1wqKD8hXCopL2csDQogICAgZW5kVW5kOiAvXyg/IV8pL2cNCiAgfSwNCiAgbGluazogZWRpdCgvXiE/XFsobGFiZWwpXF1cKCguKj8pXCkvKQ0KICAgIC5yZXBsYWNlKCdsYWJlbCcsIGlubGluZS5fbGFiZWwpDQogICAgLmdldFJlZ2V4KCksDQogIHJlZmxpbms6IGVkaXQoL14hP1xbKGxhYmVsKVxdXHMqXFsoW15cXV0qKVxdLykNCiAgICAucmVwbGFjZSgnbGFiZWwnLCBpbmxpbmUuX2xhYmVsKQ0KICAgIC5nZXRSZWdleCgpDQp9KTsNCg0KLyoqDQogKiBHRk0gSW5saW5lIEdyYW1tYXINCiAqLw0KDQppbmxpbmUuZ2ZtID0gbWVyZ2Uoe30sIGlubGluZS5ub3JtYWwsIHsNCiAgZXNjYXBlOiBlZGl0KGlubGluZS5lc2NhcGUpLnJlcGxhY2UoJ10pJywgJ358XSknKS5nZXRSZWdleCgpLA0KICBfZXh0ZW5kZWRfZW1haWw6IC9bQS1aYS16MC05Ll8rLV0rKEApW2EtekEtWjAtOS1fXSsoPzpcLlthLXpBLVowLTktX10qW2EtekEtWjAtOV0pKyg/IVstX10pLywNCiAgdXJsOiAvXigoPzpmdHB8aHR0cHM/KTpcL1wvfHd3d1wuKSg/OlthLXpBLVowLTlcLV0rXC4/KStbXlxzPF0qfF5lbWFpbC8sDQogIF9iYWNrcGVkYWw6IC8oPzpbXj8hLiw6OypffigpJl0rfFwoW14pXSpcKXwmKD8hW2EtekEtWjAtOV0rOyQpfFs/IS4sOjsqX34pXSsoPyEkKSkrLywNCiAgZGVsOiAvXih+fj8pKD89W15cc35dKShbXHNcU10qP1teXHN+XSlcMSg/PVtefl18JCkvLA0KICB0ZXh0OiAvXihbYH5dK3xbXmB+XSkoPzooPz0gezIsfVxuKXwoPz1bYS16QS1aMC05LiEjJCUmJyorXC89P19ge1x8fX4tXStAKXxbXHNcU10qPyg/Oig/PVtcXDwhXFtgKn5fXXxcYl98aHR0cHM/OlwvXC98ZnRwOlwvXC98d3d3XC58JCl8W14gXSg/PSB7Mix9XG4pfFteYS16QS1aMC05LiEjJCUmJyorXC89P19ge1x8fX4tXSg/PVthLXpBLVowLTkuISMkJSYnKitcLz0/X2B7XHx9fi1dK0ApKSkvDQp9KTsNCg0KaW5saW5lLmdmbS51cmwgPSBlZGl0KGlubGluZS5nZm0udXJsLCAnaScpDQogIC5yZXBsYWNlKCdlbWFpbCcsIGlubGluZS5nZm0uX2V4dGVuZGVkX2VtYWlsKQ0KICAuZ2V0UmVnZXgoKTsNCi8qKg0KICogR0ZNICsgTGluZSBCcmVha3MgSW5saW5lIEdyYW1tYXINCiAqLw0KDQppbmxpbmUuYnJlYWtzID0gbWVyZ2Uoe30sIGlubGluZS5nZm0sIHsNCiAgYnI6IGVkaXQoaW5saW5lLmJyKS5yZXBsYWNlKCd7Mix9JywgJyonKS5nZXRSZWdleCgpLA0KICB0ZXh0OiBlZGl0KGlubGluZS5nZm0udGV4dCkNCiAgICAucmVwbGFjZSgnXFxiXycsICdcXGJffCB7Mix9XFxuJykNCiAgICAucmVwbGFjZSgvXHsyLFx9L2csICcqJykNCiAgICAuZ2V0UmVnZXgoKQ0KfSk7DQoNCi8qKg0KICogc21hcnR5cGFudHMgdGV4dCByZXBsYWNlbWVudA0KICovDQpmdW5jdGlvbiBzbWFydHlwYW50cyh0ZXh0KSB7DQogIHJldHVybiB0ZXh0DQogICAgLy8gZW0tZGFzaGVzDQogICAgLnJlcGxhY2UoLy0tLS9nLCAnXHUyMDE0JykNCiAgICAvLyBlbi1kYXNoZXMNCiAgICAucmVwbGFjZSgvLS0vZywgJ1x1MjAxMycpDQogICAgLy8gb3BlbmluZyBzaW5nbGVzDQogICAgLnJlcGxhY2UoLyhefFstXHUyMDE0LyhcW3siXHNdKScvZywgJyQxXHUyMDE4JykNCiAgICAvLyBjbG9zaW5nIHNpbmdsZXMgJiBhcG9zdHJvcGhlcw0KICAgIC5yZXBsYWNlKC8nL2csICdcdTIwMTknKQ0KICAgIC8vIG9wZW5pbmcgZG91Ymxlcw0KICAgIC5yZXBsYWNlKC8oXnxbLVx1MjAxNC8oXFt7XHUyMDE4XHNdKSIvZywgJyQxXHUyMDFjJykNCiAgICAvLyBjbG9zaW5nIGRvdWJsZXMNCiAgICAucmVwbGFjZSgvIi9nLCAnXHUyMDFkJykNCiAgICAvLyBlbGxpcHNlcw0KICAgIC5yZXBsYWNlKC9cLnszfS9nLCAnXHUyMDI2Jyk7DQp9DQoNCi8qKg0KICogbWFuZ2xlIGVtYWlsIGFkZHJlc3Nlcw0KICovDQpmdW5jdGlvbiBtYW5nbGUodGV4dCkgew0KICBsZXQgb3V0ID0gJycsDQogICAgaSwNCiAgICBjaDsNCg0KICBjb25zdCBsID0gdGV4dC5sZW5ndGg7DQogIGZvciAoaSA9IDA7IGkgPCBsOyBpKyspIHsNCiAgICBjaCA9IHRleHQuY2hhckNvZGVBdChpKTsNCiAgICBpZiAoTWF0aC5yYW5kb20oKSA+IDAuNSkgew0KICAgICAgY2ggPSAneCcgKyBjaC50b1N0cmluZygxNik7DQogICAgfQ0KICAgIG91dCArPSAnJiMnICsgY2ggKyAnOyc7DQogIH0NCg0KICByZXR1cm4gb3V0Ow0KfQ0KDQovKioNCiAqIEJsb2NrIExleGVyDQogKi8NCmNsYXNzIExleGVyIHsNCiAgY29uc3RydWN0b3Iob3B0aW9ucykgew0KICAgIHRoaXMudG9rZW5zID0gW107DQogICAgdGhpcy50b2tlbnMubGlua3MgPSBPYmplY3QuY3JlYXRlKG51bGwpOw0KICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwgZGVmYXVsdHM7DQogICAgdGhpcy5vcHRpb25zLnRva2VuaXplciA9IHRoaXMub3B0aW9ucy50b2tlbml6ZXIgfHwgbmV3IFRva2VuaXplcigpOw0KICAgIHRoaXMudG9rZW5pemVyID0gdGhpcy5vcHRpb25zLnRva2VuaXplcjsNCiAgICB0aGlzLnRva2VuaXplci5vcHRpb25zID0gdGhpcy5vcHRpb25zOw0KICAgIHRoaXMudG9rZW5pemVyLmxleGVyID0gdGhpczsNCiAgICB0aGlzLmlubGluZVF1ZXVlID0gW107DQogICAgdGhpcy5zdGF0ZSA9IHsNCiAgICAgIGluTGluazogZmFsc2UsDQogICAgICBpblJhd0Jsb2NrOiBmYWxzZSwNCiAgICAgIHRvcDogdHJ1ZQ0KICAgIH07DQoNCiAgICBjb25zdCBydWxlcyA9IHsNCiAgICAgIGJsb2NrOiBibG9jay5ub3JtYWwsDQogICAgICBpbmxpbmU6IGlubGluZS5ub3JtYWwNCiAgICB9Ow0KDQogICAgaWYgKHRoaXMub3B0aW9ucy5wZWRhbnRpYykgew0KICAgICAgcnVsZXMuYmxvY2sgPSBibG9jay5wZWRhbnRpYzsNCiAgICAgIHJ1bGVzLmlubGluZSA9IGlubGluZS5wZWRhbnRpYzsNCiAgICB9IGVsc2UgaWYgKHRoaXMub3B0aW9ucy5nZm0pIHsNCiAgICAgIHJ1bGVzLmJsb2NrID0gYmxvY2suZ2ZtOw0KICAgICAgaWYgKHRoaXMub3B0aW9ucy5icmVha3MpIHsNCiAgICAgICAgcnVsZXMuaW5saW5lID0gaW5saW5lLmJyZWFrczsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHJ1bGVzLmlubGluZSA9IGlubGluZS5nZm07DQogICAgICB9DQogICAgfQ0KICAgIHRoaXMudG9rZW5pemVyLnJ1bGVzID0gcnVsZXM7DQogIH0NCg0KICAvKioNCiAgICogRXhwb3NlIFJ1bGVzDQogICAqLw0KICBzdGF0aWMgZ2V0IHJ1bGVzKCkgew0KICAgIHJldHVybiB7DQogICAgICBibG9jaywNCiAgICAgIGlubGluZQ0KICAgIH07DQogIH0NCg0KICAvKioNCiAgICogU3RhdGljIExleCBNZXRob2QNCiAgICovDQogIHN0YXRpYyBsZXgoc3JjLCBvcHRpb25zKSB7DQogICAgY29uc3QgbGV4ZXIgPSBuZXcgTGV4ZXIob3B0aW9ucyk7DQogICAgcmV0dXJuIGxleGVyLmxleChzcmMpOw0KICB9DQoNCiAgLyoqDQogICAqIFN0YXRpYyBMZXggSW5saW5lIE1ldGhvZA0KICAgKi8NCiAgc3RhdGljIGxleElubGluZShzcmMsIG9wdGlvbnMpIHsNCiAgICBjb25zdCBsZXhlciA9IG5ldyBMZXhlcihvcHRpb25zKTsNCiAgICByZXR1cm4gbGV4ZXIuaW5saW5lVG9rZW5zKHNyYyk7DQogIH0NCg0KICAvKioNCiAgICogUHJlcHJvY2Vzc2luZw0KICAgKi8NCiAgbGV4KHNyYykgew0KICAgIHNyYyA9IHNyYw0KICAgICAgLnJlcGxhY2UoL1xyXG58XHIvZywgJ1xuJykNCiAgICAgIC5yZXBsYWNlKC9cdC9nLCAnICAgICcpOw0KDQogICAgdGhpcy5ibG9ja1Rva2VucyhzcmMsIHRoaXMudG9rZW5zKTsNCg0KICAgIGxldCBuZXh0Ow0KICAgIHdoaWxlIChuZXh0ID0gdGhpcy5pbmxpbmVRdWV1ZS5zaGlmdCgpKSB7DQogICAgICB0aGlzLmlubGluZVRva2VucyhuZXh0LnNyYywgbmV4dC50b2tlbnMpOw0KICAgIH0NCg0KICAgIHJldHVybiB0aGlzLnRva2VuczsNCiAgfQ0KDQogIC8qKg0KICAgKiBMZXhpbmcNCiAgICovDQogIGJsb2NrVG9rZW5zKHNyYywgdG9rZW5zID0gW10pIHsNCiAgICBpZiAodGhpcy5vcHRpb25zLnBlZGFudGljKSB7DQogICAgICBzcmMgPSBzcmMucmVwbGFjZSgvXiArJC9nbSwgJycpOw0KICAgIH0NCiAgICBsZXQgdG9rZW4sIGxhc3RUb2tlbiwgY3V0U3JjLCBsYXN0UGFyYWdyYXBoQ2xpcHBlZDsNCg0KICAgIHdoaWxlIChzcmMpIHsNCiAgICAgIGlmICh0aGlzLm9wdGlvbnMuZXh0ZW5zaW9ucw0KICAgICAgICAmJiB0aGlzLm9wdGlvbnMuZXh0ZW5zaW9ucy5ibG9jaw0KICAgICAgICAmJiB0aGlzLm9wdGlvbnMuZXh0ZW5zaW9ucy5ibG9jay5zb21lKChleHRUb2tlbml6ZXIpID0+IHsNCiAgICAgICAgICBpZiAodG9rZW4gPSBleHRUb2tlbml6ZXIuY2FsbCh7IGxleGVyOiB0aGlzIH0sIHNyYywgdG9rZW5zKSkgew0KICAgICAgICAgICAgc3JjID0gc3JjLnN1YnN0cmluZyh0b2tlbi5yYXcubGVuZ3RoKTsNCiAgICAgICAgICAgIHRva2Vucy5wdXNoKHRva2VuKTsNCiAgICAgICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgICAgIH0NCiAgICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICAgIH0pKSB7DQogICAgICAgIGNvbnRpbnVlOw0KICAgICAgfQ0KDQogICAgICAvLyBuZXdsaW5lDQogICAgICBpZiAodG9rZW4gPSB0aGlzLnRva2VuaXplci5zcGFjZShzcmMpKSB7DQogICAgICAgIHNyYyA9IHNyYy5zdWJzdHJpbmcodG9rZW4ucmF3Lmxlbmd0aCk7DQogICAgICAgIGlmICh0b2tlbi5yYXcubGVuZ3RoID09PSAxICYmIHRva2Vucy5sZW5ndGggPiAwKSB7DQogICAgICAgICAgLy8gaWYgdGhlcmUncyBhIHNpbmdsZSBcbiBhcyBhIHNwYWNlciwgaXQncyB0ZXJtaW5hdGluZyB0aGUgbGFzdCBsaW5lLA0KICAgICAgICAgIC8vIHNvIG1vdmUgaXQgdGhlcmUgc28gdGhhdCB3ZSBkb24ndCBnZXQgdW5lY2Vzc2FyeSBwYXJhZ3JhcGggdGFncw0KICAgICAgICAgIHRva2Vuc1t0b2tlbnMubGVuZ3RoIC0gMV0ucmF3ICs9ICdcbic7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgdG9rZW5zLnB1c2godG9rZW4pOw0KICAgICAgICB9DQogICAgICAgIGNvbnRpbnVlOw0KICAgICAgfQ0KDQogICAgICAvLyBjb2RlDQogICAgICBpZiAodG9rZW4gPSB0aGlzLnRva2VuaXplci5jb2RlKHNyYykpIHsNCiAgICAgICAgc3JjID0gc3JjLnN1YnN0cmluZyh0b2tlbi5yYXcubGVuZ3RoKTsNCiAgICAgICAgbGFzdFRva2VuID0gdG9rZW5zW3Rva2Vucy5sZW5ndGggLSAxXTsNCiAgICAgICAgLy8gQW4gaW5kZW50ZWQgY29kZSBibG9jayBjYW5ub3QgaW50ZXJydXB0IGEgcGFyYWdyYXBoLg0KICAgICAgICBpZiAobGFzdFRva2VuICYmIChsYXN0VG9rZW4udHlwZSA9PT0gJ3BhcmFncmFwaCcgfHwgbGFzdFRva2VuLnR5cGUgPT09ICd0ZXh0JykpIHsNCiAgICAgICAgICBsYXN0VG9rZW4ucmF3ICs9ICdcbicgKyB0b2tlbi5yYXc7DQogICAgICAgICAgbGFzdFRva2VuLnRleHQgKz0gJ1xuJyArIHRva2VuLnRleHQ7DQogICAgICAgICAgdGhpcy5pbmxpbmVRdWV1ZVt0aGlzLmlubGluZVF1ZXVlLmxlbmd0aCAtIDFdLnNyYyA9IGxhc3RUb2tlbi50ZXh0Ow0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHRva2Vucy5wdXNoKHRva2VuKTsNCiAgICAgICAgfQ0KICAgICAgICBjb250aW51ZTsNCiAgICAgIH0NCg0KICAgICAgLy8gZmVuY2VzDQogICAgICBpZiAodG9rZW4gPSB0aGlzLnRva2VuaXplci5mZW5jZXMoc3JjKSkgew0KICAgICAgICBzcmMgPSBzcmMuc3Vic3RyaW5nKHRva2VuLnJhdy5sZW5ndGgpOw0KICAgICAgICB0b2tlbnMucHVzaCh0b2tlbik7DQogICAgICAgIGNvbnRpbnVlOw0KICAgICAgfQ0KDQogICAgICAvLyBoZWFkaW5nDQogICAgICBpZiAodG9rZW4gPSB0aGlzLnRva2VuaXplci5oZWFkaW5nKHNyYykpIHsNCiAgICAgICAgc3JjID0gc3JjLnN1YnN0cmluZyh0b2tlbi5yYXcubGVuZ3RoKTsNCiAgICAgICAgdG9rZW5zLnB1c2godG9rZW4pOw0KICAgICAgICBjb250aW51ZTsNCiAgICAgIH0NCg0KICAgICAgLy8gaHINCiAgICAgIGlmICh0b2tlbiA9IHRoaXMudG9rZW5pemVyLmhyKHNyYykpIHsNCiAgICAgICAgc3JjID0gc3JjLnN1YnN0cmluZyh0b2tlbi5yYXcubGVuZ3RoKTsNCiAgICAgICAgdG9rZW5zLnB1c2godG9rZW4pOw0KICAgICAgICBjb250aW51ZTsNCiAgICAgIH0NCg0KICAgICAgLy8gYmxvY2txdW90ZQ0KICAgICAgaWYgKHRva2VuID0gdGhpcy50b2tlbml6ZXIuYmxvY2txdW90ZShzcmMpKSB7DQogICAgICAgIHNyYyA9IHNyYy5zdWJzdHJpbmcodG9rZW4ucmF3Lmxlbmd0aCk7DQogICAgICAgIHRva2Vucy5wdXNoKHRva2VuKTsNCiAgICAgICAgY29udGludWU7DQogICAgICB9DQoNCiAgICAgIC8vIGxpc3QNCiAgICAgIGlmICh0b2tlbiA9IHRoaXMudG9rZW5pemVyLmxpc3Qoc3JjKSkgew0KICAgICAgICBzcmMgPSBzcmMuc3Vic3RyaW5nKHRva2VuLnJhdy5sZW5ndGgpOw0KICAgICAgICB0b2tlbnMucHVzaCh0b2tlbik7DQogICAgICAgIGNvbnRpbnVlOw0KICAgICAgfQ0KDQogICAgICAvLyBodG1sDQogICAgICBpZiAodG9rZW4gPSB0aGlzLnRva2VuaXplci5odG1sKHNyYykpIHsNCiAgICAgICAgc3JjID0gc3JjLnN1YnN0cmluZyh0b2tlbi5yYXcubGVuZ3RoKTsNCiAgICAgICAgdG9rZW5zLnB1c2godG9rZW4pOw0KICAgICAgICBjb250aW51ZTsNCiAgICAgIH0NCg0KICAgICAgLy8gZGVmDQogICAgICBpZiAodG9rZW4gPSB0aGlzLnRva2VuaXplci5kZWYoc3JjKSkgew0KICAgICAgICBzcmMgPSBzcmMuc3Vic3RyaW5nKHRva2VuLnJhdy5sZW5ndGgpOw0KICAgICAgICBsYXN0VG9rZW4gPSB0b2tlbnNbdG9rZW5zLmxlbmd0aCAtIDFdOw0KICAgICAgICBpZiAobGFzdFRva2VuICYmIChsYXN0VG9rZW4udHlwZSA9PT0gJ3BhcmFncmFwaCcgfHwgbGFzdFRva2VuLnR5cGUgPT09ICd0ZXh0JykpIHsNCiAgICAgICAgICBsYXN0VG9rZW4ucmF3ICs9ICdcbicgKyB0b2tlbi5yYXc7DQogICAgICAgICAgbGFzdFRva2VuLnRleHQgKz0gJ1xuJyArIHRva2VuLnJhdzsNCiAgICAgICAgICB0aGlzLmlubGluZVF1ZXVlW3RoaXMuaW5saW5lUXVldWUubGVuZ3RoIC0gMV0uc3JjID0gbGFzdFRva2VuLnRleHQ7DQogICAgICAgIH0gZWxzZSBpZiAoIXRoaXMudG9rZW5zLmxpbmtzW3Rva2VuLnRhZ10pIHsNCiAgICAgICAgICB0aGlzLnRva2Vucy5saW5rc1t0b2tlbi50YWddID0gew0KICAgICAgICAgICAgaHJlZjogdG9rZW4uaHJlZiwNCiAgICAgICAgICAgIHRpdGxlOiB0b2tlbi50aXRsZQ0KICAgICAgICAgIH07DQogICAgICAgIH0NCiAgICAgICAgY29udGludWU7DQogICAgICB9DQoNCiAgICAgIC8vIHRhYmxlIChnZm0pDQogICAgICBpZiAodG9rZW4gPSB0aGlzLnRva2VuaXplci50YWJsZShzcmMpKSB7DQogICAgICAgIHNyYyA9IHNyYy5zdWJzdHJpbmcodG9rZW4ucmF3Lmxlbmd0aCk7DQogICAgICAgIHRva2Vucy5wdXNoKHRva2VuKTsNCiAgICAgICAgY29udGludWU7DQogICAgICB9DQoNCiAgICAgIC8vIGxoZWFkaW5nDQogICAgICBpZiAodG9rZW4gPSB0aGlzLnRva2VuaXplci5saGVhZGluZyhzcmMpKSB7DQogICAgICAgIHNyYyA9IHNyYy5zdWJzdHJpbmcodG9rZW4ucmF3Lmxlbmd0aCk7DQogICAgICAgIHRva2Vucy5wdXNoKHRva2VuKTsNCiAgICAgICAgY29udGludWU7DQogICAgICB9DQoNCiAgICAgIC8vIHRvcC1sZXZlbCBwYXJhZ3JhcGgNCiAgICAgIC8vIHByZXZlbnQgcGFyYWdyYXBoIGNvbnN1bWluZyBleHRlbnNpb25zIGJ5IGNsaXBwaW5nICdzcmMnIHRvIGV4dGVuc2lvbiBzdGFydA0KICAgICAgY3V0U3JjID0gc3JjOw0KICAgICAgaWYgKHRoaXMub3B0aW9ucy5leHRlbnNpb25zICYmIHRoaXMub3B0aW9ucy5leHRlbnNpb25zLnN0YXJ0QmxvY2spIHsNCiAgICAgICAgbGV0IHN0YXJ0SW5kZXggPSBJbmZpbml0eTsNCiAgICAgICAgY29uc3QgdGVtcFNyYyA9IHNyYy5zbGljZSgxKTsNCiAgICAgICAgbGV0IHRlbXBTdGFydDsNCiAgICAgICAgdGhpcy5vcHRpb25zLmV4dGVuc2lvbnMuc3RhcnRCbG9jay5mb3JFYWNoKGZ1bmN0aW9uKGdldFN0YXJ0SW5kZXgpIHsNCiAgICAgICAgICB0ZW1wU3RhcnQgPSBnZXRTdGFydEluZGV4LmNhbGwoeyBsZXhlcjogdGhpcyB9LCB0ZW1wU3JjKTsNCiAgICAgICAgICBpZiAodHlwZW9mIHRlbXBTdGFydCA9PT0gJ251bWJlcicgJiYgdGVtcFN0YXJ0ID49IDApIHsgc3RhcnRJbmRleCA9IE1hdGgubWluKHN0YXJ0SW5kZXgsIHRlbXBTdGFydCk7IH0NCiAgICAgICAgfSk7DQogICAgICAgIGlmIChzdGFydEluZGV4IDwgSW5maW5pdHkgJiYgc3RhcnRJbmRleCA+PSAwKSB7DQogICAgICAgICAgY3V0U3JjID0gc3JjLnN1YnN0cmluZygwLCBzdGFydEluZGV4ICsgMSk7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIGlmICh0aGlzLnN0YXRlLnRvcCAmJiAodG9rZW4gPSB0aGlzLnRva2VuaXplci5wYXJhZ3JhcGgoY3V0U3JjKSkpIHsNCiAgICAgICAgbGFzdFRva2VuID0gdG9rZW5zW3Rva2Vucy5sZW5ndGggLSAxXTsNCiAgICAgICAgaWYgKGxhc3RQYXJhZ3JhcGhDbGlwcGVkICYmIGxhc3RUb2tlbi50eXBlID09PSAncGFyYWdyYXBoJykgew0KICAgICAgICAgIGxhc3RUb2tlbi5yYXcgKz0gJ1xuJyArIHRva2VuLnJhdzsNCiAgICAgICAgICBsYXN0VG9rZW4udGV4dCArPSAnXG4nICsgdG9rZW4udGV4dDsNCiAgICAgICAgICB0aGlzLmlubGluZVF1ZXVlLnBvcCgpOw0KICAgICAgICAgIHRoaXMuaW5saW5lUXVldWVbdGhpcy5pbmxpbmVRdWV1ZS5sZW5ndGggLSAxXS5zcmMgPSBsYXN0VG9rZW4udGV4dDsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICB0b2tlbnMucHVzaCh0b2tlbik7DQogICAgICAgIH0NCiAgICAgICAgbGFzdFBhcmFncmFwaENsaXBwZWQgPSAoY3V0U3JjLmxlbmd0aCAhPT0gc3JjLmxlbmd0aCk7DQogICAgICAgIHNyYyA9IHNyYy5zdWJzdHJpbmcodG9rZW4ucmF3Lmxlbmd0aCk7DQogICAgICAgIGNvbnRpbnVlOw0KICAgICAgfQ0KDQogICAgICAvLyB0ZXh0DQogICAgICBpZiAodG9rZW4gPSB0aGlzLnRva2VuaXplci50ZXh0KHNyYykpIHsNCiAgICAgICAgc3JjID0gc3JjLnN1YnN0cmluZyh0b2tlbi5yYXcubGVuZ3RoKTsNCiAgICAgICAgbGFzdFRva2VuID0gdG9rZW5zW3Rva2Vucy5sZW5ndGggLSAxXTsNCiAgICAgICAgaWYgKGxhc3RUb2tlbiAmJiBsYXN0VG9rZW4udHlwZSA9PT0gJ3RleHQnKSB7DQogICAgICAgICAgbGFzdFRva2VuLnJhdyArPSAnXG4nICsgdG9rZW4ucmF3Ow0KICAgICAgICAgIGxhc3RUb2tlbi50ZXh0ICs9ICdcbicgKyB0b2tlbi50ZXh0Ow0KICAgICAgICAgIHRoaXMuaW5saW5lUXVldWUucG9wKCk7DQogICAgICAgICAgdGhpcy5pbmxpbmVRdWV1ZVt0aGlzLmlubGluZVF1ZXVlLmxlbmd0aCAtIDFdLnNyYyA9IGxhc3RUb2tlbi50ZXh0Ow0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHRva2Vucy5wdXNoKHRva2VuKTsNCiAgICAgICAgfQ0KICAgICAgICBjb250aW51ZTsNCiAgICAgIH0NCg0KICAgICAgaWYgKHNyYykgew0KICAgICAgICBjb25zdCBlcnJNc2cgPSAnSW5maW5pdGUgbG9vcCBvbiBieXRlOiAnICsgc3JjLmNoYXJDb2RlQXQoMCk7DQogICAgICAgIGlmICh0aGlzLm9wdGlvbnMuc2lsZW50KSB7DQogICAgICAgICAgY29uc29sZS5lcnJvcihlcnJNc2cpOw0KICAgICAgICAgIGJyZWFrOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHRocm93IG5ldyBFcnJvcihlcnJNc2cpOw0KICAgICAgICB9DQogICAgICB9DQogICAgfQ0KDQogICAgdGhpcy5zdGF0ZS50b3AgPSB0cnVlOw0KICAgIHJldHVybiB0b2tlbnM7DQogIH0NCg0KICBpbmxpbmUoc3JjLCB0b2tlbnMpIHsNCiAgICB0aGlzLmlubGluZVF1ZXVlLnB1c2goeyBzcmMsIHRva2VucyB9KTsNCiAgfQ0KDQogIC8qKg0KICAgKiBMZXhpbmcvQ29tcGlsaW5nDQogICAqLw0KICBpbmxpbmVUb2tlbnMoc3JjLCB0b2tlbnMgPSBbXSkgew0KICAgIGxldCB0b2tlbiwgbGFzdFRva2VuLCBjdXRTcmM7DQoNCiAgICAvLyBTdHJpbmcgd2l0aCBsaW5rcyBtYXNrZWQgdG8gYXZvaWQgaW50ZXJmZXJlbmNlIHdpdGggZW0gYW5kIHN0cm9uZw0KICAgIGxldCBtYXNrZWRTcmMgPSBzcmM7DQogICAgbGV0IG1hdGNoOw0KICAgIGxldCBrZWVwUHJldkNoYXIsIHByZXZDaGFyOw0KDQogICAgLy8gTWFzayBvdXQgcmVmbGlua3MNCiAgICBpZiAodGhpcy50b2tlbnMubGlua3MpIHsNCiAgICAgIGNvbnN0IGxpbmtzID0gT2JqZWN0LmtleXModGhpcy50b2tlbnMubGlua3MpOw0KICAgICAgaWYgKGxpbmtzLmxlbmd0aCA+IDApIHsNCiAgICAgICAgd2hpbGUgKChtYXRjaCA9IHRoaXMudG9rZW5pemVyLnJ1bGVzLmlubGluZS5yZWZsaW5rU2VhcmNoLmV4ZWMobWFza2VkU3JjKSkgIT0gbnVsbCkgew0KICAgICAgICAgIGlmIChsaW5rcy5pbmNsdWRlcyhtYXRjaFswXS5zbGljZShtYXRjaFswXS5sYXN0SW5kZXhPZignWycpICsgMSwgLTEpKSkgew0KICAgICAgICAgICAgbWFza2VkU3JjID0gbWFza2VkU3JjLnNsaWNlKDAsIG1hdGNoLmluZGV4KSArICdbJyArIHJlcGVhdFN0cmluZygnYScsIG1hdGNoWzBdLmxlbmd0aCAtIDIpICsgJ10nICsgbWFza2VkU3JjLnNsaWNlKHRoaXMudG9rZW5pemVyLnJ1bGVzLmlubGluZS5yZWZsaW5rU2VhcmNoLmxhc3RJbmRleCk7DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICB9DQogICAgfQ0KICAgIC8vIE1hc2sgb3V0IG90aGVyIGJsb2Nrcw0KICAgIHdoaWxlICgobWF0Y2ggPSB0aGlzLnRva2VuaXplci5ydWxlcy5pbmxpbmUuYmxvY2tTa2lwLmV4ZWMobWFza2VkU3JjKSkgIT0gbnVsbCkgew0KICAgICAgbWFza2VkU3JjID0gbWFza2VkU3JjLnNsaWNlKDAsIG1hdGNoLmluZGV4KSArICdbJyArIHJlcGVhdFN0cmluZygnYScsIG1hdGNoWzBdLmxlbmd0aCAtIDIpICsgJ10nICsgbWFza2VkU3JjLnNsaWNlKHRoaXMudG9rZW5pemVyLnJ1bGVzLmlubGluZS5ibG9ja1NraXAubGFzdEluZGV4KTsNCiAgICB9DQoNCiAgICAvLyBNYXNrIG91dCBlc2NhcGVkIGVtICYgc3Ryb25nIGRlbGltaXRlcnMNCiAgICB3aGlsZSAoKG1hdGNoID0gdGhpcy50b2tlbml6ZXIucnVsZXMuaW5saW5lLmVzY2FwZWRFbVN0LmV4ZWMobWFza2VkU3JjKSkgIT0gbnVsbCkgew0KICAgICAgbWFza2VkU3JjID0gbWFza2VkU3JjLnNsaWNlKDAsIG1hdGNoLmluZGV4KSArICcrKycgKyBtYXNrZWRTcmMuc2xpY2UodGhpcy50b2tlbml6ZXIucnVsZXMuaW5saW5lLmVzY2FwZWRFbVN0Lmxhc3RJbmRleCk7DQogICAgfQ0KDQogICAgd2hpbGUgKHNyYykgew0KICAgICAgaWYgKCFrZWVwUHJldkNoYXIpIHsNCiAgICAgICAgcHJldkNoYXIgPSAnJzsNCiAgICAgIH0NCiAgICAgIGtlZXBQcmV2Q2hhciA9IGZhbHNlOw0KDQogICAgICAvLyBleHRlbnNpb25zDQogICAgICBpZiAodGhpcy5vcHRpb25zLmV4dGVuc2lvbnMNCiAgICAgICAgJiYgdGhpcy5vcHRpb25zLmV4dGVuc2lvbnMuaW5saW5lDQogICAgICAgICYmIHRoaXMub3B0aW9ucy5leHRlbnNpb25zLmlubGluZS5zb21lKChleHRUb2tlbml6ZXIpID0+IHsNCiAgICAgICAgICBpZiAodG9rZW4gPSBleHRUb2tlbml6ZXIuY2FsbCh7IGxleGVyOiB0aGlzIH0sIHNyYywgdG9rZW5zKSkgew0KICAgICAgICAgICAgc3JjID0gc3JjLnN1YnN0cmluZyh0b2tlbi5yYXcubGVuZ3RoKTsNCiAgICAgICAgICAgIHRva2Vucy5wdXNoKHRva2VuKTsNCiAgICAgICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgICAgIH0NCiAgICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICAgIH0pKSB7DQogICAgICAgIGNvbnRpbnVlOw0KICAgICAgfQ0KDQogICAgICAvLyBlc2NhcGUNCiAgICAgIGlmICh0b2tlbiA9IHRoaXMudG9rZW5pemVyLmVzY2FwZShzcmMpKSB7DQogICAgICAgIHNyYyA9IHNyYy5zdWJzdHJpbmcodG9rZW4ucmF3Lmxlbmd0aCk7DQogICAgICAgIHRva2Vucy5wdXNoKHRva2VuKTsNCiAgICAgICAgY29udGludWU7DQogICAgICB9DQoNCiAgICAgIC8vIHRhZw0KICAgICAgaWYgKHRva2VuID0gdGhpcy50b2tlbml6ZXIudGFnKHNyYykpIHsNCiAgICAgICAgc3JjID0gc3JjLnN1YnN0cmluZyh0b2tlbi5yYXcubGVuZ3RoKTsNCiAgICAgICAgbGFzdFRva2VuID0gdG9rZW5zW3Rva2Vucy5sZW5ndGggLSAxXTsNCiAgICAgICAgaWYgKGxhc3RUb2tlbiAmJiB0b2tlbi50eXBlID09PSAndGV4dCcgJiYgbGFzdFRva2VuLnR5cGUgPT09ICd0ZXh0Jykgew0KICAgICAgICAgIGxhc3RUb2tlbi5yYXcgKz0gdG9rZW4ucmF3Ow0KICAgICAgICAgIGxhc3RUb2tlbi50ZXh0ICs9IHRva2VuLnRleHQ7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgdG9rZW5zLnB1c2godG9rZW4pOw0KICAgICAgICB9DQogICAgICAgIGNvbnRpbnVlOw0KICAgICAgfQ0KDQogICAgICAvLyBsaW5rDQogICAgICBpZiAodG9rZW4gPSB0aGlzLnRva2VuaXplci5saW5rKHNyYykpIHsNCiAgICAgICAgc3JjID0gc3JjLnN1YnN0cmluZyh0b2tlbi5yYXcubGVuZ3RoKTsNCiAgICAgICAgdG9rZW5zLnB1c2godG9rZW4pOw0KICAgICAgICBjb250aW51ZTsNCiAgICAgIH0NCg0KICAgICAgLy8gcmVmbGluaywgbm9saW5rDQogICAgICBpZiAodG9rZW4gPSB0aGlzLnRva2VuaXplci5yZWZsaW5rKHNyYywgdGhpcy50b2tlbnMubGlua3MpKSB7DQogICAgICAgIHNyYyA9IHNyYy5zdWJzdHJpbmcodG9rZW4ucmF3Lmxlbmd0aCk7DQogICAgICAgIGxhc3RUb2tlbiA9IHRva2Vuc1t0b2tlbnMubGVuZ3RoIC0gMV07DQogICAgICAgIGlmIChsYXN0VG9rZW4gJiYgdG9rZW4udHlwZSA9PT0gJ3RleHQnICYmIGxhc3RUb2tlbi50eXBlID09PSAndGV4dCcpIHsNCiAgICAgICAgICBsYXN0VG9rZW4ucmF3ICs9IHRva2VuLnJhdzsNCiAgICAgICAgICBsYXN0VG9rZW4udGV4dCArPSB0b2tlbi50ZXh0Ow0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHRva2Vucy5wdXNoKHRva2VuKTsNCiAgICAgICAgfQ0KICAgICAgICBjb250aW51ZTsNCiAgICAgIH0NCg0KICAgICAgLy8gZW0gJiBzdHJvbmcNCiAgICAgIGlmICh0b2tlbiA9IHRoaXMudG9rZW5pemVyLmVtU3Ryb25nKHNyYywgbWFza2VkU3JjLCBwcmV2Q2hhcikpIHsNCiAgICAgICAgc3JjID0gc3JjLnN1YnN0cmluZyh0b2tlbi5yYXcubGVuZ3RoKTsNCiAgICAgICAgdG9rZW5zLnB1c2godG9rZW4pOw0KICAgICAgICBjb250aW51ZTsNCiAgICAgIH0NCg0KICAgICAgLy8gY29kZQ0KICAgICAgaWYgKHRva2VuID0gdGhpcy50b2tlbml6ZXIuY29kZXNwYW4oc3JjKSkgew0KICAgICAgICBzcmMgPSBzcmMuc3Vic3RyaW5nKHRva2VuLnJhdy5sZW5ndGgpOw0KICAgICAgICB0b2tlbnMucHVzaCh0b2tlbik7DQogICAgICAgIGNvbnRpbnVlOw0KICAgICAgfQ0KDQogICAgICAvLyBicg0KICAgICAgaWYgKHRva2VuID0gdGhpcy50b2tlbml6ZXIuYnIoc3JjKSkgew0KICAgICAgICBzcmMgPSBzcmMuc3Vic3RyaW5nKHRva2VuLnJhdy5sZW5ndGgpOw0KICAgICAgICB0b2tlbnMucHVzaCh0b2tlbik7DQogICAgICAgIGNvbnRpbnVlOw0KICAgICAgfQ0KDQogICAgICAvLyBkZWwgKGdmbSkNCiAgICAgIGlmICh0b2tlbiA9IHRoaXMudG9rZW5pemVyLmRlbChzcmMpKSB7DQogICAgICAgIHNyYyA9IHNyYy5zdWJzdHJpbmcodG9rZW4ucmF3Lmxlbmd0aCk7DQogICAgICAgIHRva2Vucy5wdXNoKHRva2VuKTsNCiAgICAgICAgY29udGludWU7DQogICAgICB9DQoNCiAgICAgIC8vIGF1dG9saW5rDQogICAgICBpZiAodG9rZW4gPSB0aGlzLnRva2VuaXplci5hdXRvbGluayhzcmMsIG1hbmdsZSkpIHsNCiAgICAgICAgc3JjID0gc3JjLnN1YnN0cmluZyh0b2tlbi5yYXcubGVuZ3RoKTsNCiAgICAgICAgdG9rZW5zLnB1c2godG9rZW4pOw0KICAgICAgICBjb250aW51ZTsNCiAgICAgIH0NCg0KICAgICAgLy8gdXJsIChnZm0pDQogICAgICBpZiAoIXRoaXMuc3RhdGUuaW5MaW5rICYmICh0b2tlbiA9IHRoaXMudG9rZW5pemVyLnVybChzcmMsIG1hbmdsZSkpKSB7DQogICAgICAgIHNyYyA9IHNyYy5zdWJzdHJpbmcodG9rZW4ucmF3Lmxlbmd0aCk7DQogICAgICAgIHRva2Vucy5wdXNoKHRva2VuKTsNCiAgICAgICAgY29udGludWU7DQogICAgICB9DQoNCiAgICAgIC8vIHRleHQNCiAgICAgIC8vIHByZXZlbnQgaW5saW5lVGV4dCBjb25zdW1pbmcgZXh0ZW5zaW9ucyBieSBjbGlwcGluZyAnc3JjJyB0byBleHRlbnNpb24gc3RhcnQNCiAgICAgIGN1dFNyYyA9IHNyYzsNCiAgICAgIGlmICh0aGlzLm9wdGlvbnMuZXh0ZW5zaW9ucyAmJiB0aGlzLm9wdGlvbnMuZXh0ZW5zaW9ucy5zdGFydElubGluZSkgew0KICAgICAgICBsZXQgc3RhcnRJbmRleCA9IEluZmluaXR5Ow0KICAgICAgICBjb25zdCB0ZW1wU3JjID0gc3JjLnNsaWNlKDEpOw0KICAgICAgICBsZXQgdGVtcFN0YXJ0Ow0KICAgICAgICB0aGlzLm9wdGlvbnMuZXh0ZW5zaW9ucy5zdGFydElubGluZS5mb3JFYWNoKGZ1bmN0aW9uKGdldFN0YXJ0SW5kZXgpIHsNCiAgICAgICAgICB0ZW1wU3RhcnQgPSBnZXRTdGFydEluZGV4LmNhbGwoeyBsZXhlcjogdGhpcyB9LCB0ZW1wU3JjKTsNCiAgICAgICAgICBpZiAodHlwZW9mIHRlbXBTdGFydCA9PT0gJ251bWJlcicgJiYgdGVtcFN0YXJ0ID49IDApIHsgc3RhcnRJbmRleCA9IE1hdGgubWluKHN0YXJ0SW5kZXgsIHRlbXBTdGFydCk7IH0NCiAgICAgICAgfSk7DQogICAgICAgIGlmIChzdGFydEluZGV4IDwgSW5maW5pdHkgJiYgc3RhcnRJbmRleCA+PSAwKSB7DQogICAgICAgICAgY3V0U3JjID0gc3JjLnN1YnN0cmluZygwLCBzdGFydEluZGV4ICsgMSk7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIGlmICh0b2tlbiA9IHRoaXMudG9rZW5pemVyLmlubGluZVRleHQoY3V0U3JjLCBzbWFydHlwYW50cykpIHsNCiAgICAgICAgc3JjID0gc3JjLnN1YnN0cmluZyh0b2tlbi5yYXcubGVuZ3RoKTsNCiAgICAgICAgaWYgKHRva2VuLnJhdy5zbGljZSgtMSkgIT09ICdfJykgeyAvLyBUcmFjayBwcmV2Q2hhciBiZWZvcmUgc3RyaW5nIG9mIF9fX18gc3RhcnRlZA0KICAgICAgICAgIHByZXZDaGFyID0gdG9rZW4ucmF3LnNsaWNlKC0xKTsNCiAgICAgICAgfQ0KICAgICAgICBrZWVwUHJldkNoYXIgPSB0cnVlOw0KICAgICAgICBsYXN0VG9rZW4gPSB0b2tlbnNbdG9rZW5zLmxlbmd0aCAtIDFdOw0KICAgICAgICBpZiAobGFzdFRva2VuICYmIGxhc3RUb2tlbi50eXBlID09PSAndGV4dCcpIHsNCiAgICAgICAgICBsYXN0VG9rZW4ucmF3ICs9IHRva2VuLnJhdzsNCiAgICAgICAgICBsYXN0VG9rZW4udGV4dCArPSB0b2tlbi50ZXh0Ow0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHRva2Vucy5wdXNoKHRva2VuKTsNCiAgICAgICAgfQ0KICAgICAgICBjb250aW51ZTsNCiAgICAgIH0NCg0KICAgICAgaWYgKHNyYykgew0KICAgICAgICBjb25zdCBlcnJNc2cgPSAnSW5maW5pdGUgbG9vcCBvbiBieXRlOiAnICsgc3JjLmNoYXJDb2RlQXQoMCk7DQogICAgICAgIGlmICh0aGlzLm9wdGlvbnMuc2lsZW50KSB7DQogICAgICAgICAgY29uc29sZS5lcnJvcihlcnJNc2cpOw0KICAgICAgICAgIGJyZWFrOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHRocm93IG5ldyBFcnJvcihlcnJNc2cpOw0KICAgICAgICB9DQogICAgICB9DQogICAgfQ0KDQogICAgcmV0dXJuIHRva2VuczsNCiAgfQ0KfQ0KDQovKioNCiAqIFJlbmRlcmVyDQogKi8NCmNsYXNzIFJlbmRlcmVyIHsNCiAgY29uc3RydWN0b3Iob3B0aW9ucykgew0KICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwgZGVmYXVsdHM7DQogIH0NCg0KICBjb2RlKGNvZGUsIGluZm9zdHJpbmcsIGVzY2FwZWQpIHsNCiAgICBjb25zdCBsYW5nID0gKGluZm9zdHJpbmcgfHwgJycpLm1hdGNoKC9cUyovKVswXTsNCiAgICBpZiAodGhpcy5vcHRpb25zLmhpZ2hsaWdodCkgew0KICAgICAgY29uc3Qgb3V0ID0gdGhpcy5vcHRpb25zLmhpZ2hsaWdodChjb2RlLCBsYW5nKTsNCiAgICAgIGlmIChvdXQgIT0gbnVsbCAmJiBvdXQgIT09IGNvZGUpIHsNCiAgICAgICAgZXNjYXBlZCA9IHRydWU7DQogICAgICAgIGNvZGUgPSBvdXQ7DQogICAgICB9DQogICAgfQ0KDQogICAgY29kZSA9IGNvZGUucmVwbGFjZSgvXG4kLywgJycpICsgJ1xuJzsNCg0KICAgIGlmICghbGFuZykgew0KICAgICAgcmV0dXJuICc8cHJlPjxjb2RlPicNCiAgICAgICAgKyAoZXNjYXBlZCA/IGNvZGUgOiBlc2NhcGUoY29kZSwgdHJ1ZSkpDQogICAgICAgICsgJzwvY29kZT48L3ByZT5cbic7DQogICAgfQ0KDQogICAgcmV0dXJuICc8cHJlPjxjb2RlIGNsYXNzPSInDQogICAgICArIHRoaXMub3B0aW9ucy5sYW5nUHJlZml4DQogICAgICArIGVzY2FwZShsYW5nLCB0cnVlKQ0KICAgICAgKyAnIj4nDQogICAgICArIChlc2NhcGVkID8gY29kZSA6IGVzY2FwZShjb2RlLCB0cnVlKSkNCiAgICAgICsgJzwvY29kZT48L3ByZT5cbic7DQogIH0NCg0KICBibG9ja3F1b3RlKHF1b3RlKSB7DQogICAgcmV0dXJuICc8YmxvY2txdW90ZT5cbicgKyBxdW90ZSArICc8L2Jsb2NrcXVvdGU+XG4nOw0KICB9DQoNCiAgaHRtbChodG1sKSB7DQogICAgcmV0dXJuIGh0bWw7DQogIH0NCg0KICBoZWFkaW5nKHRleHQsIGxldmVsLCByYXcsIHNsdWdnZXIpIHsNCiAgICBpZiAodGhpcy5vcHRpb25zLmhlYWRlcklkcykgew0KICAgICAgcmV0dXJuICc8aCcNCiAgICAgICAgKyBsZXZlbA0KICAgICAgICArICcgaWQ9IicNCiAgICAgICAgKyB0aGlzLm9wdGlvbnMuaGVhZGVyUHJlZml4DQogICAgICAgICsgc2x1Z2dlci5zbHVnKHJhdykNCiAgICAgICAgKyAnIj4nDQogICAgICAgICsgdGV4dA0KICAgICAgICArICc8L2gnDQogICAgICAgICsgbGV2ZWwNCiAgICAgICAgKyAnPlxuJzsNCiAgICB9DQogICAgLy8gaWdub3JlIElEcw0KICAgIHJldHVybiAnPGgnICsgbGV2ZWwgKyAnPicgKyB0ZXh0ICsgJzwvaCcgKyBsZXZlbCArICc+XG4nOw0KICB9DQoNCiAgaHIoKSB7DQogICAgcmV0dXJuIHRoaXMub3B0aW9ucy54aHRtbCA/ICc8aHIvPlxuJyA6ICc8aHI+XG4nOw0KICB9DQoNCiAgbGlzdChib2R5LCBvcmRlcmVkLCBzdGFydCkgew0KICAgIGNvbnN0IHR5cGUgPSBvcmRlcmVkID8gJ29sJyA6ICd1bCcsDQogICAgICBzdGFydGF0dCA9IChvcmRlcmVkICYmIHN0YXJ0ICE9PSAxKSA/ICgnIHN0YXJ0PSInICsgc3RhcnQgKyAnIicpIDogJyc7DQogICAgcmV0dXJuICc8JyArIHR5cGUgKyBzdGFydGF0dCArICc+XG4nICsgYm9keSArICc8LycgKyB0eXBlICsgJz5cbic7DQogIH0NCg0KICBsaXN0aXRlbSh0ZXh0KSB7DQogICAgcmV0dXJuICc8bGk+JyArIHRleHQgKyAnPC9saT5cbic7DQogIH0NCg0KICBjaGVja2JveChjaGVja2VkKSB7DQogICAgcmV0dXJuICc8aW5wdXQgJw0KICAgICAgKyAoY2hlY2tlZCA/ICdjaGVja2VkPSIiICcgOiAnJykNCiAgICAgICsgJ2Rpc2FibGVkPSIiIHR5cGU9ImNoZWNrYm94IicNCiAgICAgICsgKHRoaXMub3B0aW9ucy54aHRtbCA/ICcgLycgOiAnJykNCiAgICAgICsgJz4gJzsNCiAgfQ0KDQogIHBhcmFncmFwaCh0ZXh0KSB7DQogICAgcmV0dXJuICc8cD4nICsgdGV4dCArICc8L3A+XG4nOw0KICB9DQoNCiAgdGFibGUoaGVhZGVyLCBib2R5KSB7DQogICAgaWYgKGJvZHkpIGJvZHkgPSAnPHRib2R5PicgKyBib2R5ICsgJzwvdGJvZHk+JzsNCg0KICAgIHJldHVybiAnPHRhYmxlPlxuJw0KICAgICAgKyAnPHRoZWFkPlxuJw0KICAgICAgKyBoZWFkZXINCiAgICAgICsgJzwvdGhlYWQ+XG4nDQogICAgICArIGJvZHkNCiAgICAgICsgJzwvdGFibGU+XG4nOw0KICB9DQoNCiAgdGFibGVyb3coY29udGVudCkgew0KICAgIHJldHVybiAnPHRyPlxuJyArIGNvbnRlbnQgKyAnPC90cj5cbic7DQogIH0NCg0KICB0YWJsZWNlbGwoY29udGVudCwgZmxhZ3MpIHsNCiAgICBjb25zdCB0eXBlID0gZmxhZ3MuaGVhZGVyID8gJ3RoJyA6ICd0ZCc7DQogICAgY29uc3QgdGFnID0gZmxhZ3MuYWxpZ24NCiAgICAgID8gJzwnICsgdHlwZSArICcgYWxpZ249IicgKyBmbGFncy5hbGlnbiArICciPicNCiAgICAgIDogJzwnICsgdHlwZSArICc+JzsNCiAgICByZXR1cm4gdGFnICsgY29udGVudCArICc8LycgKyB0eXBlICsgJz5cbic7DQogIH0NCg0KICAvLyBzcGFuIGxldmVsIHJlbmRlcmVyDQogIHN0cm9uZyh0ZXh0KSB7DQogICAgcmV0dXJuICc8c3Ryb25nPicgKyB0ZXh0ICsgJzwvc3Ryb25nPic7DQogIH0NCg0KICBlbSh0ZXh0KSB7DQogICAgcmV0dXJuICc8ZW0+JyArIHRleHQgKyAnPC9lbT4nOw0KICB9DQoNCiAgY29kZXNwYW4odGV4dCkgew0KICAgIHJldHVybiAnPGNvZGU+JyArIHRleHQgKyAnPC9jb2RlPic7DQogIH0NCg0KICBicigpIHsNCiAgICByZXR1cm4gdGhpcy5vcHRpb25zLnhodG1sID8gJzxici8+JyA6ICc8YnI+JzsNCiAgfQ0KDQogIGRlbCh0ZXh0KSB7DQogICAgcmV0dXJuICc8ZGVsPicgKyB0ZXh0ICsgJzwvZGVsPic7DQogIH0NCg0KICBsaW5rKGhyZWYsIHRpdGxlLCB0ZXh0KSB7DQogICAgaHJlZiA9IGNsZWFuVXJsKHRoaXMub3B0aW9ucy5zYW5pdGl6ZSwgdGhpcy5vcHRpb25zLmJhc2VVcmwsIGhyZWYpOw0KICAgIGlmIChocmVmID09PSBudWxsKSB7DQogICAgICByZXR1cm4gdGV4dDsNCiAgICB9DQogICAgbGV0IG91dCA9ICc8YSBocmVmPSInICsgZXNjYXBlKGhyZWYpICsgJyInOw0KICAgIGlmICh0aXRsZSkgew0KICAgICAgb3V0ICs9ICcgdGl0bGU9IicgKyB0aXRsZSArICciJzsNCiAgICB9DQogICAgb3V0ICs9ICc+JyArIHRleHQgKyAnPC9hPic7DQogICAgcmV0dXJuIG91dDsNCiAgfQ0KDQogIGltYWdlKGhyZWYsIHRpdGxlLCB0ZXh0KSB7DQogICAgaHJlZiA9IGNsZWFuVXJsKHRoaXMub3B0aW9ucy5zYW5pdGl6ZSwgdGhpcy5vcHRpb25zLmJhc2VVcmwsIGhyZWYpOw0KICAgIGlmIChocmVmID09PSBudWxsKSB7DQogICAgICByZXR1cm4gdGV4dDsNCiAgICB9DQoNCiAgICBsZXQgb3V0ID0gJzxpbWcgc3JjPSInICsgaHJlZiArICciIGFsdD0iJyArIHRleHQgKyAnIic7DQogICAgaWYgKHRpdGxlKSB7DQogICAgICBvdXQgKz0gJyB0aXRsZT0iJyArIHRpdGxlICsgJyInOw0KICAgIH0NCiAgICBvdXQgKz0gdGhpcy5vcHRpb25zLnhodG1sID8gJy8+JyA6ICc+JzsNCiAgICByZXR1cm4gb3V0Ow0KICB9DQoNCiAgdGV4dCh0ZXh0KSB7DQogICAgcmV0dXJuIHRleHQ7DQogIH0NCn0NCg0KLyoqDQogKiBUZXh0UmVuZGVyZXINCiAqIHJldHVybnMgb25seSB0aGUgdGV4dHVhbCBwYXJ0IG9mIHRoZSB0b2tlbg0KICovDQpjbGFzcyBUZXh0UmVuZGVyZXIgew0KICAvLyBubyBuZWVkIGZvciBibG9jayBsZXZlbCByZW5kZXJlcnMNCiAgc3Ryb25nKHRleHQpIHsNCiAgICByZXR1cm4gdGV4dDsNCiAgfQ0KDQogIGVtKHRleHQpIHsNCiAgICByZXR1cm4gdGV4dDsNCiAgfQ0KDQogIGNvZGVzcGFuKHRleHQpIHsNCiAgICByZXR1cm4gdGV4dDsNCiAgfQ0KDQogIGRlbCh0ZXh0KSB7DQogICAgcmV0dXJuIHRleHQ7DQogIH0NCg0KICBodG1sKHRleHQpIHsNCiAgICByZXR1cm4gdGV4dDsNCiAgfQ0KDQogIHRleHQodGV4dCkgew0KICAgIHJldHVybiB0ZXh0Ow0KICB9DQoNCiAgbGluayhocmVmLCB0aXRsZSwgdGV4dCkgew0KICAgIHJldHVybiAnJyArIHRleHQ7DQogIH0NCg0KICBpbWFnZShocmVmLCB0aXRsZSwgdGV4dCkgew0KICAgIHJldHVybiAnJyArIHRleHQ7DQogIH0NCg0KICBicigpIHsNCiAgICByZXR1cm4gJyc7DQogIH0NCn0NCg0KLyoqDQogKiBTbHVnZ2VyIGdlbmVyYXRlcyBoZWFkZXIgaWQNCiAqLw0KY2xhc3MgU2x1Z2dlciB7DQogIGNvbnN0cnVjdG9yKCkgew0KICAgIHRoaXMuc2VlbiA9IHt9Ow0KICB9DQoNCiAgc2VyaWFsaXplKHZhbHVlKSB7DQogICAgcmV0dXJuIHZhbHVlDQogICAgICAudG9Mb3dlckNhc2UoKQ0KICAgICAgLnRyaW0oKQ0KICAgICAgLy8gcmVtb3ZlIGh0bWwgdGFncw0KICAgICAgLnJlcGxhY2UoLzxbIVwvYS16XS4qPz4vaWcsICcnKQ0KICAgICAgLy8gcmVtb3ZlIHVud2FudGVkIGNoYXJzDQogICAgICAucmVwbGFjZSgvW1x1MjAwMC1cdTIwNkZcdTJFMDAtXHUyRTdGXFwnISIjJCUmKCkqKywuLzo7PD0+P0BbXF1eYHt8fX5dL2csICcnKQ0KICAgICAgLnJlcGxhY2UoL1xzL2csICctJyk7DQogIH0NCg0KICAvKioNCiAgICogRmluZHMgdGhlIG5leHQgc2FmZSAodW5pcXVlKSBzbHVnIHRvIHVzZQ0KICAgKi8NCiAgZ2V0TmV4dFNhZmVTbHVnKG9yaWdpbmFsU2x1ZywgaXNEcnlSdW4pIHsNCiAgICBsZXQgc2x1ZyA9IG9yaWdpbmFsU2x1ZzsNCiAgICBsZXQgb2NjdXJlbmNlQWNjdW11bGF0b3IgPSAwOw0KICAgIGlmICh0aGlzLnNlZW4uaGFzT3duUHJvcGVydHkoc2x1ZykpIHsNCiAgICAgIG9jY3VyZW5jZUFjY3VtdWxhdG9yID0gdGhpcy5zZWVuW29yaWdpbmFsU2x1Z107DQogICAgICBkbyB7DQogICAgICAgIG9jY3VyZW5jZUFjY3VtdWxhdG9yKys7DQogICAgICAgIHNsdWcgPSBvcmlnaW5hbFNsdWcgKyAnLScgKyBvY2N1cmVuY2VBY2N1bXVsYXRvcjsNCiAgICAgIH0gd2hpbGUgKHRoaXMuc2Vlbi5oYXNPd25Qcm9wZXJ0eShzbHVnKSk7DQogICAgfQ0KICAgIGlmICghaXNEcnlSdW4pIHsNCiAgICAgIHRoaXMuc2VlbltvcmlnaW5hbFNsdWddID0gb2NjdXJlbmNlQWNjdW11bGF0b3I7DQogICAgICB0aGlzLnNlZW5bc2x1Z10gPSAwOw0KICAgIH0NCiAgICByZXR1cm4gc2x1ZzsNCiAgfQ0KDQogIC8qKg0KICAgKiBDb252ZXJ0IHN0cmluZyB0byB1bmlxdWUgaWQNCiAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMNCiAgICogQHBhcmFtIHtib29sZWFufSBvcHRpb25zLmRyeXJ1biBHZW5lcmF0ZXMgdGhlIG5leHQgdW5pcXVlIHNsdWcgd2l0aG91dCB1cGRhdGluZyB0aGUgaW50ZXJuYWwgYWNjdW11bGF0b3IuDQogICAqLw0KICBzbHVnKHZhbHVlLCBvcHRpb25zID0ge30pIHsNCiAgICBjb25zdCBzbHVnID0gdGhpcy5zZXJpYWxpemUodmFsdWUpOw0KICAgIHJldHVybiB0aGlzLmdldE5leHRTYWZlU2x1ZyhzbHVnLCBvcHRpb25zLmRyeXJ1bik7DQogIH0NCn0NCg0KLyoqDQogKiBQYXJzaW5nICYgQ29tcGlsaW5nDQogKi8NCmNsYXNzIFBhcnNlciB7DQogIGNvbnN0cnVjdG9yKG9wdGlvbnMpIHsNCiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zIHx8IGRlZmF1bHRzOw0KICAgIHRoaXMub3B0aW9ucy5yZW5kZXJlciA9IHRoaXMub3B0aW9ucy5yZW5kZXJlciB8fCBuZXcgUmVuZGVyZXIoKTsNCiAgICB0aGlzLnJlbmRlcmVyID0gdGhpcy5vcHRpb25zLnJlbmRlcmVyOw0KICAgIHRoaXMucmVuZGVyZXIub3B0aW9ucyA9IHRoaXMub3B0aW9uczsNCiAgICB0aGlzLnRleHRSZW5kZXJlciA9IG5ldyBUZXh0UmVuZGVyZXIoKTsNCiAgICB0aGlzLnNsdWdnZXIgPSBuZXcgU2x1Z2dlcigpOw0KICB9DQoNCiAgLyoqDQogICAqIFN0YXRpYyBQYXJzZSBNZXRob2QNCiAgICovDQogIHN0YXRpYyBwYXJzZSh0b2tlbnMsIG9wdGlvbnMpIHsNCiAgICBjb25zdCBwYXJzZXIgPSBuZXcgUGFyc2VyKG9wdGlvbnMpOw0KICAgIHJldHVybiBwYXJzZXIucGFyc2UodG9rZW5zKTsNCiAgfQ0KDQogIC8qKg0KICAgKiBTdGF0aWMgUGFyc2UgSW5saW5lIE1ldGhvZA0KICAgKi8NCiAgc3RhdGljIHBhcnNlSW5saW5lKHRva2Vucywgb3B0aW9ucykgew0KICAgIGNvbnN0IHBhcnNlciA9IG5ldyBQYXJzZXIob3B0aW9ucyk7DQogICAgcmV0dXJuIHBhcnNlci5wYXJzZUlubGluZSh0b2tlbnMpOw0KICB9DQoNCiAgLyoqDQogICAqIFBhcnNlIExvb3ANCiAgICovDQogIHBhcnNlKHRva2VucywgdG9wID0gdHJ1ZSkgew0KICAgIGxldCBvdXQgPSAnJywNCiAgICAgIGksDQogICAgICBqLA0KICAgICAgaywNCiAgICAgIGwyLA0KICAgICAgbDMsDQogICAgICByb3csDQogICAgICBjZWxsLA0KICAgICAgaGVhZGVyLA0KICAgICAgYm9keSwNCiAgICAgIHRva2VuLA0KICAgICAgb3JkZXJlZCwNCiAgICAgIHN0YXJ0LA0KICAgICAgbG9vc2UsDQogICAgICBpdGVtQm9keSwNCiAgICAgIGl0ZW0sDQogICAgICBjaGVja2VkLA0KICAgICAgdGFzaywNCiAgICAgIGNoZWNrYm94LA0KICAgICAgcmV0Ow0KDQogICAgY29uc3QgbCA9IHRva2Vucy5sZW5ndGg7DQogICAgZm9yIChpID0gMDsgaSA8IGw7IGkrKykgew0KICAgICAgdG9rZW4gPSB0b2tlbnNbaV07DQoNCiAgICAgIC8vIFJ1biBhbnkgcmVuZGVyZXIgZXh0ZW5zaW9ucw0KICAgICAgaWYgKHRoaXMub3B0aW9ucy5leHRlbnNpb25zICYmIHRoaXMub3B0aW9ucy5leHRlbnNpb25zLnJlbmRlcmVycyAmJiB0aGlzLm9wdGlvbnMuZXh0ZW5zaW9ucy5yZW5kZXJlcnNbdG9rZW4udHlwZV0pIHsNCiAgICAgICAgcmV0ID0gdGhpcy5vcHRpb25zLmV4dGVuc2lvbnMucmVuZGVyZXJzW3Rva2VuLnR5cGVdLmNhbGwoeyBwYXJzZXI6IHRoaXMgfSwgdG9rZW4pOw0KICAgICAgICBpZiAocmV0ICE9PSBmYWxzZSB8fCAhWydzcGFjZScsICdocicsICdoZWFkaW5nJywgJ2NvZGUnLCAndGFibGUnLCAnYmxvY2txdW90ZScsICdsaXN0JywgJ2h0bWwnLCAncGFyYWdyYXBoJywgJ3RleHQnXS5pbmNsdWRlcyh0b2tlbi50eXBlKSkgew0KICAgICAgICAgIG91dCArPSByZXQgfHwgJyc7DQogICAgICAgICAgY29udGludWU7DQogICAgICAgIH0NCiAgICAgIH0NCg0KICAgICAgc3dpdGNoICh0b2tlbi50eXBlKSB7DQogICAgICAgIGNhc2UgJ3NwYWNlJzogew0KICAgICAgICAgIGNvbnRpbnVlOw0KICAgICAgICB9DQogICAgICAgIGNhc2UgJ2hyJzogew0KICAgICAgICAgIG91dCArPSB0aGlzLnJlbmRlcmVyLmhyKCk7DQogICAgICAgICAgY29udGludWU7DQogICAgICAgIH0NCiAgICAgICAgY2FzZSAnaGVhZGluZyc6IHsNCiAgICAgICAgICBvdXQgKz0gdGhpcy5yZW5kZXJlci5oZWFkaW5nKA0KICAgICAgICAgICAgdGhpcy5wYXJzZUlubGluZSh0b2tlbi50b2tlbnMpLA0KICAgICAgICAgICAgdG9rZW4uZGVwdGgsDQogICAgICAgICAgICB1bmVzY2FwZSh0aGlzLnBhcnNlSW5saW5lKHRva2VuLnRva2VucywgdGhpcy50ZXh0UmVuZGVyZXIpKSwNCiAgICAgICAgICAgIHRoaXMuc2x1Z2dlcik7DQogICAgICAgICAgY29udGludWU7DQogICAgICAgIH0NCiAgICAgICAgY2FzZSAnY29kZSc6IHsNCiAgICAgICAgICBvdXQgKz0gdGhpcy5yZW5kZXJlci5jb2RlKHRva2VuLnRleHQsDQogICAgICAgICAgICB0b2tlbi5sYW5nLA0KICAgICAgICAgICAgdG9rZW4uZXNjYXBlZCk7DQogICAgICAgICAgY29udGludWU7DQogICAgICAgIH0NCiAgICAgICAgY2FzZSAndGFibGUnOiB7DQogICAgICAgICAgaGVhZGVyID0gJyc7DQoNCiAgICAgICAgICAvLyBoZWFkZXINCiAgICAgICAgICBjZWxsID0gJyc7DQogICAgICAgICAgbDIgPSB0b2tlbi5oZWFkZXIubGVuZ3RoOw0KICAgICAgICAgIGZvciAoaiA9IDA7IGogPCBsMjsgaisrKSB7DQogICAgICAgICAgICBjZWxsICs9IHRoaXMucmVuZGVyZXIudGFibGVjZWxsKA0KICAgICAgICAgICAgICB0aGlzLnBhcnNlSW5saW5lKHRva2VuLmhlYWRlcltqXS50b2tlbnMpLA0KICAgICAgICAgICAgICB7IGhlYWRlcjogdHJ1ZSwgYWxpZ246IHRva2VuLmFsaWduW2pdIH0NCiAgICAgICAgICAgICk7DQogICAgICAgICAgfQ0KICAgICAgICAgIGhlYWRlciArPSB0aGlzLnJlbmRlcmVyLnRhYmxlcm93KGNlbGwpOw0KDQogICAgICAgICAgYm9keSA9ICcnOw0KICAgICAgICAgIGwyID0gdG9rZW4ucm93cy5sZW5ndGg7DQogICAgICAgICAgZm9yIChqID0gMDsgaiA8IGwyOyBqKyspIHsNCiAgICAgICAgICAgIHJvdyA9IHRva2VuLnJvd3Nbal07DQoNCiAgICAgICAgICAgIGNlbGwgPSAnJzsNCiAgICAgICAgICAgIGwzID0gcm93Lmxlbmd0aDsNCiAgICAgICAgICAgIGZvciAoayA9IDA7IGsgPCBsMzsgaysrKSB7DQogICAgICAgICAgICAgIGNlbGwgKz0gdGhpcy5yZW5kZXJlci50YWJsZWNlbGwoDQogICAgICAgICAgICAgICAgdGhpcy5wYXJzZUlubGluZShyb3dba10udG9rZW5zKSwNCiAgICAgICAgICAgICAgICB7IGhlYWRlcjogZmFsc2UsIGFsaWduOiB0b2tlbi5hbGlnbltrXSB9DQogICAgICAgICAgICAgICk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGJvZHkgKz0gdGhpcy5yZW5kZXJlci50YWJsZXJvdyhjZWxsKTsNCiAgICAgICAgICB9DQogICAgICAgICAgb3V0ICs9IHRoaXMucmVuZGVyZXIudGFibGUoaGVhZGVyLCBib2R5KTsNCiAgICAgICAgICBjb250aW51ZTsNCiAgICAgICAgfQ0KICAgICAgICBjYXNlICdibG9ja3F1b3RlJzogew0KICAgICAgICAgIGJvZHkgPSB0aGlzLnBhcnNlKHRva2VuLnRva2Vucyk7DQogICAgICAgICAgb3V0ICs9IHRoaXMucmVuZGVyZXIuYmxvY2txdW90ZShib2R5KTsNCiAgICAgICAgICBjb250aW51ZTsNCiAgICAgICAgfQ0KICAgICAgICBjYXNlICdsaXN0Jzogew0KICAgICAgICAgIG9yZGVyZWQgPSB0b2tlbi5vcmRlcmVkOw0KICAgICAgICAgIHN0YXJ0ID0gdG9rZW4uc3RhcnQ7DQogICAgICAgICAgbG9vc2UgPSB0b2tlbi5sb29zZTsNCiAgICAgICAgICBsMiA9IHRva2VuLml0ZW1zLmxlbmd0aDsNCg0KICAgICAgICAgIGJvZHkgPSAnJzsNCiAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgbDI7IGorKykgew0KICAgICAgICAgICAgaXRlbSA9IHRva2VuLml0ZW1zW2pdOw0KICAgICAgICAgICAgY2hlY2tlZCA9IGl0ZW0uY2hlY2tlZDsNCiAgICAgICAgICAgIHRhc2sgPSBpdGVtLnRhc2s7DQoNCiAgICAgICAgICAgIGl0ZW1Cb2R5ID0gJyc7DQogICAgICAgICAgICBpZiAoaXRlbS50YXNrKSB7DQogICAgICAgICAgICAgIGNoZWNrYm94ID0gdGhpcy5yZW5kZXJlci5jaGVja2JveChjaGVja2VkKTsNCiAgICAgICAgICAgICAgaWYgKGxvb3NlKSB7DQogICAgICAgICAgICAgICAgaWYgKGl0ZW0udG9rZW5zLmxlbmd0aCA+IDAgJiYgaXRlbS50b2tlbnNbMF0udHlwZSA9PT0gJ3BhcmFncmFwaCcpIHsNCiAgICAgICAgICAgICAgICAgIGl0ZW0udG9rZW5zWzBdLnRleHQgPSBjaGVja2JveCArICcgJyArIGl0ZW0udG9rZW5zWzBdLnRleHQ7DQogICAgICAgICAgICAgICAgICBpZiAoaXRlbS50b2tlbnNbMF0udG9rZW5zICYmIGl0ZW0udG9rZW5zWzBdLnRva2Vucy5sZW5ndGggPiAwICYmIGl0ZW0udG9rZW5zWzBdLnRva2Vuc1swXS50eXBlID09PSAndGV4dCcpIHsNCiAgICAgICAgICAgICAgICAgICAgaXRlbS50b2tlbnNbMF0udG9rZW5zWzBdLnRleHQgPSBjaGVja2JveCArICcgJyArIGl0ZW0udG9rZW5zWzBdLnRva2Vuc1swXS50ZXh0Ow0KICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgICBpdGVtLnRva2Vucy51bnNoaWZ0KHsNCiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ3RleHQnLA0KICAgICAgICAgICAgICAgICAgICB0ZXh0OiBjaGVja2JveA0KICAgICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgIGl0ZW1Cb2R5ICs9IGNoZWNrYm94Ow0KICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGl0ZW1Cb2R5ICs9IHRoaXMucGFyc2UoaXRlbS50b2tlbnMsIGxvb3NlKTsNCiAgICAgICAgICAgIGJvZHkgKz0gdGhpcy5yZW5kZXJlci5saXN0aXRlbShpdGVtQm9keSwgdGFzaywgY2hlY2tlZCk7DQogICAgICAgICAgfQ0KDQogICAgICAgICAgb3V0ICs9IHRoaXMucmVuZGVyZXIubGlzdChib2R5LCBvcmRlcmVkLCBzdGFydCk7DQogICAgICAgICAgY29udGludWU7DQogICAgICAgIH0NCiAgICAgICAgY2FzZSAnaHRtbCc6IHsNCiAgICAgICAgICAvLyBUT0RPIHBhcnNlIGlubGluZSBjb250ZW50IGlmIHBhcmFtZXRlciBtYXJrZG93bj0xDQogICAgICAgICAgb3V0ICs9IHRoaXMucmVuZGVyZXIuaHRtbCh0b2tlbi50ZXh0KTsNCiAgICAgICAgICBjb250aW51ZTsNCiAgICAgICAgfQ0KICAgICAgICBjYXNlICdwYXJhZ3JhcGgnOiB7DQogICAgICAgICAgb3V0ICs9IHRoaXMucmVuZGVyZXIucGFyYWdyYXBoKHRoaXMucGFyc2VJbmxpbmUodG9rZW4udG9rZW5zKSk7DQogICAgICAgICAgY29udGludWU7DQogICAgICAgIH0NCiAgICAgICAgY2FzZSAndGV4dCc6IHsNCiAgICAgICAgICBib2R5ID0gdG9rZW4udG9rZW5zID8gdGhpcy5wYXJzZUlubGluZSh0b2tlbi50b2tlbnMpIDogdG9rZW4udGV4dDsNCiAgICAgICAgICB3aGlsZSAoaSArIDEgPCBsICYmIHRva2Vuc1tpICsgMV0udHlwZSA9PT0gJ3RleHQnKSB7DQogICAgICAgICAgICB0b2tlbiA9IHRva2Vuc1srK2ldOw0KICAgICAgICAgICAgYm9keSArPSAnXG4nICsgKHRva2VuLnRva2VucyA/IHRoaXMucGFyc2VJbmxpbmUodG9rZW4udG9rZW5zKSA6IHRva2VuLnRleHQpOw0KICAgICAgICAgIH0NCiAgICAgICAgICBvdXQgKz0gdG9wID8gdGhpcy5yZW5kZXJlci5wYXJhZ3JhcGgoYm9keSkgOiBib2R5Ow0KICAgICAgICAgIGNvbnRpbnVlOw0KICAgICAgICB9DQoNCiAgICAgICAgZGVmYXVsdDogew0KICAgICAgICAgIGNvbnN0IGVyck1zZyA9ICdUb2tlbiB3aXRoICInICsgdG9rZW4udHlwZSArICciIHR5cGUgd2FzIG5vdCBmb3VuZC4nOw0KICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMuc2lsZW50KSB7DQogICAgICAgICAgICBjb25zb2xlLmVycm9yKGVyck1zZyk7DQogICAgICAgICAgICByZXR1cm47DQogICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihlcnJNc2cpOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH0NCg0KICAgIHJldHVybiBvdXQ7DQogIH0NCg0KICAvKioNCiAgICogUGFyc2UgSW5saW5lIFRva2Vucw0KICAgKi8NCiAgcGFyc2VJbmxpbmUodG9rZW5zLCByZW5kZXJlcikgew0KICAgIHJlbmRlcmVyID0gcmVuZGVyZXIgfHwgdGhpcy5yZW5kZXJlcjsNCiAgICBsZXQgb3V0ID0gJycsDQogICAgICBpLA0KICAgICAgdG9rZW4sDQogICAgICByZXQ7DQoNCiAgICBjb25zdCBsID0gdG9rZW5zLmxlbmd0aDsNCiAgICBmb3IgKGkgPSAwOyBpIDwgbDsgaSsrKSB7DQogICAgICB0b2tlbiA9IHRva2Vuc1tpXTsNCg0KICAgICAgLy8gUnVuIGFueSByZW5kZXJlciBleHRlbnNpb25zDQogICAgICBpZiAodGhpcy5vcHRpb25zLmV4dGVuc2lvbnMgJiYgdGhpcy5vcHRpb25zLmV4dGVuc2lvbnMucmVuZGVyZXJzICYmIHRoaXMub3B0aW9ucy5leHRlbnNpb25zLnJlbmRlcmVyc1t0b2tlbi50eXBlXSkgew0KICAgICAgICByZXQgPSB0aGlzLm9wdGlvbnMuZXh0ZW5zaW9ucy5yZW5kZXJlcnNbdG9rZW4udHlwZV0uY2FsbCh7IHBhcnNlcjogdGhpcyB9LCB0b2tlbik7DQogICAgICAgIGlmIChyZXQgIT09IGZhbHNlIHx8ICFbJ2VzY2FwZScsICdodG1sJywgJ2xpbmsnLCAnaW1hZ2UnLCAnc3Ryb25nJywgJ2VtJywgJ2NvZGVzcGFuJywgJ2JyJywgJ2RlbCcsICd0ZXh0J10uaW5jbHVkZXModG9rZW4udHlwZSkpIHsNCiAgICAgICAgICBvdXQgKz0gcmV0IHx8ICcnOw0KICAgICAgICAgIGNvbnRpbnVlOw0KICAgICAgICB9DQogICAgICB9DQoNCiAgICAgIHN3aXRjaCAodG9rZW4udHlwZSkgew0KICAgICAgICBjYXNlICdlc2NhcGUnOiB7DQogICAgICAgICAgb3V0ICs9IHJlbmRlcmVyLnRleHQodG9rZW4udGV4dCk7DQogICAgICAgICAgYnJlYWs7DQogICAgICAgIH0NCiAgICAgICAgY2FzZSAnaHRtbCc6IHsNCiAgICAgICAgICBvdXQgKz0gcmVuZGVyZXIuaHRtbCh0b2tlbi50ZXh0KTsNCiAgICAgICAgICBicmVhazsNCiAgICAgICAgfQ0KICAgICAgICBjYXNlICdsaW5rJzogew0KICAgICAgICAgIG91dCArPSByZW5kZXJlci5saW5rKHRva2VuLmhyZWYsIHRva2VuLnRpdGxlLCB0aGlzLnBhcnNlSW5saW5lKHRva2VuLnRva2VucywgcmVuZGVyZXIpKTsNCiAgICAgICAgICBicmVhazsNCiAgICAgICAgfQ0KICAgICAgICBjYXNlICdpbWFnZSc6IHsNCiAgICAgICAgICBvdXQgKz0gcmVuZGVyZXIuaW1hZ2UodG9rZW4uaHJlZiwgdG9rZW4udGl0bGUsIHRva2VuLnRleHQpOw0KICAgICAgICAgIGJyZWFrOw0KICAgICAgICB9DQogICAgICAgIGNhc2UgJ3N0cm9uZyc6IHsNCiAgICAgICAgICBvdXQgKz0gcmVuZGVyZXIuc3Ryb25nKHRoaXMucGFyc2VJbmxpbmUodG9rZW4udG9rZW5zLCByZW5kZXJlcikpOw0KICAgICAgICAgIGJyZWFrOw0KICAgICAgICB9DQogICAgICAgIGNhc2UgJ2VtJzogew0KICAgICAgICAgIG91dCArPSByZW5kZXJlci5lbSh0aGlzLnBhcnNlSW5saW5lKHRva2VuLnRva2VucywgcmVuZGVyZXIpKTsNCiAgICAgICAgICBicmVhazsNCiAgICAgICAgfQ0KICAgICAgICBjYXNlICdjb2Rlc3Bhbic6IHsNCiAgICAgICAgICBvdXQgKz0gcmVuZGVyZXIuY29kZXNwYW4odG9rZW4udGV4dCk7DQogICAgICAgICAgYnJlYWs7DQogICAgICAgIH0NCiAgICAgICAgY2FzZSAnYnInOiB7DQogICAgICAgICAgb3V0ICs9IHJlbmRlcmVyLmJyKCk7DQogICAgICAgICAgYnJlYWs7DQogICAgICAgIH0NCiAgICAgICAgY2FzZSAnZGVsJzogew0KICAgICAgICAgIG91dCArPSByZW5kZXJlci5kZWwodGhpcy5wYXJzZUlubGluZSh0b2tlbi50b2tlbnMsIHJlbmRlcmVyKSk7DQogICAgICAgICAgYnJlYWs7DQogICAgICAgIH0NCiAgICAgICAgY2FzZSAndGV4dCc6IHsNCiAgICAgICAgICBvdXQgKz0gcmVuZGVyZXIudGV4dCh0b2tlbi50ZXh0KTsNCiAgICAgICAgICBicmVhazsNCiAgICAgICAgfQ0KICAgICAgICBkZWZhdWx0OiB7DQogICAgICAgICAgY29uc3QgZXJyTXNnID0gJ1Rva2VuIHdpdGggIicgKyB0b2tlbi50eXBlICsgJyIgdHlwZSB3YXMgbm90IGZvdW5kLic7DQogICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5zaWxlbnQpIHsNCiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyTXNnKTsNCiAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGVyck1zZyk7DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICB9DQogICAgfQ0KICAgIHJldHVybiBvdXQ7DQogIH0NCn0NCg0KLyoqDQogKiBNYXJrZWQNCiAqLw0KZnVuY3Rpb24gbWFya2VkKHNyYywgb3B0LCBjYWxsYmFjaykgew0KICAvLyB0aHJvdyBlcnJvciBpbiBjYXNlIG9mIG5vbiBzdHJpbmcgaW5wdXQNCiAgaWYgKHR5cGVvZiBzcmMgPT09ICd1bmRlZmluZWQnIHx8IHNyYyA9PT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBFcnJvcignbWFya2VkKCk6IGlucHV0IHBhcmFtZXRlciBpcyB1bmRlZmluZWQgb3IgbnVsbCcpOw0KICB9DQogIGlmICh0eXBlb2Ygc3JjICE9PSAnc3RyaW5nJykgew0KICAgIHRocm93IG5ldyBFcnJvcignbWFya2VkKCk6IGlucHV0IHBhcmFtZXRlciBpcyBvZiB0eXBlICcNCiAgICAgICsgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHNyYykgKyAnLCBzdHJpbmcgZXhwZWN0ZWQnKTsNCiAgfQ0KDQogIGlmICh0eXBlb2Ygb3B0ID09PSAnZnVuY3Rpb24nKSB7DQogICAgY2FsbGJhY2sgPSBvcHQ7DQogICAgb3B0ID0gbnVsbDsNCiAgfQ0KDQogIG9wdCA9IG1lcmdlKHt9LCBtYXJrZWQuZGVmYXVsdHMsIG9wdCB8fCB7fSk7DQogIGNoZWNrU2FuaXRpemVEZXByZWNhdGlvbihvcHQpOw0KDQogIGlmIChjYWxsYmFjaykgew0KICAgIGNvbnN0IGhpZ2hsaWdodCA9IG9wdC5oaWdobGlnaHQ7DQogICAgbGV0IHRva2VuczsNCg0KICAgIHRyeSB7DQogICAgICB0b2tlbnMgPSBMZXhlci5sZXgoc3JjLCBvcHQpOw0KICAgIH0gY2F0Y2ggKGUpIHsNCiAgICAgIHJldHVybiBjYWxsYmFjayhlKTsNCiAgICB9DQoNCiAgICBjb25zdCBkb25lID0gZnVuY3Rpb24oZXJyKSB7DQogICAgICBsZXQgb3V0Ow0KDQogICAgICBpZiAoIWVycikgew0KICAgICAgICB0cnkgew0KICAgICAgICAgIGlmIChvcHQud2Fsa1Rva2Vucykgew0KICAgICAgICAgICAgbWFya2VkLndhbGtUb2tlbnModG9rZW5zLCBvcHQud2Fsa1Rva2Vucyk7DQogICAgICAgICAgfQ0KICAgICAgICAgIG91dCA9IFBhcnNlci5wYXJzZSh0b2tlbnMsIG9wdCk7DQogICAgICAgIH0gY2F0Y2ggKGUpIHsNCiAgICAgICAgICBlcnIgPSBlOw0KICAgICAgICB9DQogICAgICB9DQoNCiAgICAgIG9wdC5oaWdobGlnaHQgPSBoaWdobGlnaHQ7DQoNCiAgICAgIHJldHVybiBlcnINCiAgICAgICAgPyBjYWxsYmFjayhlcnIpDQogICAgICAgIDogY2FsbGJhY2sobnVsbCwgb3V0KTsNCiAgICB9Ow0KDQogICAgaWYgKCFoaWdobGlnaHQgfHwgaGlnaGxpZ2h0Lmxlbmd0aCA8IDMpIHsNCiAgICAgIHJldHVybiBkb25lKCk7DQogICAgfQ0KDQogICAgZGVsZXRlIG9wdC5oaWdobGlnaHQ7DQoNCiAgICBpZiAoIXRva2Vucy5sZW5ndGgpIHJldHVybiBkb25lKCk7DQoNCiAgICBsZXQgcGVuZGluZyA9IDA7DQogICAgbWFya2VkLndhbGtUb2tlbnModG9rZW5zLCBmdW5jdGlvbih0b2tlbikgew0KICAgICAgaWYgKHRva2VuLnR5cGUgPT09ICdjb2RlJykgew0KICAgICAgICBwZW5kaW5nKys7DQogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gew0KICAgICAgICAgIGhpZ2hsaWdodCh0b2tlbi50ZXh0LCB0b2tlbi5sYW5nLCBmdW5jdGlvbihlcnIsIGNvZGUpIHsNCiAgICAgICAgICAgIGlmIChlcnIpIHsNCiAgICAgICAgICAgICAgcmV0dXJuIGRvbmUoZXJyKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGlmIChjb2RlICE9IG51bGwgJiYgY29kZSAhPT0gdG9rZW4udGV4dCkgew0KICAgICAgICAgICAgICB0b2tlbi50ZXh0ID0gY29kZTsNCiAgICAgICAgICAgICAgdG9rZW4uZXNjYXBlZCA9IHRydWU7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIHBlbmRpbmctLTsNCiAgICAgICAgICAgIGlmIChwZW5kaW5nID09PSAwKSB7DQogICAgICAgICAgICAgIGRvbmUoKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICB9KTsNCiAgICAgICAgfSwgMCk7DQogICAgICB9DQogICAgfSk7DQoNCiAgICBpZiAocGVuZGluZyA9PT0gMCkgew0KICAgICAgZG9uZSgpOw0KICAgIH0NCg0KICAgIHJldHVybjsNCiAgfQ0KDQogIHRyeSB7DQogICAgY29uc3QgdG9rZW5zID0gTGV4ZXIubGV4KHNyYywgb3B0KTsNCiAgICBpZiAob3B0LndhbGtUb2tlbnMpIHsNCiAgICAgIG1hcmtlZC53YWxrVG9rZW5zKHRva2Vucywgb3B0LndhbGtUb2tlbnMpOw0KICAgIH0NCiAgICByZXR1cm4gUGFyc2VyLnBhcnNlKHRva2Vucywgb3B0KTsNCiAgfSBjYXRjaCAoZSkgew0KICAgIGUubWVzc2FnZSArPSAnXG5QbGVhc2UgcmVwb3J0IHRoaXMgdG8gaHR0cHM6Ly9naXRodWIuY29tL21hcmtlZGpzL21hcmtlZC4nOw0KICAgIGlmIChvcHQuc2lsZW50KSB7DQogICAgICByZXR1cm4gJzxwPkFuIGVycm9yIG9jY3VycmVkOjwvcD48cHJlPicNCiAgICAgICAgKyBlc2NhcGUoZS5tZXNzYWdlICsgJycsIHRydWUpDQogICAgICAgICsgJzwvcHJlPic7DQogICAgfQ0KICAgIHRocm93IGU7DQogIH0NCn0NCg0KLyoqDQogKiBPcHRpb25zDQogKi8NCg0KbWFya2VkLm9wdGlvbnMgPQ0KbWFya2VkLnNldE9wdGlvbnMgPSBmdW5jdGlvbihvcHQpIHsNCiAgbWVyZ2UobWFya2VkLmRlZmF1bHRzLCBvcHQpOw0KICBjaGFuZ2VEZWZhdWx0cyhtYXJrZWQuZGVmYXVsdHMpOw0KICByZXR1cm4gbWFya2VkOw0KfTsNCg0KbWFya2VkLmdldERlZmF1bHRzID0gZ2V0RGVmYXVsdHM7DQoNCm1hcmtlZC5kZWZhdWx0cyA9IGRlZmF1bHRzOw0KDQovKioNCiAqIFVzZSBFeHRlbnNpb24NCiAqLw0KDQptYXJrZWQudXNlID0gZnVuY3Rpb24oLi4uYXJncykgew0KICBjb25zdCBvcHRzID0gbWVyZ2Uoe30sIC4uLmFyZ3MpOw0KICBjb25zdCBleHRlbnNpb25zID0gbWFya2VkLmRlZmF1bHRzLmV4dGVuc2lvbnMgfHwgeyByZW5kZXJlcnM6IHt9LCBjaGlsZFRva2Vuczoge30gfTsNCiAgbGV0IGhhc0V4dGVuc2lvbnM7DQoNCiAgYXJncy5mb3JFYWNoKChwYWNrKSA9PiB7DQogICAgLy8gPT0tLSBQYXJzZSAiYWRkb24iIGV4dGVuc2lvbnMgLS09PSAvLw0KICAgIGlmIChwYWNrLmV4dGVuc2lvbnMpIHsNCiAgICAgIGhhc0V4dGVuc2lvbnMgPSB0cnVlOw0KICAgICAgcGFjay5leHRlbnNpb25zLmZvckVhY2goKGV4dCkgPT4gew0KICAgICAgICBpZiAoIWV4dC5uYW1lKSB7DQogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdleHRlbnNpb24gbmFtZSByZXF1aXJlZCcpOw0KICAgICAgICB9DQogICAgICAgIGlmIChleHQucmVuZGVyZXIpIHsgLy8gUmVuZGVyZXIgZXh0ZW5zaW9ucw0KICAgICAgICAgIGNvbnN0IHByZXZSZW5kZXJlciA9IGV4dGVuc2lvbnMucmVuZGVyZXJzID8gZXh0ZW5zaW9ucy5yZW5kZXJlcnNbZXh0Lm5hbWVdIDogbnVsbDsNCiAgICAgICAgICBpZiAocHJldlJlbmRlcmVyKSB7DQogICAgICAgICAgICAvLyBSZXBsYWNlIGV4dGVuc2lvbiB3aXRoIGZ1bmMgdG8gcnVuIG5ldyBleHRlbnNpb24gYnV0IGZhbGwgYmFjayBpZiBmYWxzZQ0KICAgICAgICAgICAgZXh0ZW5zaW9ucy5yZW5kZXJlcnNbZXh0Lm5hbWVdID0gZnVuY3Rpb24oLi4uYXJncykgew0KICAgICAgICAgICAgICBsZXQgcmV0ID0gZXh0LnJlbmRlcmVyLmFwcGx5KHRoaXMsIGFyZ3MpOw0KICAgICAgICAgICAgICBpZiAocmV0ID09PSBmYWxzZSkgew0KICAgICAgICAgICAgICAgIHJldCA9IHByZXZSZW5kZXJlci5hcHBseSh0aGlzLCBhcmdzKTsNCiAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICByZXR1cm4gcmV0Ow0KICAgICAgICAgICAgfTsNCiAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgZXh0ZW5zaW9ucy5yZW5kZXJlcnNbZXh0Lm5hbWVdID0gZXh0LnJlbmRlcmVyOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBpZiAoZXh0LnRva2VuaXplcikgeyAvLyBUb2tlbml6ZXIgRXh0ZW5zaW9ucw0KICAgICAgICAgIGlmICghZXh0LmxldmVsIHx8IChleHQubGV2ZWwgIT09ICdibG9jaycgJiYgZXh0LmxldmVsICE9PSAnaW5saW5lJykpIHsNCiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiZXh0ZW5zaW9uIGxldmVsIG11c3QgYmUgJ2Jsb2NrJyBvciAnaW5saW5lJyIpOw0KICAgICAgICAgIH0NCiAgICAgICAgICBpZiAoZXh0ZW5zaW9uc1tleHQubGV2ZWxdKSB7DQogICAgICAgICAgICBleHRlbnNpb25zW2V4dC5sZXZlbF0udW5zaGlmdChleHQudG9rZW5pemVyKTsNCiAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgZXh0ZW5zaW9uc1tleHQubGV2ZWxdID0gW2V4dC50b2tlbml6ZXJdOw0KICAgICAgICAgIH0NCiAgICAgICAgICBpZiAoZXh0LnN0YXJ0KSB7IC8vIEZ1bmN0aW9uIHRvIGNoZWNrIGZvciBzdGFydCBvZiB0b2tlbg0KICAgICAgICAgICAgaWYgKGV4dC5sZXZlbCA9PT0gJ2Jsb2NrJykgew0KICAgICAgICAgICAgICBpZiAoZXh0ZW5zaW9ucy5zdGFydEJsb2NrKSB7DQogICAgICAgICAgICAgICAgZXh0ZW5zaW9ucy5zdGFydEJsb2NrLnB1c2goZXh0LnN0YXJ0KTsNCiAgICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICBleHRlbnNpb25zLnN0YXJ0QmxvY2sgPSBbZXh0LnN0YXJ0XTsNCiAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfSBlbHNlIGlmIChleHQubGV2ZWwgPT09ICdpbmxpbmUnKSB7DQogICAgICAgICAgICAgIGlmIChleHRlbnNpb25zLnN0YXJ0SW5saW5lKSB7DQogICAgICAgICAgICAgICAgZXh0ZW5zaW9ucy5zdGFydElubGluZS5wdXNoKGV4dC5zdGFydCk7DQogICAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgZXh0ZW5zaW9ucy5zdGFydElubGluZSA9IFtleHQuc3RhcnRdOw0KICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIGlmIChleHQuY2hpbGRUb2tlbnMpIHsgLy8gQ2hpbGQgdG9rZW5zIHRvIGJlIHZpc2l0ZWQgYnkgd2Fsa1Rva2Vucw0KICAgICAgICAgIGV4dGVuc2lvbnMuY2hpbGRUb2tlbnNbZXh0Lm5hbWVdID0gZXh0LmNoaWxkVG9rZW5zOw0KICAgICAgICB9DQogICAgICB9KTsNCiAgICB9DQoNCiAgICAvLyA9PS0tIFBhcnNlICJvdmVyd3JpdGUiIGV4dGVuc2lvbnMgLS09PSAvLw0KICAgIGlmIChwYWNrLnJlbmRlcmVyKSB7DQogICAgICBjb25zdCByZW5kZXJlciA9IG1hcmtlZC5kZWZhdWx0cy5yZW5kZXJlciB8fCBuZXcgUmVuZGVyZXIoKTsNCiAgICAgIGZvciAoY29uc3QgcHJvcCBpbiBwYWNrLnJlbmRlcmVyKSB7DQogICAgICAgIGNvbnN0IHByZXZSZW5kZXJlciA9IHJlbmRlcmVyW3Byb3BdOw0KICAgICAgICAvLyBSZXBsYWNlIHJlbmRlcmVyIHdpdGggZnVuYyB0byBydW4gZXh0ZW5zaW9uLCBidXQgZmFsbCBiYWNrIGlmIGZhbHNlDQogICAgICAgIHJlbmRlcmVyW3Byb3BdID0gKC4uLmFyZ3MpID0+IHsNCiAgICAgICAgICBsZXQgcmV0ID0gcGFjay5yZW5kZXJlcltwcm9wXS5hcHBseShyZW5kZXJlciwgYXJncyk7DQogICAgICAgICAgaWYgKHJldCA9PT0gZmFsc2UpIHsNCiAgICAgICAgICAgIHJldCA9IHByZXZSZW5kZXJlci5hcHBseShyZW5kZXJlciwgYXJncyk7DQogICAgICAgICAgfQ0KICAgICAgICAgIHJldHVybiByZXQ7DQogICAgICAgIH07DQogICAgICB9DQogICAgICBvcHRzLnJlbmRlcmVyID0gcmVuZGVyZXI7DQogICAgfQ0KICAgIGlmIChwYWNrLnRva2VuaXplcikgew0KICAgICAgY29uc3QgdG9rZW5pemVyID0gbWFya2VkLmRlZmF1bHRzLnRva2VuaXplciB8fCBuZXcgVG9rZW5pemVyKCk7DQogICAgICBmb3IgKGNvbnN0IHByb3AgaW4gcGFjay50b2tlbml6ZXIpIHsNCiAgICAgICAgY29uc3QgcHJldlRva2VuaXplciA9IHRva2VuaXplcltwcm9wXTsNCiAgICAgICAgLy8gUmVwbGFjZSB0b2tlbml6ZXIgd2l0aCBmdW5jIHRvIHJ1biBleHRlbnNpb24sIGJ1dCBmYWxsIGJhY2sgaWYgZmFsc2UNCiAgICAgICAgdG9rZW5pemVyW3Byb3BdID0gKC4uLmFyZ3MpID0+IHsNCiAgICAgICAgICBsZXQgcmV0ID0gcGFjay50b2tlbml6ZXJbcHJvcF0uYXBwbHkodG9rZW5pemVyLCBhcmdzKTsNCiAgICAgICAgICBpZiAocmV0ID09PSBmYWxzZSkgew0KICAgICAgICAgICAgcmV0ID0gcHJldlRva2VuaXplci5hcHBseSh0b2tlbml6ZXIsIGFyZ3MpOw0KICAgICAgICAgIH0NCiAgICAgICAgICByZXR1cm4gcmV0Ow0KICAgICAgICB9Ow0KICAgICAgfQ0KICAgICAgb3B0cy50b2tlbml6ZXIgPSB0b2tlbml6ZXI7DQogICAgfQ0KDQogICAgLy8gPT0tLSBQYXJzZSBXYWxrVG9rZW5zIGV4dGVuc2lvbnMgLS09PSAvLw0KICAgIGlmIChwYWNrLndhbGtUb2tlbnMpIHsNCiAgICAgIGNvbnN0IHdhbGtUb2tlbnMgPSBtYXJrZWQuZGVmYXVsdHMud2Fsa1Rva2VuczsNCiAgICAgIG9wdHMud2Fsa1Rva2VucyA9IGZ1bmN0aW9uKHRva2VuKSB7DQogICAgICAgIHBhY2sud2Fsa1Rva2Vucy5jYWxsKHRoaXMsIHRva2VuKTsNCiAgICAgICAgaWYgKHdhbGtUb2tlbnMpIHsNCiAgICAgICAgICB3YWxrVG9rZW5zLmNhbGwodGhpcywgdG9rZW4pOw0KICAgICAgICB9DQogICAgICB9Ow0KICAgIH0NCg0KICAgIGlmIChoYXNFeHRlbnNpb25zKSB7DQogICAgICBvcHRzLmV4dGVuc2lvbnMgPSBleHRlbnNpb25zOw0KICAgIH0NCg0KICAgIG1hcmtlZC5zZXRPcHRpb25zKG9wdHMpOw0KICB9KTsNCn07DQoNCi8qKg0KICogUnVuIGNhbGxiYWNrIGZvciBldmVyeSB0b2tlbg0KICovDQoNCm1hcmtlZC53YWxrVG9rZW5zID0gZnVuY3Rpb24odG9rZW5zLCBjYWxsYmFjaykgew0KICBmb3IgKGNvbnN0IHRva2VuIG9mIHRva2Vucykgew0KICAgIGNhbGxiYWNrLmNhbGwobWFya2VkLCB0b2tlbik7DQogICAgc3dpdGNoICh0b2tlbi50eXBlKSB7DQogICAgICBjYXNlICd0YWJsZSc6IHsNCiAgICAgICAgZm9yIChjb25zdCBjZWxsIG9mIHRva2VuLmhlYWRlcikgew0KICAgICAgICAgIG1hcmtlZC53YWxrVG9rZW5zKGNlbGwudG9rZW5zLCBjYWxsYmFjayk7DQogICAgICAgIH0NCiAgICAgICAgZm9yIChjb25zdCByb3cgb2YgdG9rZW4ucm93cykgew0KICAgICAgICAgIGZvciAoY29uc3QgY2VsbCBvZiByb3cpIHsNCiAgICAgICAgICAgIG1hcmtlZC53YWxrVG9rZW5zKGNlbGwudG9rZW5zLCBjYWxsYmFjayk7DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIGJyZWFrOw0KICAgICAgfQ0KICAgICAgY2FzZSAnbGlzdCc6IHsNCiAgICAgICAgbWFya2VkLndhbGtUb2tlbnModG9rZW4uaXRlbXMsIGNhbGxiYWNrKTsNCiAgICAgICAgYnJlYWs7DQogICAgICB9DQogICAgICBkZWZhdWx0OiB7DQogICAgICAgIGlmIChtYXJrZWQuZGVmYXVsdHMuZXh0ZW5zaW9ucyAmJiBtYXJrZWQuZGVmYXVsdHMuZXh0ZW5zaW9ucy5jaGlsZFRva2VucyAmJiBtYXJrZWQuZGVmYXVsdHMuZXh0ZW5zaW9ucy5jaGlsZFRva2Vuc1t0b2tlbi50eXBlXSkgeyAvLyBXYWxrIGFueSBleHRlbnNpb25zDQogICAgICAgICAgbWFya2VkLmRlZmF1bHRzLmV4dGVuc2lvbnMuY2hpbGRUb2tlbnNbdG9rZW4udHlwZV0uZm9yRWFjaChmdW5jdGlvbihjaGlsZFRva2Vucykgew0KICAgICAgICAgICAgbWFya2VkLndhbGtUb2tlbnModG9rZW5bY2hpbGRUb2tlbnNdLCBjYWxsYmFjayk7DQogICAgICAgICAgfSk7DQogICAgICAgIH0gZWxzZSBpZiAodG9rZW4udG9rZW5zKSB7DQogICAgICAgICAgbWFya2VkLndhbGtUb2tlbnModG9rZW4udG9rZW5zLCBjYWxsYmFjayk7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICB9DQogIH0NCn07DQoNCi8qKg0KICogUGFyc2UgSW5saW5lDQogKi8NCm1hcmtlZC5wYXJzZUlubGluZSA9IGZ1bmN0aW9uKHNyYywgb3B0KSB7DQogIC8vIHRocm93IGVycm9yIGluIGNhc2Ugb2Ygbm9uIHN0cmluZyBpbnB1dA0KICBpZiAodHlwZW9mIHNyYyA9PT0gJ3VuZGVmaW5lZCcgfHwgc3JjID09PSBudWxsKSB7DQogICAgdGhyb3cgbmV3IEVycm9yKCdtYXJrZWQucGFyc2VJbmxpbmUoKTogaW5wdXQgcGFyYW1ldGVyIGlzIHVuZGVmaW5lZCBvciBudWxsJyk7DQogIH0NCiAgaWYgKHR5cGVvZiBzcmMgIT09ICdzdHJpbmcnKSB7DQogICAgdGhyb3cgbmV3IEVycm9yKCdtYXJrZWQucGFyc2VJbmxpbmUoKTogaW5wdXQgcGFyYW1ldGVyIGlzIG9mIHR5cGUgJw0KICAgICAgKyBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoc3JjKSArICcsIHN0cmluZyBleHBlY3RlZCcpOw0KICB9DQoNCiAgb3B0ID0gbWVyZ2Uoe30sIG1hcmtlZC5kZWZhdWx0cywgb3B0IHx8IHt9KTsNCiAgY2hlY2tTYW5pdGl6ZURlcHJlY2F0aW9uKG9wdCk7DQoNCiAgdHJ5IHsNCiAgICBjb25zdCB0b2tlbnMgPSBMZXhlci5sZXhJbmxpbmUoc3JjLCBvcHQpOw0KICAgIGlmIChvcHQud2Fsa1Rva2Vucykgew0KICAgICAgbWFya2VkLndhbGtUb2tlbnModG9rZW5zLCBvcHQud2Fsa1Rva2Vucyk7DQogICAgfQ0KICAgIHJldHVybiBQYXJzZXIucGFyc2VJbmxpbmUodG9rZW5zLCBvcHQpOw0KICB9IGNhdGNoIChlKSB7DQogICAgZS5tZXNzYWdlICs9ICdcblBsZWFzZSByZXBvcnQgdGhpcyB0byBodHRwczovL2dpdGh1Yi5jb20vbWFya2VkanMvbWFya2VkLic7DQogICAgaWYgKG9wdC5zaWxlbnQpIHsNCiAgICAgIHJldHVybiAnPHA+QW4gZXJyb3Igb2NjdXJyZWQ6PC9wPjxwcmU+Jw0KICAgICAgICArIGVzY2FwZShlLm1lc3NhZ2UgKyAnJywgdHJ1ZSkNCiAgICAgICAgKyAnPC9wcmU+JzsNCiAgICB9DQogICAgdGhyb3cgZTsNCiAgfQ0KfTsNCg0KLyoqDQogKiBFeHBvc2UNCiAqLw0KbWFya2VkLlBhcnNlciA9IFBhcnNlcjsNCm1hcmtlZC5wYXJzZXIgPSBQYXJzZXIucGFyc2U7DQptYXJrZWQuUmVuZGVyZXIgPSBSZW5kZXJlcjsNCm1hcmtlZC5UZXh0UmVuZGVyZXIgPSBUZXh0UmVuZGVyZXI7DQptYXJrZWQuTGV4ZXIgPSBMZXhlcjsNCm1hcmtlZC5sZXhlciA9IExleGVyLmxleDsNCm1hcmtlZC5Ub2tlbml6ZXIgPSBUb2tlbml6ZXI7DQptYXJrZWQuU2x1Z2dlciA9IFNsdWdnZXI7DQptYXJrZWQucGFyc2UgPSBtYXJrZWQ7DQoNCmNvbnN0IG9wdGlvbnMgPSBtYXJrZWQub3B0aW9uczsNCmNvbnN0IHNldE9wdGlvbnMgPSBtYXJrZWQuc2V0T3B0aW9uczsNCmNvbnN0IHVzZSA9IG1hcmtlZC51c2U7DQpjb25zdCB3YWxrVG9rZW5zID0gbWFya2VkLndhbGtUb2tlbnM7DQpjb25zdCBwYXJzZUlubGluZSA9IG1hcmtlZC5wYXJzZUlubGluZTsNCmNvbnN0IHBhcnNlID0gbWFya2VkOw0KY29uc3QgcGFyc2VyID0gUGFyc2VyLnBhcnNlOw0KY29uc3QgbGV4ZXIgPSBMZXhlci5sZXg7DQoNCmV4cG9ydCB7IExleGVyLCBQYXJzZXIsIFJlbmRlcmVyLCBTbHVnZ2VyLCBUZXh0UmVuZGVyZXIsIFRva2VuaXplciwgZGVmYXVsdHMsIGdldERlZmF1bHRzLCBsZXhlciwgbWFya2VkLCBvcHRpb25zLCBwYXJzZSwgcGFyc2VJbmxpbmUsIHBhcnNlciwgc2V0T3B0aW9ucywgdXNlLCB3YWxrVG9rZW5zIH07";

    

    let markdown;
    try {
        markdown = await import(/* webpackIgnore: true */ marked);
    } catch (error) {
        console.error('Error when trying to load markdown library:', error);
    }

    class Aness6040MD2HTMLv2 {
        constructor() {
            this.markedOptions = {
                gfm: true,
                breaks: true,
                async: true,
                pedantic: false,
            };
        }
        getInfo() {
            return {
                id: 'aness6040md2htmlv2',
                name: 'Markdown to HTML v2',
                blockIconURI: icon,
                menuIconURI: menuIcon,
                color1: '#dbdbdb',
                color2: '#b5b5b5',
                color3: '#949494',
                blocks: [
                    {
                        opcode: 'convert',
                        blockType: Scratch.BlockType.REPORTER,
                        text: 'convert markdown [MD] to html',
                        arguments: {
                            MD: {
                                type: Scratch.ArgumentType.STRING,
                                defaultValue: '# [Hello World!](https://example.com)~Markdown~',
                            },
                        }
                    },
                    '---',
                    {
                        opcode: 'enableOptions',
                        blockType: Scratch.BlockType.COMMAND,
                        text: 'enable [OPTION] for markdown',
                        arguments: {
                            OPTION: {
                                type: Scratch.ArgumentType.STRING,
                                menu: 'options',
                            },
                        }
                    },
                    {
                        opcode: 'disableOptions',
                        blockType: Scratch.BlockType.COMMAND,
                        text: 'disable [OPTION] for markdown',
                        arguments: {
                            OPTION: {
                                type: Scratch.ArgumentType.STRING,
                                menu: 'options',
                            },
                        }
                    },
                    {
                        opcode: 'isOptionsEnabled',
                        blockType: Scratch.BlockType.BOOLEAN,
                        text: 'is [OPTION] enabled?',
                        arguments: {
                            OPTION: {
                                type: Scratch.ArgumentType.STRING,
                                menu: 'options',
                            },
                        }
                    },
                ],
                menus: {
                    options: {
                        items: [
                            {
                                text: 'GFM',
                                value: 'gfm'
                            },
                            {
                                text: 'Breaks',
                                value: 'breaks'
                            },
                            {
                                text: 'Async',
                                value: 'async'
                            },
                            {
                                text: 'Pedantic',
                                value: 'pedantic'
                            }
                        ]
                    }
                },
            };
        }

        convert(args) {
            if (markdown && markdown.marked) {
                return markdown.marked.parse(args.MD, this.markedOptions);
            } else {
                console.error('Error: Markdown library not loaded');
            }
        }

        enableOptions(args) {
            this.markedOptions[args.OPTION] = true;
        }
        disableOptions(args) {
            this.markedOptions[args.OPTION] = false;
        }
        isOptionsEnabled(args) {
            return Scratch.Cast.toBoolean(this.markedOptions[args.OPTION]);
        }
    }

    Scratch.extensions.register(new Aness6040MD2HTMLv2());
})(Scratch);
